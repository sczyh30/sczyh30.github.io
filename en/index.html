<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> sczyh30's Metaspace</title><meta name="description" content="sczyh30's blog"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="http://www.sczyh30.com/en/favicon.png"><link rel="stylesheet" href="/en/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/en/" class="logo-link"><img src="http://www.sczyh30.com/en/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="http://www.sczyh30.com/en" target="_blank" class="nav-list-link">BLOG(EN)</a></li><li class="nav-list-item"><a href="http://www.sczyh30.com" target="_blank" class="nav-list-link">BLOG(中文)</a></li><li class="nav-list-item"><a href="http://www.sczyh30.com/en/archives/" target="_blank" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://www.sczyh30.com/en/about/" target="_blank" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="http://www.sczyh30.com/en/atom.xml" target="_blank" class="nav-list-link">RSS</a></li></ul></header><section class="container"><ul class="home post-list"><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/08/01/vertx-blueprint-microservice-basic-design/" class="post-title-link">Vert.x Microservice Blueprint | Basic Design</a></h2><div class="post-time">Aug 1, 2016</div><div class="post-content"><p>The blueprint is an online shopping microservice application. You can treat it as a very simple C2C market like eBay.</p>
<p>Here is a diagram illustrating the microservice architecture:</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/vertx-msb-initial-structure.png" alt="Basic Design"></p>
<p>Currently I designed these components:</p>
<ul>
<li><code>account-microservice</code>: Component for user account</li>
<li><code>product-microservice</code>: Component for products we sell and buy</li>
<li><code>store-microservice</code>: Component for individual stores in the market</li>
<li><code>checkout-microservice</code>: Compoment for order checkout</li>
<li><code>payment-microservice</code>: Compoment for payment transaction processing</li>
<li><code>order-microservice</code>: Compoment for order dispatching, processing, analyzing and storage<ul>
<li><strong>NOTE</strong>: this component should be divided into several sub-components</li>
</ul>
</li>
<li><code>recommendation-microservice</code>: Compoment for simple recommendation for friends and favorite products with Neo4j</li>
<li><code>cache-infrastructure</code>: Cache component for services</li>
<li><code>api-gateway</code>: API gateway (with load balance)</li>
<li><code>shopping-ui</code>: A SPA front-end for the microservice</li>
<li><code>monitor-dashboard</code>: Dashboard for performance monitoring and backend metrics data demonstration</li>
</ul>
<p>Here is the user workflow: <code>User login and add products to chart -&gt; Checkout -&gt; Go to payment page and pay for the products -&gt; Payment transaction success, order submitted -&gt; (Wait for delivery...)</code></p>
<p>All events are sent on the event bus.</p></div><a href="/en/2016/08/01/vertx-blueprint-microservice-basic-design/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/08/01/gsoc-work-period-week-11/" class="post-title-link">GSoC 2016 | Work Period | Week 11</a></h2><div class="post-time">Aug 1, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Architecture enhancement</li>
<li>A simple SPA frontend for the microservice blueprint (use Vue.js)</li>
<li>Monitor dashboard</li>
<li>A simple recommendation component<ul>
<li>Maybe I should write a individual component providing Neo4j integration with Vert.x</li>
</ul>
</li>
<li>Run the application with Docker Compose</li>
<li>Finish tests</li>
<li>Finish documents and tutorials</li>
<li>Prepare for next blueprint application (high performance)</li>
</ul>
<p><em>Good luck~ :-)</em></p></div><a href="/en/2016/08/01/gsoc-work-period-week-11/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/08/01/gsoc-2016-work-period-week9-10/" class="post-title-link">GSoC 2016 | Work Period | Week 9 - Week 10</a></h2><div class="post-time">Aug 1, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Initial work for Online Shopping Microservice Blueprint</li>
<li>Prepare for next blueprint application (high performance)</li>
</ul>
<p><em>Good luck~ :-)</em></p>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="API-gateway"><a href="#API-gateway" class="headerlink" title="API gateway"></a>API gateway</h2><p>How to implement an API gateway with load balance.</p>
<h2 id="Checkout-model"><a href="#Checkout-model" class="headerlink" title="Checkout model"></a>Checkout model</h2><p>TODO: The checkout-payment-order model should be changed.</p>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>In our design, the online shopping microservice blueprint contains many components, so we need to pay attention to how to deploy such a microservice application (e.g. use Docker Compose, Kubernetes; Deploy on Openshift)</p>
<h2 id="Order-dispatching-design"><a href="#Order-dispatching-design" class="headerlink" title="Order dispatching design"></a>Order dispatching design</h2><p>In our current design, orders are sent via clustered event bus. But a real production environment, orders are supposed to be dispatched to message queues with recovery and persistence ability(e.g. Kafka). And the order processing component and order persistence component should pull orders from the MQ.</p>
<h2 id="Integration-with-other-technologies"><a href="#Integration-with-other-technologies" class="headerlink" title="Integration with other technologies"></a>Integration with other technologies</h2><p>e.g. Kafka</p>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><ul>
<li>Initial work for Online Shopping Microservice Blueprint</li>
</ul></div><a href="/en/2016/08/01/gsoc-2016-work-period-week9-10/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/07/16/gsoc-2016-work-period-week-7/" class="post-title-link">GSoC 2016 | Work Period | Week 7 - Week 8</a></h2><div class="post-time">Jul 16, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Finish Chinese documentation of Vert.x Kue</li>
<li>Work on microservice blueprint</li>
<li>Learn more about <strong>Vert.x Microservice</strong></li>
</ul>
<p><strong>Notice:</strong> Because my semester final exams is pending this week and next week, I’ll have to be busy with them. So I might spend less time on it (have time in the evening). After the final exams I’ll speed up and make a wonderful blueprint!</p>
<p><em>Good luck~ :-)</em></p>
<p>The final exams finally finished!!!</p></div><a href="/en/2016/07/16/gsoc-2016-work-period-week-7/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/07/03/gsoc-2016-work-period-week5-6/" class="post-title-link">GSoC 2016 | Work Period | Week 5 - Week 6</a></h2><div class="post-time">Jul 3, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Some extra things to implement or fix:<ul>
<li>Job active TTL check</li>
<li>Job search functionality</li>
<li>Render issue with <code>_filter.jade</code></li>
</ul>
</li>
<li>Finish documents and tutorials of <strong>Vert.x Kue</strong></li>
<li>Finish tests</li>
<li>Add Docker Compose file</li>
<li>Prepare for the microservice blueprint</li>
</ul>
<p><em>Good luck~ :-)</em></p>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="TODO-Job-search-functionality"><a href="#TODO-Job-search-functionality" class="headerlink" title="TODO: Job search functionality"></a>TODO: Job search functionality</h2><p>This need a full-index engine.</p>
<h2 id="TODO-Run-Vert-x-Kue-in-Docker-Cluster"><a href="#TODO-Run-Vert-x-Kue-in-Docker-Cluster" class="headerlink" title="TODO: Run Vert.x Kue in Docker Cluster"></a>TODO: Run Vert.x Kue in Docker Cluster</h2><p>Maybe we need some configurations for Hazelcast to support it on Docker.</p>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><ul>
<li>Finish English documents and tutorials of <strong>Vert.x Kue</strong></li>
<li>Finish part of Chinese documents and tutorials of <strong>Vert.x Kue</strong></li>
<li>Initial design for bluepint microservice</li>
</ul>
<p>These days my progress is slow…Because I have to prepare for the final exam(7.1 - 7.15) these days…</p></div><a href="/en/2016/07/03/gsoc-2016-work-period-week5-6/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/06/20/vertx-kue-brief-introduction-how-it-works/" class="post-title-link">Vert.x Kue | A brief introduction to how it works</a></h2><div class="post-time">Jun 20, 2016</div><div class="post-content"><p>In this blog post, I’ll give a brief introduction to illustrate how Vert.x Kue works.</p>
<p>In the workflow, first we deploy the <code>KueVerticle</code> in clustered mode and register the <code>JobService</code> on the event bus. The <code>JobService</code> consists of various logic of <code>Job</code>. After that, we could then deploy <code>KueHttpVerticle</code> to provide REST API. Most of the apis calls <code>Future</code>-based methods in <code>Kue</code>. Finally we could deploy our job processing verticle. The verticle usually consists of three parts:</p>
<ul>
<li>create <code>Kue</code> instance</li>
</ul>
<p>When we create <code>Kue</code> instance, the inner <code>JobService</code> proxy and redis client will be created. Also, the static <code>Vertx</code> field in <code>Job</code> class will also be initilized.</p>
<ul>
<li>create and save <code>Job</code></li>
</ul>
<p>Here we could set job properties and subscribe events from the job address(via event bus).</p>
<ul>
<li>process the <code>Job</code></li>
</ul>
<p>When we call the <code>process</code> or <code>processBlocking</code> method, Vert.x Kue will create and then deploy some <strong>KueWorkers</strong>, which is a kind of verticle(or worker verticle, if calling <code>processBlocking</code>).</p>
<p>In <code>KueWorker</code>, we first get <code>Job</code> from Redis backend (<code>zpop</code> operation):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAndStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.getJobFromBackend().setHandler(jr -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (jr.succeeded()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (jr.result().isPresent()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.job = jr.result().get();</span><br><span class="line">        process();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"job not exist"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      jr.cause().printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the <code>KueWorker</code> successfully gets the job, it will do process procedure. First we set <code>started_at</code> flag on the job and then save it to the backend. Then we emit the job <strong>start</strong> event on the event bus(both job address and worker address). Next, we will process the job using the given handler. Simultaneously, we consume <code>done</code> and <code>done_fail</code> events on the job-specific address. If <code>done</code> event received, the job should be completed and we emit <code>complete</code> event. If <code>done_fail</code> event received, the job should be failed so we first do a failed attempt. If attempt failed, then send <code>error</code> event on worker address. Else send <code>failed</code> or <code>failed_attempt</code> event depending on the attempt status.</p>
<p>There are three kinds of address:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   * Handler address with certain job on event bus</span><br><span class="line">   * Format: vertx.kue.handler.job.&#123;handlerType&#125;.&#123;addressId&#125;.&#123;jobType&#125;</span><br><span class="line">   *</span><br><span class="line">   * <span class="doctag">@return</span> corresponding address</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCertainJobAddress</span><span class="params">(String handlerType, Job job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"vertx.kue.handler.job."</span> + handlerType + <span class="string">"."</span> + job.getAddress_id() + <span class="string">"."</span> + job.getType();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Global worker address with specific event type</span><br><span class="line"> */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">workerAddress</span><span class="params">(String eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"vertx.kue.handler.workers."</span> + eventType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Worker address with specific event type and job-uuid on event bus</span><br><span class="line">   * Format: vertx.kue.handler.workers.&#123;eventType&#125;</span><br><span class="line">   *</span><br><span class="line">   * <span class="doctag">@return</span> corresponding address</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">workerAddress</span><span class="params">(String eventType, Job job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"vertx.kue.handler.workers."</span> + eventType + <span class="string">"."</span> + job.getAddress_id();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Diagram"><a href="#Diagram" class="headerlink" title="Diagram"></a>Diagram</h2><p><img src="https://github.com/sczyh30/vertx-blueprint-job-queue/raw/initial-work/docs/images/kue_diagram.png" alt=""></p></div><a href="/en/2016/06/20/vertx-kue-brief-introduction-how-it-works/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/06/20/gsoc-2016-work-period-week4/" class="post-title-link">GSoC 2016 | Work Period | Week 4</a></h2><div class="post-time">Jun 20, 2016</div><div class="post-content"><p>The GSoC Midterm Evaluation is coming~ Boost~O(∩_∩)O</p>
<h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Enhance <strong>Event system</strong> and <code>KueWorker</code> in Kue<ul>
<li>Implement all basic events in original Kue</li>
<li>If possible, do some performance optimization</li>
</ul>
</li>
<li>Add test cases and fix bugs</li>
<li>Add more examples</li>
<li>Finish all Vert.x Kue REST apis</li>
<li>Adapt Vert.x Kue REST API with original Kue’s UI</li>
<li>Code refinement</li>
<li>Initial document and design diagram update</li>
<li>Learn more about new features in Vert.x 3.3.0</li>
</ul>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><ul>
<li><code>initial-work</code> implementation of <strong>Vert.x Kue</strong> (including Vert.x Kue REST API and UI)<ul>
<li>See: <a href="https://github.com/sczyh30/vertx-blueprint-job-queue/tree/initial-work">sczyh30/vertx-blueprint-job-queue</a></li>
</ul>
</li>
<li>Bugs fixed</li>
<li>Add more examples</li>
<li>Some refactor and code refinement</li>
<li>Feature document draft</li>
</ul></div><a href="/en/2016/06/20/gsoc-2016-work-period-week4/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/06/12/gsoc-2016-work-period-week3/" class="post-title-link">GSoC 2016 | Work Period | Week 3</a></h2><div class="post-time">Jun 12, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Core component of Vert.x Kue implementation complete<ul>
<li><strong>Event system</strong> in Kue</li>
<li><code>KueWorker</code></li>
<li><code>Job</code></li>
</ul>
</li>
<li>Basic implementation of Vert.x Kue HTTP component<ul>
<li>REST API implementation</li>
<li>A simple UI (Vert.x Kue UI)</li>
</ul>
</li>
<li>Refine the code of Vert.x Kue<ul>
<li>The <code>Job</code> class is messy and need refinement</li>
<li>More concise</li>
</ul>
</li>
<li>Learn more about microservice (as well as Vert.x Microservice Toolbox)</li>
<li>Write a brief introduction to new features of Vert.x 3.3.0 (in Chinese, will publish in <em>Vert.x China Group</em>)</li>
</ul>
<p>PS: <strong>The Dragon Boat Festival</strong> holiday will be coming from Thursday to Saturday this week so I may not spend very much time on work during the holiday~ <em>Have a great week :-)</em></p>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="Solved-Regex-match-in-route-path"><a href="#Solved-Regex-match-in-route-path" class="headerlink" title="Solved: Regex match in route path"></a>Solved: Regex match in route path</h2><p>In original Kue’s API, there is a route with path <code>/jobs/:from..:to/:order?</code>. I tried this in Vert.x Web(<code>/jobs/:from..:to</code>) but Vert.x Web cannot match it. So I used regex match <code>\/jobs\/([0-9]*)\.\.([0-9]*)(\/[^\/]+)?</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KUE_API_JOB_RANGE = <span class="string">"\\/jobs\\/([0-9]*)\\.\\.([0-9]*)(\\/[^\\/]+)?"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">router.getWithRegex(KUE_API_JOB_RANGE).handler(<span class="keyword">this</span>::apiJobRange);</span><br></pre></td></tr></table></figure>
<p>But nothing matched, which made me confused. And path like <code>/jobs/:from/to/:to</code> can be matched.</p>
<p>Solution: First use a supported pattern to catch string like <code>1..10</code> then use regex parse.</p>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><h2 id="Implementation-of-Vert-x-Kue-core"><a href="#Implementation-of-Vert-x-Kue-core" class="headerlink" title="Implementation of Vert.x Kue core"></a>Implementation of Vert.x Kue core</h2><ul>
<li>Job processing interface <code>KueService</code> now provides two methods: <code>process</code> method do asynchronous procedure(use common verticles), while <code>processBlocking</code> method could do blocking procedure(use worker verticles)</li>
<li>Add attempt support (could attempt when fails)<ul>
<li><em>TODO: need enhancement and test</em></li>
</ul>
</li>
<li>Add worker and job cardinality metrics support</li>
<li>Add support for getting jobs with range(rank)</li>
<li>Basic refinement of <code>Job</code> class</li>
<li>Refactored most of async methods to <code>Future</code> based style (in order to support monadic transform and say goodbye to callback hell)</li>
<li>Fix issue: Sometimes throw <code>java.lang.ClassCastException</code> caused by wrong time flow when processing a job</li>
<li>Fix issue: Generated json converter <em>sometimes</em> could not distinguish some properties(e.g. <code>id</code> and <code>jobMetrics</code>) correctly</li>
</ul>
<p>See here:  <a href="https://github.com/sczyh30/vertx-blueprint-job-queue/tree/initial-work">sczyh30/vertx-blueprint-job-queue</a></p>
<h2 id="Basic-implementation-of-Vert-x-Kue-HTTP-component"><a href="#Basic-implementation-of-Vert-x-Kue-HTTP-component" class="headerlink" title="Basic implementation of Vert.x Kue HTTP component"></a>Basic implementation of Vert.x Kue HTTP component</h2><ul>
<li>Basic implementation of Vert.x Kue REST API(get job, create job, delete job, get job by range(or state), etc)</li>
<li>Basic adaption between Vert.x Web and original Kue UI (rendered with <code>vertx-web-templ-jade</code>; still have some problems to solve)</li>
</ul>
<h2 id="Wrote-a-brief-introduction-to-new-features-of-Vert-x-3-3-0-in-Chinese"><a href="#Wrote-a-brief-introduction-to-new-features-of-Vert-x-3-3-0-in-Chinese" class="headerlink" title="Wrote a brief introduction to new features of Vert.x 3.3.0 in Chinese"></a>Wrote a brief introduction to new features of Vert.x 3.3.0 in Chinese</h2></div><a href="/en/2016/06/12/gsoc-2016-work-period-week3/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/06/06/gsoc-2016-work-period-week2/" class="post-title-link">GSoC 2016 | Work Period | Week 2</a></h2><div class="post-time">Jun 6, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Work on the <strong>Vert.x Blueprint - Kue</strong> (Initial implementation)</li>
<li>Learn more about event-driven and message system</li>
</ul>
<h1 id="Knowledge-got"><a href="#Knowledge-got" class="headerlink" title="Knowledge got"></a>Knowledge got</h1><p>This week I’ve learned a lot!</p>
<ul>
<li>Clustered Verticles and how to interact with each other</li>
<li>Vert.x Event Bus (<em>send/recv</em> and <em>pub/sub</em>)</li>
<li>Vert.x Service Proxy</li>
<li>More understanding about Redis(sorted set, list, pub/sub, transaction, etc)</li>
<li>More understanding about asynchronous and reactive pattern(<code>Handler</code> / <code>Future</code>)</li>
</ul>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="How-to-implement-priority"><a href="#How-to-implement-priority" class="headerlink" title="How to implement priority?"></a>How to implement priority?</h2><p>I imitate Kue in Node.js: use <strong>sorted sets</strong> in Redis and mark the priority as the score(weight). Use <code>zadd</code> to add a certain id of job and when necessary, use <code>zpop</code>(implemented with transaction) to get a job with higher priority.</p>
<h2 id="How-to-emit-and-receive-events"><a href="#How-to-emit-and-receive-events" class="headerlink" title="How to emit and receive events?"></a>How to emit and receive events?</h2><p>In Node.js, we could use <code>EventEmitter</code> to emit and listen to events. And in Vert.x, we could make full use of <code>EventBus</code>, which supports three kinds of pattern. For example, in Node.js we may write this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.on(<span class="string">'complete'</span>, fn);</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">self.emit(<span class="string">'complete'</span>, res);</span><br></pre></td></tr></table></figure>
<p>And in Vert.x we could write:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// listen to an address</span></span><br><span class="line">eventBus.consumer(Kue.getHandlerAddress(<span class="string">"complete"</span>, <span class="keyword">this</span>.type), message -&gt; &#123;</span><br><span class="line">      completeHandler.handle(<span class="keyword">new</span> Job((JsonObject) message.body()));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// send message to an address</span></span><br><span class="line">eventBus.send(Kue.getHandlerAddress(<span class="string">"complete"</span>, type), job.toJson());</span><br></pre></td></tr></table></figure>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><h2 id="Refined-the-design-of-Vert-x-Kue"><a href="#Refined-the-design-of-Vert-x-Kue" class="headerlink" title="Refined the design of Vert.x Kue"></a>Refined the design of Vert.x Kue</h2><ul>
<li><code>Kue</code>: like the <code>Queue</code> in Kue. We could <code>createJob</code> and <code>process</code> the job</li>
<li><code>KueVerticle</code>: a verticle where the <code>KueService</code> is registered</li>
<li><code>KueWorker</code>: a worker verticle that processes the job</li>
<li><code>KueService</code>: create <code>KueWorker</code> and deploy it</li>
<li><code>Job</code>: the job entity, contains numerous logic about job</li>
</ul>
<p>The backend of Vert.x Kue is <strong>Redis</strong>.</p>
<p>Basic usage (design) of Vert.x Kue:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// write this and then run with Vert.x Launcher in clustered mode</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleProcessVerticle</span> <span class="keyword">extends</span> <span class="title">AbstractVerticle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// must first create kue</span></span><br><span class="line">    Kue kue = Kue.createQueue(vertx, config());</span><br><span class="line"></span><br><span class="line">    Job job0 = kue.createJob(<span class="string">"video"</span>, <span class="keyword">new</span> JsonObject().put(<span class="string">"id"</span>, <span class="number">3001</span>))</span><br><span class="line">      .priority(Priority.HIGH)</span><br><span class="line">      .onComplete(e -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">"Video result: "</span> + e.getResult());</span><br><span class="line">        System.out.println(<span class="string">"Haha"</span>);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    job0.save();</span><br><span class="line"></span><br><span class="line">    kue.process(<span class="string">"video"</span>, <span class="number">1</span>, r -&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (r.succeeded()) &#123;</span><br><span class="line">        Job job = r.result();</span><br><span class="line">        <span class="comment">// consume 2 seconds</span></span><br><span class="line">        vertx.setTimer(<span class="number">2000</span>, l -&gt; &#123;</span><br><span class="line">          job.progress(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">          System.out.println(<span class="string">"Video id: "</span> + job.getId());</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.cause().printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Initial-concept-implementation-of-Vert-x-Kue"><a href="#Initial-concept-implementation-of-Vert-x-Kue" class="headerlink" title="Initial concept implementation of Vert.x Kue"></a>Initial concept implementation of Vert.x Kue</h2><p>See here:  <a href="https://github.com/sczyh30/vertx-blueprint-job-queue/tree/initial-work">sczyh30/vertx-blueprint-job-queue</a></p></div><a href="/en/2016/06/06/gsoc-2016-work-period-week2/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/05/29/gsoc-2016-work-period-week-1/" class="post-title-link">GSoC 2016 | Work Period | Week 1</a></h2><div class="post-time">May 29, 2016</div><div class="post-content"><p><img src="http://vertx.io/assets/logo-sm.png" alt=""></p>
<p>This is the summary of Google Summer Of Code 2016, Week One.</p>
<h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Refine the code and document of <strong>Vert.x Blueprint - Todo Backend</strong></li>
<li>Work on the Vert.x Blueprint - Kue (Basic Design)</li>
</ul>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="How-to-use-Vert-x-Codegen-with-Gradle"><a href="#How-to-use-Vert-x-Codegen-with-Gradle" class="headerlink" title="How to use Vert.x Codegen with Gradle"></a>How to use Vert.x Codegen with Gradle</h2><p>We need to understand the essence of Vert.x Codegen - an APT(annotation processing tool), so we could write a task to do processing:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">task</span> annotationProcessing(type: JavaCompile, <span class="keyword">group</span>: <span class="string">'build'</span>) &#123;</span><br><span class="line">  <span class="keyword">source</span> = <span class="keyword">sourceSets</span>.main.java</span><br><span class="line">  <span class="keyword">classpath</span> = <span class="keyword">configurations</span>.<span class="keyword">compile</span></span><br><span class="line">  <span class="keyword">destinationDir</span> = <span class="keyword">project</span>.<span class="keyword">file</span>(<span class="string">'src/main/generated'</span>)</span><br><span class="line">  <span class="keyword">options</span>.compilerArgs = [</span><br><span class="line">    <span class="string">"-proc:only"</span>,</span><br><span class="line">    <span class="string">"-processor"</span>, <span class="string">"io.vertx.codegen.CodeGenProcessor"</span>,</span><br><span class="line">    <span class="string">"-AoutputDirectory=$&#123;project.projectDir&#125;/src/main"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And in <code>compileJava</code> we reference the <code>annotationProcessing</code> task:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">compileJava &#123;</span><br><span class="line">  <span class="keyword">targetCompatibility</span> = <span class="number">1.8</span></span><br><span class="line">  <span class="keyword">sourceCompatibility</span> = <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">  dependsOn annotationProcessing</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">sourceSets</span> &#123;</span><br><span class="line">  main &#123;</span><br><span class="line">    java &#123;</span><br><span class="line">      srcDirs += <span class="string">'src/main/generated'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then we could process the annotations with Gradle~</p>
<p>The Chinese version is here: <a href="http://www.sczyh30.com/posts/Develop/gradle-annotation-processing-vertx-codegen/">在 Gradle 中使用Annotation Processing Tool | Vert.x Codegen 示例</a></p>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><p>Because there were many temporary experiments last week, I didn’t work during Friday to Sunday. Here are achievements of this week:</p>
<h2 id="Finished-the-Vert-x-Blueprint-Todo-Backend-project"><a href="#Finished-the-Vert-x-Blueprint-Todo-Backend-project" class="headerlink" title="Finished the Vert.x Blueprint - Todo Backend project"></a>Finished the <a href="https://github.com/sczyh30/vertx-blueprint-todo-backend">Vert.x Blueprint - Todo Backend</a> project</h2><h2 id="Basic-design-of-Vert-x-Kue"><a href="#Basic-design-of-Vert-x-Kue" class="headerlink" title="Basic design of Vert.x Kue"></a>Basic design of Vert.x Kue</h2><p>In <strong>Kue</strong>(Node.js), we use <code>kue.createQueue()</code> to create a <code>Kue</code> instance and then use <code>create(type, data)</code> to create a job and then save the job to <strong>Redis</strong>. After that, we invoke <code>job.process(type, callback)</code> to process the job.</p>
<p>And in my design of <strong>Vert.x Kue</strong>, I designed a <code>KueService</code> that provide basic functions and wrapped a class <code>Kue</code> like Queue in Node.js version. I use Vert.x Service Proxy and register it to a <code>KueVerticle</code>. Our user could create a custom verticle(e.g. <code>ExampleVerticle</code>) and create and process jon via <code>Kue</code> class.</p>
<p>As for processing jobs, I’m planning to use <strong>Worker Verticles</strong> or just use <code>executeBlocking</code> method.</p>
<h2 id="Learned-something-about-Microservice"><a href="#Learned-something-about-Microservice" class="headerlink" title="Learned something about Microservice"></a>Learned something about Microservice</h2><ul>
<li>Microservice patterns(Quorum, Circuit Breaker Pattern, Compensating Transaction Pattern, etc.)</li>
<li>Usage and reactive thoughts of <strong>Netflix Hystrix</strong></li>
</ul></div><a href="/en/2016/05/29/gsoc-2016-work-period-week-1/" class="read-more">...more</a></article></li></ul></section><footer><div class="paginator"><a href="/en/page/2/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016  <a href="http://www.sczyh30.com/en">Eric Zhao</a> |  sczyh30's Metaspace</p></div></footer></div><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>