<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> sczyh30's Metaspace</title><meta name="description" content="sczyh30's blog"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="http://www.sczyh30.com/en/favicon.png"><link rel="stylesheet" href="/en/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/en/" class="logo-link"><img src="http://www.sczyh30.com/en/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="http://www.sczyh30.com/en" target="_blank" class="nav-list-link">BLOG(EN)</a></li><li class="nav-list-item"><a href="http://www.sczyh30.com" target="_blank" class="nav-list-link">BLOG(中文)</a></li><li class="nav-list-item"><a href="http://www.sczyh30.com/en/archives/" target="_blank" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://www.sczyh30.com/en/about/" target="_blank" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="http://www.sczyh30.com/en/atom.xml" target="_blank" class="nav-list-link">RSS</a></li></ul></header><section class="container"><ul class="home post-list"><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/08/19/gsoc-2016-final-evaluation/" class="post-title-link">GSoC 2016 | Vert.x Blueprint Application</a></h2><div class="post-time">Aug 19, 2016</div><div class="post-content"><p><img src="https://developers.google.com/open-source/gsoc/resources/downloads/GSoC-icon-192.png" alt=""></p>
<p>This blog post is intended to be an illustration of my work for <strong>GSoC Final Evaluation</strong>.</p>
<h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>Vert.x is a toolkit for the Java Virtual Machine enabling the implementation of reactive, highly concurrent, polyglot applications. The idea of the project is to implement a set of applications using the Vert.x toolkit to illustrate how different classes of applications can be done. This project aims to <strong>provide guidelines to Vert.x users to implement various applications</strong>.</p>
<p>The blueprint project contains three parts: <strong>Todo Backend</strong>, <strong>Vert.x Kue</strong> and <strong>Online Shopping Microservice</strong>. Both runnable code and very detailed documents and tutorials (both in English and Chinese) are provided.</p>
<h1 id="Vert-x-Blueprint-Todo-Backend"><a href="#Vert-x-Blueprint-Todo-Backend" class="headerlink" title="Vert.x Blueprint - Todo Backend"></a>Vert.x Blueprint - Todo Backend</h1><p>The project <strong>repository</strong>: <a href="https://github.com/sczyh30/vertx-blueprint-todo-backend">sczyh30/vertx-blueprint-todo-backend</a>.</p>
<p>This blueprint is a todo-backend implementation using Vert.x and various persistence (e.g. Redis or MySQL). It is intended to be an introduction to basic Vert.x web RESTful service development. From this blueprint, developers could learn:</p>
<ul>
<li>What is Vert.x and its basic design</li>
<li>What is and how to use <code>Verticle</code></li>
<li>How to develop a REST API using Vert.x Web</li>
<li>How to make use of <strong>asynchronous development model</strong></li>
<li>Future-based reactive asynchronous pattern</li>
<li>How to use persistence such as <em>Redis</em> and <em>MySQL</em> with the help of Vert.x data access components</li>
</ul>
<p>The tutorial documents:</p>
<ul>
<li><a href="http://sczyh30.github.io/vertx-blueprint-todo-backend/">The tutorial document (English)</a></li>
<li><a href="http://sczyh30.github.io/vertx-blueprint-todo-backend/cn/">The tutorial document (Chinese)</a></li>
</ul>
<p><img src="https://raw.githubusercontent.com/sczyh30/vertx-blueprint-todo-backend/master/docs/img/vertx-todobackend-ui.png" alt=""></p>
<h1 id="Vert-x-Blueprint-Vert-x-Kue"><a href="#Vert-x-Blueprint-Vert-x-Kue" class="headerlink" title="Vert.x Blueprint - Vert.x Kue"></a>Vert.x Blueprint - Vert.x Kue</h1><p>The project <strong>repository</strong>: <a href="https://github.com/sczyh30/vertx-blueprint-job-queue">sczyh30/vertx-blueprint-job-queue</a>.</p>
<p>This blueprint is a priority job queue developed with Vert.x and backed by Redis. It’s a Vert.x implementation version of <a href="https://github.com/Automattic/kue">Automattic/kue</a> that can be used in production.</p>
<p>Feature document of Vert.x Kue is available here: <a href="https://github.com/sczyh30/vertx-blueprint-job-queue/blob/master/docs/en/vertx-kue-features-en.md">Vert.x Kue Features</a>.</p>
<p>This blueprint is intended to be an introduction to message-based application development using Vert.x. From this blueprint, developers could learn:</p>
<ul>
<li>How to make use of <strong>Vert.x Event Bus</strong> (distributed)</li>
<li>How to develop message based application with Vert.x</li>
<li>Event pattern of event bus (Pub/sub, point to point)</li>
<li>How to design clustered Vert.x applications</li>
<li>How to design and implement a job queue</li>
<li>How to use <strong>Vert.x Service Proxy</strong></li>
<li>More complicated practice about Vert.x Redis</li>
</ul>
<p>The tutorial documents:</p>
<ul>
<li><a href="http://sczyh30.github.io/vertx-blueprint-job-queue/kue-core/index.html">Vert.x Kue Core Tutorial - English Version</a></li>
<li><a href="http://sczyh30.github.io/vertx-blueprint-job-queue/kue-http/index.html">Vert.x Kue Web Tutorial - English Version</a></li>
<li><a href="http://sczyh30.github.io/vertx-blueprint-job-queue/cn/kue-core/index.html">Vert.x Kue Core Tutorial - Chinese Version</a></li>
<li><a href="http://sczyh30.github.io/vertx-blueprint-job-queue/cn/kue-http/index.html">Vert.x Kue Web Tutorial - Chinese Version</a></li>
</ul>
<p><img src="https://raw.githubusercontent.com/sczyh30/vertx-blueprint-job-queue/master/docs/images/vertx_kue_ui_1.png" alt=""></p>
<h1 id="Vert-x-Blueprint-Online-Shopping-Microservice"><a href="#Vert-x-Blueprint-Online-Shopping-Microservice" class="headerlink" title="Vert.x Blueprint - Online Shopping Microservice"></a>Vert.x Blueprint - Online Shopping Microservice</h1><p>The project <strong>repository</strong>: <a href="https://github.com/sczyh30/vertx-blueprint-microservice">sczyh30/vertx-blueprint-microservice</a>.</p>
<p>This blueprint is an online shopping microservice application developed with Vert.x. It is intended to be an illustration on how to develop microservice applications using Vert.x toolkit. From this blueprint, developers could learn:</p>
<ul>
<li>Microservice development with Vert.x</li>
<li>Asynchronous development model</li>
<li>Reactive and functional pattern</li>
<li>Event sourcing pattern</li>
<li>Asynchronous RPC on the clustered event bus</li>
<li>Various type of services (e.g. HTTP endpoint, message source, event bus service)</li>
<li>Vert.x Service Discovery</li>
<li>Vert.x Circuit Breaker</li>
<li>Microservice with polyglot persistence</li>
<li>How to implement an API gateway</li>
<li>Global authentication (OAuth 2 + Keycloak)</li>
</ul>
<p>And many more things…</p>
<p>The tutorial documents:</p>
<ul>
<li><a href="http://sczyh30.github.io/vertx-blueprint-microservice/index.html">Vert.x Microservice Blueprint Tutorial - Development (English Version)</a></li>
<li><a href="http://sczyh30.github.io/vertx-blueprint-microservice/api-gateway.html">Vert.x Microservice Blueprint Tutorial - API Gateway (English Version)</a></li>
<li><a href="http://sczyh30.github.io/vertx-blueprint-microservice/cn/index.html">Vert.x Microservice Blueprint Tutorial - Development (Chinese Version)</a></li>
<li><a href="http://sczyh30.github.io/vertx-blueprint-microservice/cn/api-gateway.html">Vert.x Microservice Blueprint Tutorial - API Gateway (Chinese Version)</a></li>
</ul>
<p><img src="https://raw.githubusercontent.com/sczyh30/vertx-blueprint-microservice/master/docs/images/shopping-spa-index.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/sczyh30/vertx-blueprint-microservice/master/docs/images/monitor-dashboard.png" alt=""></p>
<h1 id="Final-Summary-amp-amp-Future"><a href="#Final-Summary-amp-amp-Future" class="headerlink" title="Final Summary &amp;&amp; Future"></a>Final Summary &amp;&amp; Future</h1><p>I really enjoy the work! During the work period I’ve learned a lot about Vert.x, various asynchronous development model, distributed systems, microservice architecture and many more things… This motivates me to investigate new technologies, and the infrastructure of Vert.x. This would be an unforgettable experience.</p>
<p>I’ll keep track of the blueprint project and planning to make some more improvements on the microservice blueprint to illustrate more usage about Vert.x and microservices (e.g. recommendation, Kafka, full-index search). And soon I’d like to contribute to <strong>Vert.x Microservice Toolbox</strong> to add more features and integration with other technologies. As <strong>Vert.x Scala</strong> is nearly technical preview, I’m also willing to contribute to Vert.x Scala version.</p>
<h1 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h1><p>I would like to give my sincere thanks to:</p>
<ul>
<li>My mentors, <a href="https://github.com/pmlopes">Paulo Lopes</a> and <a href="https://github.com/cescoffier">Clement Escoffier</a>. They provided me guidance and gave me a lot of help during the work :-)</li>
<li>The <strong>Vert.x Community</strong>.</li>
<li>The Google Summer of Code team, for this wonderful experience.</li>
</ul></div><a href="/en/2016/08/19/gsoc-2016-final-evaluation/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/08/11/vertx-blueprint-microservice-design-refactor-01/" class="post-title-link">Vert.x Microservice Blueprint | Some changes && refactoring</a></h2><div class="post-time">Aug 11, 2016</div><div class="post-content"><h1 id="Simplified-architecture"><a href="#Simplified-architecture" class="headerlink" title="Simplified architecture"></a>Simplified architecture</h1><p>Some of the unecessary components has been removed:</p>
<ul>
<li>Payment Microservice: The logic should be refactored in order to fit for real production logic.</li>
</ul>
<p>New diagram:</p>
<p><img src="https://raw.githubusercontent.com/sczyh30/vertx-blueprint-microservice/initial-work/docs/images/entire-architecture.png" alt=""></p>
<h1 id="API-Gateway"><a href="#API-Gateway" class="headerlink" title="API Gateway"></a>API Gateway</h1><p>As suggested by Clement and Paulo, I use HTTP-HTTP pattern for API Gateway eventually. The API gateway itself is using HTTPS, but it communicates REST endpoints via HTTP.</p>
<p>So the API Gateway is responsible for:</p>
<ul>
<li>Dispatching requests to corresponding endpoint.</li>
</ul>
<blockquote>
<p>How to implement this?<br><strong>My solution</strong>: When publishing endpoints to the service discovery infrasture, every endpoints must provide an <code>api-name</code> to identify the api, then when a request arrives from the gateway, the gateway will get the prefix pattern <code>/api/:name/*</code> and find any corresponding endpoints via discovery, then consume the HTTP endpoint.</p>
</blockquote>
<ul>
<li>Simple load balancing</li>
<li>Health check</li>
<li>Failure handling (using Vert.x Circuit Breaker)</li>
<li>Global auth state storage(in route context and session scope)</li>
</ul>
<h1 id="Auth"><a href="#Auth" class="headerlink" title="Auth"></a>Auth</h1><p>It’s convenient to use Keycloak via Vert.x OAuth2.</p></div><a href="/en/2016/08/11/vertx-blueprint-microservice-design-refactor-01/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/08/07/gsoc-work-period-week-11/" class="post-title-link">GSoC 2016 | Work Period | Week 11</a></h2><div class="post-time">Aug 7, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Architecture enhancement</li>
<li>A simple SPA frontend for the microservice blueprint (use Vue.js)</li>
<li>Monitor dashboard</li>
<li>A simple recommendation component<ul>
<li>Maybe I should write a individual component providing Neo4j integration with Vert.x</li>
</ul>
</li>
<li>Run the application with Docker Compose</li>
<li>Update tests</li>
<li>Update documents and tutorials</li>
</ul>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="Solved-Global-auth"><a href="#Solved-Global-auth" class="headerlink" title="Solved: Global auth"></a>Solved: Global auth</h2><p>How to manage global auth in a microservice application. For example, we login in from the login page and our login data is saved in the session. When we visit resources that are protected behind the auth, how we validate the user info (e.g. via session data or use SSO)?</p>
<p><strong>Solved:</strong> Use OAuth 2 + Keycloak is a good point. The API gateway is responsible for storing authentication principal and validation.</p>
<p><strong>Thought</strong>: How to integrate well with SPA frontend?</p>
<h2 id="Solved-Need-a-better-mechanism-for-API-gateway"><a href="#Solved-Need-a-better-mechanism-for-API-gateway" class="headerlink" title="Solved: Need a better mechanism for API gateway"></a>Solved: Need a better mechanism for API gateway</h2><p><strong>Solved:</strong> use HTTP-HTTP pattern. The API Gateway is a individual verticle and is responsible for dispatching requests, managing global authentication, handling failure, health checking and simple load balancing. The API Gateway itself uses HTTPS, but it interacts with the downstream REST endpoints via HTTP.</p>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><ul>
<li>Refactored the architecture of the online shopping microservice, simplified some components (more features will be added into next version)</li>
<li>Enhanced the logic of the entire online shopping process</li>
<li>Code refinement and bug fixed</li>
<li>Added some tests (some tests are in local and weren’t committed as it requires some local envs)</li>
</ul></div><a href="/en/2016/08/07/gsoc-work-period-week-11/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/08/01/vertx-blueprint-microservice-basic-design/" class="post-title-link">Vert.x Microservice Blueprint | Basic Design</a></h2><div class="post-time">Aug 1, 2016</div><div class="post-content"><p>The blueprint is an online shopping microservice application. You can treat it as a very simple C2C market like eBay.</p>
<p>Here is a diagram illustrating the microservice architecture:</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/vertx-msb-initial-structure.png" alt="Basic Design"></p>
<p>Currently I designed these components:</p>
<ul>
<li><code>account-microservice</code>: Component for user account</li>
<li><code>product-microservice</code>: Component for products we sell and buy</li>
<li><code>store-microservice</code>: Component for individual stores in the market</li>
<li><code>checkout-microservice</code>: Compoment for order checkout</li>
<li><code>payment-microservice</code>: Compoment for payment transaction processing</li>
<li><code>order-microservice</code>: Compoment for order dispatching, processing, analyzing and storage<ul>
<li><strong>NOTE</strong>: this component should be divided into several sub-components</li>
</ul>
</li>
<li><code>recommendation-microservice</code>: Compoment for simple recommendation for friends and favorite products with Neo4j</li>
<li><code>cache-infrastructure</code>: Cache component for services</li>
<li><code>api-gateway</code>: API gateway (with load balance)</li>
<li><code>shopping-ui</code>: A SPA front-end for the microservice</li>
<li><code>monitor-dashboard</code>: Dashboard for performance monitoring and backend metrics data demonstration</li>
</ul>
<p>Here is the user workflow: <code>User login and add products to chart -&gt; Checkout -&gt; Go to payment page and pay for the products -&gt; Payment transaction success, order submitted -&gt; (Wait for delivery...)</code></p>
<p>All events are sent on the event bus.</p></div><a href="/en/2016/08/01/vertx-blueprint-microservice-basic-design/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/08/01/gsoc-2016-work-period-week9-10/" class="post-title-link">GSoC 2016 | Work Period | Week 9 - Week 10</a></h2><div class="post-time">Aug 1, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Initial work for Online Shopping Microservice Blueprint</li>
<li>Prepare for next blueprint application (high performance)</li>
</ul>
<p><em>Good luck~ :-)</em></p>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="API-gateway"><a href="#API-gateway" class="headerlink" title="API gateway"></a>API gateway</h2><p>How to implement an API gateway with load balance.</p>
<h2 id="Checkout-model"><a href="#Checkout-model" class="headerlink" title="Checkout model"></a>Checkout model</h2><p>TODO: The checkout-payment-order model should be changed.</p>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>In our design, the online shopping microservice blueprint contains many components, so we need to pay attention to how to deploy such a microservice application (e.g. use Docker Compose, Kubernetes; Deploy on Openshift)</p>
<h2 id="Order-dispatching-design"><a href="#Order-dispatching-design" class="headerlink" title="Order dispatching design"></a>Order dispatching design</h2><p>In our current design, orders are sent via clustered event bus. But a real production environment, orders are supposed to be dispatched to message queues with recovery and persistence ability(e.g. Kafka). And the order processing component and order persistence component should pull orders from the MQ.</p>
<h2 id="Integration-with-other-technologies"><a href="#Integration-with-other-technologies" class="headerlink" title="Integration with other technologies"></a>Integration with other technologies</h2><p>e.g. Kafka</p>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><ul>
<li>Initial work for Online Shopping Microservice Blueprint</li>
</ul></div><a href="/en/2016/08/01/gsoc-2016-work-period-week9-10/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/07/16/gsoc-2016-work-period-week-7/" class="post-title-link">GSoC 2016 | Work Period | Week 7 - Week 8</a></h2><div class="post-time">Jul 16, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Finish Chinese documentation of Vert.x Kue</li>
<li>Work on microservice blueprint</li>
<li>Learn more about <strong>Vert.x Microservice</strong></li>
</ul>
<p><strong>Notice:</strong> Because my semester final exams is pending this week and next week, I’ll have to be busy with them. So I might spend less time on it (have time in the evening). After the final exams I’ll speed up and make a wonderful blueprint!</p>
<p><em>Good luck~ :-)</em></p>
<p>The final exams finally finished!!!</p></div><a href="/en/2016/07/16/gsoc-2016-work-period-week-7/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/07/03/gsoc-2016-work-period-week5-6/" class="post-title-link">GSoC 2016 | Work Period | Week 5 - Week 6</a></h2><div class="post-time">Jul 3, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Some extra things to implement or fix:<ul>
<li>Job active TTL check</li>
<li>Job search functionality</li>
<li>Render issue with <code>_filter.jade</code></li>
</ul>
</li>
<li>Finish documents and tutorials of <strong>Vert.x Kue</strong></li>
<li>Finish tests</li>
<li>Add Docker Compose file</li>
<li>Prepare for the microservice blueprint</li>
</ul>
<p><em>Good luck~ :-)</em></p>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="TODO-Job-search-functionality"><a href="#TODO-Job-search-functionality" class="headerlink" title="TODO: Job search functionality"></a>TODO: Job search functionality</h2><p>This need a full-index engine.</p>
<h2 id="TODO-Run-Vert-x-Kue-in-Docker-Cluster"><a href="#TODO-Run-Vert-x-Kue-in-Docker-Cluster" class="headerlink" title="TODO: Run Vert.x Kue in Docker Cluster"></a>TODO: Run Vert.x Kue in Docker Cluster</h2><p>Maybe we need some configurations for Hazelcast to support it on Docker.</p>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><ul>
<li>Finish English documents and tutorials of <strong>Vert.x Kue</strong></li>
<li>Finish part of Chinese documents and tutorials of <strong>Vert.x Kue</strong></li>
<li>Initial design for bluepint microservice</li>
</ul>
<p>These days my progress is slow…Because I have to prepare for the final exam(7.1 - 7.15) these days…</p></div><a href="/en/2016/07/03/gsoc-2016-work-period-week5-6/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/06/20/vertx-kue-brief-introduction-how-it-works/" class="post-title-link">Vert.x Kue | A brief introduction to how it works</a></h2><div class="post-time">Jun 20, 2016</div><div class="post-content"><p>In this blog post, I’ll give a brief introduction to illustrate how Vert.x Kue works.</p>
<p>In the workflow, first we deploy the <code>KueVerticle</code> in clustered mode and register the <code>JobService</code> on the event bus. The <code>JobService</code> consists of various logic of <code>Job</code>. After that, we could then deploy <code>KueHttpVerticle</code> to provide REST API. Most of the apis calls <code>Future</code>-based methods in <code>Kue</code>. Finally we could deploy our job processing verticle. The verticle usually consists of three parts:</p>
<ul>
<li>create <code>Kue</code> instance</li>
</ul>
<p>When we create <code>Kue</code> instance, the inner <code>JobService</code> proxy and redis client will be created. Also, the static <code>Vertx</code> field in <code>Job</code> class will also be initilized.</p>
<ul>
<li>create and save <code>Job</code></li>
</ul>
<p>Here we could set job properties and subscribe events from the job address(via event bus).</p>
<ul>
<li>process the <code>Job</code></li>
</ul>
<p>When we call the <code>process</code> or <code>processBlocking</code> method, Vert.x Kue will create and then deploy some <strong>KueWorkers</strong>, which is a kind of verticle(or worker verticle, if calling <code>processBlocking</code>).</p>
<p>In <code>KueWorker</code>, we first get <code>Job</code> from Redis backend (<code>zpop</code> operation):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAndStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.getJobFromBackend().setHandler(jr -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (jr.succeeded()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (jr.result().isPresent()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.job = jr.result().get();</span><br><span class="line">        process();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"job not exist"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      jr.cause().printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the <code>KueWorker</code> successfully gets the job, it will do process procedure. First we set <code>started_at</code> flag on the job and then save it to the backend. Then we emit the job <strong>start</strong> event on the event bus(both job address and worker address). Next, we will process the job using the given handler. Simultaneously, we consume <code>done</code> and <code>done_fail</code> events on the job-specific address. If <code>done</code> event received, the job should be completed and we emit <code>complete</code> event. If <code>done_fail</code> event received, the job should be failed so we first do a failed attempt. If attempt failed, then send <code>error</code> event on worker address. Else send <code>failed</code> or <code>failed_attempt</code> event depending on the attempt status.</p>
<p>There are three kinds of address:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   * Handler address with certain job on event bus</span><br><span class="line">   * Format: vertx.kue.handler.job.&#123;handlerType&#125;.&#123;addressId&#125;.&#123;jobType&#125;</span><br><span class="line">   *</span><br><span class="line">   * <span class="doctag">@return</span> corresponding address</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCertainJobAddress</span><span class="params">(String handlerType, Job job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"vertx.kue.handler.job."</span> + handlerType + <span class="string">"."</span> + job.getAddress_id() + <span class="string">"."</span> + job.getType();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Global worker address with specific event type</span><br><span class="line"> */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">workerAddress</span><span class="params">(String eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"vertx.kue.handler.workers."</span> + eventType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * Worker address with specific event type and job-uuid on event bus</span><br><span class="line">   * Format: vertx.kue.handler.workers.&#123;eventType&#125;</span><br><span class="line">   *</span><br><span class="line">   * <span class="doctag">@return</span> corresponding address</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">workerAddress</span><span class="params">(String eventType, Job job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"vertx.kue.handler.workers."</span> + eventType + <span class="string">"."</span> + job.getAddress_id();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Diagram"><a href="#Diagram" class="headerlink" title="Diagram"></a>Diagram</h2><p><img src="https://github.com/sczyh30/vertx-blueprint-job-queue/raw/initial-work/docs/images/kue_diagram.png" alt=""></p></div><a href="/en/2016/06/20/vertx-kue-brief-introduction-how-it-works/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/06/20/gsoc-2016-work-period-week4/" class="post-title-link">GSoC 2016 | Work Period | Week 4</a></h2><div class="post-time">Jun 20, 2016</div><div class="post-content"><p>The GSoC Midterm Evaluation is coming~ Boost~O(∩_∩)O</p>
<h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Enhance <strong>Event system</strong> and <code>KueWorker</code> in Kue<ul>
<li>Implement all basic events in original Kue</li>
<li>If possible, do some performance optimization</li>
</ul>
</li>
<li>Add test cases and fix bugs</li>
<li>Add more examples</li>
<li>Finish all Vert.x Kue REST apis</li>
<li>Adapt Vert.x Kue REST API with original Kue’s UI</li>
<li>Code refinement</li>
<li>Initial document and design diagram update</li>
<li>Learn more about new features in Vert.x 3.3.0</li>
</ul>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><ul>
<li><code>initial-work</code> implementation of <strong>Vert.x Kue</strong> (including Vert.x Kue REST API and UI)<ul>
<li>See: <a href="https://github.com/sczyh30/vertx-blueprint-job-queue/tree/initial-work">sczyh30/vertx-blueprint-job-queue</a></li>
</ul>
</li>
<li>Bugs fixed</li>
<li>Add more examples</li>
<li>Some refactor and code refinement</li>
<li>Feature document draft</li>
</ul></div><a href="/en/2016/06/20/gsoc-2016-work-period-week4/" class="read-more">...more</a></article></li><li class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/en/2016/06/12/gsoc-2016-work-period-week3/" class="post-title-link">GSoC 2016 | Work Period | Week 3</a></h2><div class="post-time">Jun 12, 2016</div><div class="post-content"><h1 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h1><p>In this week, I’m planning to do the following stuff:</p>
<ul>
<li>Core component of Vert.x Kue implementation complete<ul>
<li><strong>Event system</strong> in Kue</li>
<li><code>KueWorker</code></li>
<li><code>Job</code></li>
</ul>
</li>
<li>Basic implementation of Vert.x Kue HTTP component<ul>
<li>REST API implementation</li>
<li>A simple UI (Vert.x Kue UI)</li>
</ul>
</li>
<li>Refine the code of Vert.x Kue<ul>
<li>The <code>Job</code> class is messy and need refinement</li>
<li>More concise</li>
</ul>
</li>
<li>Learn more about microservice (as well as Vert.x Microservice Toolbox)</li>
<li>Write a brief introduction to new features of Vert.x 3.3.0 (in Chinese, will publish in <em>Vert.x China Group</em>)</li>
</ul>
<p>PS: <strong>The Dragon Boat Festival</strong> holiday will be coming from Thursday to Saturday this week so I may not spend very much time on work during the holiday~ <em>Have a great week :-)</em></p>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><h2 id="Solved-Regex-match-in-route-path"><a href="#Solved-Regex-match-in-route-path" class="headerlink" title="Solved: Regex match in route path"></a>Solved: Regex match in route path</h2><p>In original Kue’s API, there is a route with path <code>/jobs/:from..:to/:order?</code>. I tried this in Vert.x Web(<code>/jobs/:from..:to</code>) but Vert.x Web cannot match it. So I used regex match <code>\/jobs\/([0-9]*)\.\.([0-9]*)(\/[^\/]+)?</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KUE_API_JOB_RANGE = <span class="string">"\\/jobs\\/([0-9]*)\\.\\.([0-9]*)(\\/[^\\/]+)?"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">router.getWithRegex(KUE_API_JOB_RANGE).handler(<span class="keyword">this</span>::apiJobRange);</span><br></pre></td></tr></table></figure>
<p>But nothing matched, which made me confused. And path like <code>/jobs/:from/to/:to</code> can be matched.</p>
<p>Solution: First use a supported pattern to catch string like <code>1..10</code> then use regex parse.</p>
<h1 id="Achievement"><a href="#Achievement" class="headerlink" title="Achievement"></a>Achievement</h1><h2 id="Implementation-of-Vert-x-Kue-core"><a href="#Implementation-of-Vert-x-Kue-core" class="headerlink" title="Implementation of Vert.x Kue core"></a>Implementation of Vert.x Kue core</h2><ul>
<li>Job processing interface <code>KueService</code> now provides two methods: <code>process</code> method do asynchronous procedure(use common verticles), while <code>processBlocking</code> method could do blocking procedure(use worker verticles)</li>
<li>Add attempt support (could attempt when fails)<ul>
<li><em>TODO: need enhancement and test</em></li>
</ul>
</li>
<li>Add worker and job cardinality metrics support</li>
<li>Add support for getting jobs with range(rank)</li>
<li>Basic refinement of <code>Job</code> class</li>
<li>Refactored most of async methods to <code>Future</code> based style (in order to support monadic transform and say goodbye to callback hell)</li>
<li>Fix issue: Sometimes throw <code>java.lang.ClassCastException</code> caused by wrong time flow when processing a job</li>
<li>Fix issue: Generated json converter <em>sometimes</em> could not distinguish some properties(e.g. <code>id</code> and <code>jobMetrics</code>) correctly</li>
</ul>
<p>See here:  <a href="https://github.com/sczyh30/vertx-blueprint-job-queue/tree/initial-work">sczyh30/vertx-blueprint-job-queue</a></p>
<h2 id="Basic-implementation-of-Vert-x-Kue-HTTP-component"><a href="#Basic-implementation-of-Vert-x-Kue-HTTP-component" class="headerlink" title="Basic implementation of Vert.x Kue HTTP component"></a>Basic implementation of Vert.x Kue HTTP component</h2><ul>
<li>Basic implementation of Vert.x Kue REST API(get job, create job, delete job, get job by range(or state), etc)</li>
<li>Basic adaption between Vert.x Web and original Kue UI (rendered with <code>vertx-web-templ-jade</code>; still have some problems to solve)</li>
</ul>
<h2 id="Wrote-a-brief-introduction-to-new-features-of-Vert-x-3-3-0-in-Chinese"><a href="#Wrote-a-brief-introduction-to-new-features-of-Vert-x-3-3-0-in-Chinese" class="headerlink" title="Wrote a brief introduction to new features of Vert.x 3.3.0 in Chinese"></a>Wrote a brief introduction to new features of Vert.x 3.3.0 in Chinese</h2></div><a href="/en/2016/06/12/gsoc-2016-work-period-week3/" class="read-more">...more</a></article></li></ul></section><footer><div class="paginator"><a href="/en/page/2/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016  <a href="http://www.sczyh30.com/en">Eric Zhao</a> |  sczyh30's Metaspace</p></div></footer></div><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>