<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="sczyh30" />



<meta name="description" content="本文章是 Vert.x 蓝图系列 的第一篇教程。全系列：

Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程
Vert.x Blueprint 系列教程(二) | 开发基于消息的应用 - Vert.x Kue 教程
Vert.x Blueprint 系列教程(三) | Micro Shop 微服务应用实践

前言在本教程中，我们会使用Vert.x来一步一步地开发一个RES">
<meta property="og:type" content="article">
<meta property="og:title" content="Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程">
<meta property="og:url" content="http://www.sczyh30.com/posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/index.html">
<meta property="og:site_name" content="「浮生若梦」 - sczyh30's blog">
<meta property="og:description" content="本文章是 Vert.x 蓝图系列 的第一篇教程。全系列：

Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程
Vert.x Blueprint 系列教程(二) | 开发基于消息的应用 - Vert.x Kue 教程
Vert.x Blueprint 系列教程(三) | Micro Shop 微服务应用实践

前言在本教程中，我们会使用Vert.x来一步一步地开发一个RES">
<meta property="og:image" content="https://github.com/sczyh30/vertx-blueprint-todo-backend/raw/master/docs/img/todo-test-input.png">
<meta property="og:image" content="https://github.com/sczyh30/vertx-blueprint-todo-backend/raw/master/docs/img/todo-test-result.png">
<meta property="og:image" content="https://github.com/sczyh30/vertx-blueprint-todo-backend/raw/master/docs/img/vbptds-docker-compose-running.png">
<meta property="og:updated_time" content="2016-11-24T06:07:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程">
<meta name="twitter:description" content="本文章是 Vert.x 蓝图系列 的第一篇教程。全系列：

Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程
Vert.x Blueprint 系列教程(二) | 开发基于消息的应用 - Vert.x Kue 教程
Vert.x Blueprint 系列教程(三) | Micro Shop 微服务应用实践

前言在本教程中，我们会使用Vert.x来一步一步地开发一个RES">
<meta name="twitter:image" content="https://github.com/sczyh30/vertx-blueprint-todo-backend/raw/master/docs/img/todo-test-input.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="「浮生若梦」 - sczyh30&#39;s blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程 | 「浮生若梦」 - sczyh30&#39;s blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/assets/blog-default-lambda-avatar.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">sczyh30</a></h1>
        </hgroup>

        
        <p class="header-subtitle">踏歌长行，梦想永在。</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about">About Me</a></li>
                        
                            <li><a href="/en/">Blog(EN)</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="/about" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/sczyh30" title="GitHub"></a>
                            
                                <a class="fa 新浪微博" href="http://weibo.com/sczyh30" title="新浪微博"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Google" href="https://plus.google.com/u/0/117807083506391735472" title="Google"></a>
                            
                                <a class="fa Twitter" href="https://twitter.com/sczyh30" title="Twitter"></a>
                            
                                <a class="fa Medium" href="https://medium.com/@sczyh30" title="Medium"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AMQP/">AMQP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/APT/">APT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Akka/">Akka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/">Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-14/">C++ 14</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CAP/">CAP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CPS/">CPS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/">Cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Category-Theory/">Category Theory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chemistry/">Chemistry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Continuation/">Continuation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DI/">DI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Euterpea/">Euterpea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Event-Loop/">Event Loop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Functional-Programming/">Functional Programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GC/">GC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GDB/">GDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Game/">Game</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/">Gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/">HashMap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haskell/">Haskell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HotSpot/">HotSpot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/">IO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JUC/">JUC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Klass-oop/">Klass-oop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lambda-Calculus/">Lambda Calculus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LinkedList/">LinkedList</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MIDI/">MIDI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mathematical-Logic/">Mathematical Logic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Metaspace/">Metaspace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netflix-Hystrix/">Netflix Hystrix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Object-Model/">Object Model</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PLT/">PLT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Paper/">Paper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Play-Framework/">Play Framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Quorum/">Quorum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Reflection/">Reflection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RxJava/">RxJava</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/">SQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/STL/">STL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/">Scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scheme/">Scheme</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Slick/">Slick</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sort/">Sort</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Summary/">Summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-Class/">Type Class</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-Lambda/">Type Lambda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-System/">Type System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-Theory/">Type Theory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vert-x/">Vert.x</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web开发/">Web开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中间件/">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/云服务/">云服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存区域/">内存区域</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式/">分布式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式系统/">分布式系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式计算/">分布式计算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基础/">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/容器/">容器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开发/">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异步编程/">异步编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微服务/">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能优化/">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息系统/">消息系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/源码分析/">源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/滑动窗口/">滑动窗口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生活/">生活</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线程安全/">线程安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/虚拟化/">虚拟化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/限流降级/">限流降级</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高可用架构/">高可用架构</a></li></ul>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">Distributed System/Deep Learning/PLT</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">sczyh30</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/assets/blog-default-lambda-avatar.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">sczyh30</a></h1>
            </hgroup>
            
            <p class="header-subtitle">踏歌长行，梦想永在。</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about">About Me</a></li>
                
                    <li><a href="/en/">Blog(EN)</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/about" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/sczyh30" title="GitHub"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="http://weibo.com/sczyh30" title="新浪微博"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Google" target="_blank" href="https://plus.google.com/u/0/117807083506391735472" title="Google"></a>
                            
                                <a class="fa Twitter" target="_blank" href="https://twitter.com/sczyh30" title="Twitter"></a>
                            
                                <a class="fa Medium" target="_blank" href="https://medium.com/@sczyh30" title="Medium"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-vertx-blueprint-1-todo-backend-tutorial" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/" class="article-date">
      <time datetime="2016-06-15T16:00:00.000Z" itemprop="datePublished">2016-06-16</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Asynchronous/">Asynchronous</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vert-x/">Vert.x</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web开发/">Web开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/异步编程/">异步编程</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>本文章是 <a href="http://vertx.io/blog/vert-x-blueprint-tutorials/" target="_blank" rel="external">Vert.x 蓝图系列</a> 的第一篇教程。全系列：</p>
<ul>
<li>Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程</li>
<li><a href="http://www.sczyh30.com/posts/Asynchronous/vertx-blueprint-2-vertx-kue-core-tutorial/">Vert.x Blueprint 系列教程(二) | 开发基于消息的应用 - Vert.x Kue 教程</a></li>
<li><a href="http://www.sczyh30.com/posts/Asynchronous/vertx-blueprint-3-micro-shop-microservice/">Vert.x Blueprint 系列教程(三) | Micro Shop 微服务应用实践</a></li>
</ul>
<h1 id="前言">前言</h1><p>在本教程中，我们会使用Vert.x来一步一步地开发一个REST风格的Web服务 - Todo Backend，你可以把它看作是一个简单的待办事项服务，我们可以自由添加或者取消各种待办事项。</p>
<p>通过本教程，你将会学习到以下的内容：</p>
<ul>
<li><strong>Vert.x</strong> 是什么，以及其基本设计思想</li>
<li><code>Verticle</code>是什么，以及如何使用<code>Verticle</code></li>
<li>如何用 <strong>Vert.x Web</strong> 来开发REST风格的Web服务</li>
<li><strong>异步编程风格</strong> 的应用</li>
<li>如何通过 Vert.x 的各种组件来进行数据的存储操作（如 <em>Redis</em> 和 <em>MySQL</em>）</li>
</ul>
<p>本教程是 <strong>Vert.x 蓝图系列</strong> 的第一篇教程，对应的Vert.x版本为<strong>3.3.3</strong>。本教程中的完整代码已托管至<a href="https://github.com/sczyh30/vertx-blueprint-todo-backend/tree/master" target="_blank" rel="external">GitHub</a>。</p>
<h1 id="踏入Vert-x之门">踏入Vert.x之门</h1><p>朋友，欢迎来到Vert.x的世界！初次听说Vert.x，你一定会非常好奇：这是啥？让我们来看一下Vert.x的官方解释：</p>
<blockquote>
<p>Vert.x is a tool-kit for building reactive applications on the JVM.</p>
</blockquote>
<p>(⊙o⊙)哦哦。。。翻译一下，Vert.x是一个在JVM上构建 <strong>响应式</strong> 应用的 <strong>工具集</strong> 。这个定义比较模糊，我们来简单解释一下：<strong>工具集</strong> 意味着Vert.x非常轻量，可以嵌入到你当前的应用中而不需要改变现有的结构；另一个重要的描述是 <strong>响应式</strong> —— Vert.x就是为构建响应式应用（系统）而设计的。响应式系统这个概念在 <a href="http://reactivemanifesto.org/" target="_blank" rel="external">Reactive Manifesto</a> 中有详细的定义。我们在这里总结4个要点：</p>
<ul>
<li>响应式的(Responsive)：一个响应式系统需要在 <em>合理</em> 的时间内处理请求。</li>
<li>弹性的(Resilient)：一个响应式系统必须在遇到 <em>异常</em> （崩溃，超时， <code>500</code> 错误等等）的时候保持响应的能力，所以它必须要为 <em>异常处理</em> 而设计。</li>
<li>可伸缩的(Elastic)：一个响应式系统必须在不同的负载情况下都要保持响应能力，所以它必须能伸能缩，并且可以利用最少的资源来处理负载。</li>
<li>消息驱动：一个响应式系统的各个组件之间通过 <strong>异步消息传递</strong> 来进行交互。</li>
</ul>
<p>Vert.x是 <strong>事件驱动的</strong>，同时也是非阻塞的。首先，我们来介绍 <strong>Event Loop</strong> 的概念。Event Loop是一组负责分发和处理事件的线程。注意，我们绝对不能去阻塞Event Loop线程，否则事件的处理过程会被阻塞，我们的应用就失去了响应能力。因此当我们在写Vert.x应用的时候，我们要时刻谨记 <strong>异步非阻塞开发模式</strong> 而不是传统的阻塞开发模式。我们将会在下面详细讲解异步非阻塞开发模式。</p>
<h1 id="我们的应用_-_待办事项服务">我们的应用 - 待办事项服务</h1><p>我们的应用是一个REST风格的待办事项服务，它非常简单，整个API其实就围绕着 <em>增删改查</em> 四种操作。所以我们可以设计以下的路由：</p>
<ul>
<li>添加待办事项: <code>POST /todos</code></li>
<li>获取某一待办事项: <code>GET /todos/:todoId</code></li>
<li>获取所有待办事项: <code>GET /todos</code></li>
<li>更新待办事项: <code>PATCH /todos/:todoId</code></li>
<li>删除某一待办事项: <code>DELETE /todos/:todoId</code></li>
<li>删除所有待办事项: <code>DELETE /todos</code></li>
</ul>
<p>注意我们这里不讨论REST风格API的设计规范（仁者见仁,智者见智），因此你也可以用你喜欢的方式去定义路由。</p>
<p>下面我们开始开发我们的项目！High起来～～～</p>
<h1 id="说干就干！">说干就干！</h1><p>Vert.x Core提供了一些较为底层的处理HTTP请求的功能，这对于Web开发来说不是很方便，因为我们通常不需要这么底层的功能，因此<a href="http://vertx.io/docs/vertx-web/java" target="_blank" rel="external">Vert.x Web</a>应运而生。Vert.x Web基于Vert.x Core，并且提供一组更易于创建Web应用的上层功能（如路由）。</p>
<h2 id="Gradle配置文件">Gradle配置文件</h2><p>首先我们先来创建我们的项目。在本教程中我们使用<strong>Gradle</strong>作为构建工具，当然你也可以使用其它诸如Maven之类的构建工具。我们的项目目录里需要有：</p>
<ol>
<li><code>src/main/java</code> 文件夹（源码目录）</li>
<li><code>src/test/java</code> 文件夹（测试目录）</li>
<li><code>build.gradle</code> 文件（Gradle配置文件）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── build.gradle</div><div class="line">├── settings.gradle</div><div class="line">├── src</div><div class="line">│   ├── main</div><div class="line">│   │   └── java</div><div class="line">│   └── test</div><div class="line">│       └── java</div></pre></td></tr></table></figure>
<p>我们首先来创建 <code>build.gradle</code> 文件，这是Gradle对应的配置文件：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">apply <span class="string">plugin:</span> <span class="string">'java'</span></div><div class="line"></div><div class="line">targetCompatibility = <span class="number">1.8</span></div><div class="line">sourceCompatibility = <span class="number">1.8</span></div><div class="line"></div><div class="line">repositories &#123;</div><div class="line">  jcenter()</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line"></div><div class="line">  compile <span class="string">"io.vertx:vertx-core:3.3.3"</span></div><div class="line">  compile <span class="string">'io.vertx:vertx-web:3.3.3'</span></div><div class="line"></div><div class="line">  testCompile <span class="string">'io.vertx:vertx-unit:3.3.3'</span></div><div class="line">  testCompile <span class="string">group:</span> <span class="string">'junit'</span>, <span class="string">name:</span> <span class="string">'junit'</span>, <span class="string">version:</span> <span class="string">'4.12'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可能不是很熟悉Gradle，这不要紧。我们来解释一下：</p>
<ul>
<li>我们将 <code>targetCompatibility</code> 和 <code>sourceCompatibility</code> 这两个值都设为<strong>1.8</strong>，代表目标Java版本是Java 8。这非常重要，因为Vert.x就是基于Java 8构建的。</li>
<li>在<code>dependencies</code>中，我们声明了我们需要的依赖。<code>vertx-core</code> 和 <code>vert-web</code> 用于开发REST API。</li>
</ul>
<p>搞定<code>build.gradle</code>以后，我们开始写代码！</p>
<h2 id="待办事项对象">待办事项对象</h2><p>首先我们需要创建我们的数据实体对象 - <code>Todo</code> 实体。在<code>io.vertx.blueprint.todolist.entity</code>包下创建<code>Todo</code>类，并且编写以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.vertx.blueprint.todolist.entity;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.vertx.codegen.annotations.DataObject;</div><div class="line"><span class="keyword">import</span> io.vertx.core.json.JsonObject;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@DataObject</span>(generateConverter = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Todo</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger acc = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>); <span class="comment">// counter</span></div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> id;</div><div class="line">  <span class="keyword">private</span> String title;</div><div class="line">  <span class="keyword">private</span> Boolean completed;</div><div class="line">  <span class="keyword">private</span> Integer order;</div><div class="line">  <span class="keyword">private</span> String url;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Todo</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Todo</span><span class="params">(Todo other)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.id = other.id;</div><div class="line">    <span class="keyword">this</span>.title = other.title;</div><div class="line">    <span class="keyword">this</span>.completed = other.completed;</div><div class="line">    <span class="keyword">this</span>.order = other.order;</div><div class="line">    <span class="keyword">this</span>.url = other.url;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Todo</span><span class="params">(JsonObject obj)</span> </span>&#123;</div><div class="line">    TodoConverter.fromJson(obj, <span class="keyword">this</span>); <span class="comment">// 还未生成Converter的时候需要先注释掉，生成过后再取消注释</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Todo</span><span class="params">(String jsonStr)</span> </span>&#123;</div><div class="line">    TodoConverter.fromJson(<span class="keyword">new</span> JsonObject(jsonStr), <span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Todo</span><span class="params">(<span class="keyword">int</span> id, String title, Boolean completed, Integer order, String url)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.id = id;</div><div class="line">    <span class="keyword">this</span>.title = title;</div><div class="line">    <span class="keyword">this</span>.completed = completed;</div><div class="line">    <span class="keyword">this</span>.order = order;</div><div class="line">    <span class="keyword">this</span>.url = url;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> JsonObject <span class="title">toJson</span><span class="params">()</span> </span>&#123;</div><div class="line">    JsonObject json = <span class="keyword">new</span> JsonObject();</div><div class="line">    TodoConverter.toJson(<span class="keyword">this</span>, json);</div><div class="line">    <span class="keyword">return</span> json;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.id = id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIncId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.id = acc.incrementAndGet();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getIncId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> acc.get();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setIncIdWith</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">    acc.set(n);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> title;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.title = title;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">isCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> getOrElse(completed, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompleted</span><span class="params">(Boolean completed)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.completed = completed;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Integer <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> getOrElse(order, <span class="number">0</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(Integer order)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.order = order;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> url;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.url = url;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    Todo todo = (Todo) o;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (id != todo.id) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (!title.equals(todo.title)) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (completed != <span class="keyword">null</span> ? !completed.equals(todo.completed) : todo.completed != <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">return</span> order != <span class="keyword">null</span> ? order.equals(todo.order) : todo.order == <span class="keyword">null</span>;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> result = id;</div><div class="line">    result = <span class="number">31</span> * result + title.hashCode();</div><div class="line">    result = <span class="number">31</span> * result + (completed != <span class="keyword">null</span> ? completed.hashCode() : <span class="number">0</span>);</div><div class="line">    result = <span class="number">31</span> * result + (order != <span class="keyword">null</span> ? order.hashCode() : <span class="number">0</span>);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"Todo -&gt; &#123;"</span> +</div><div class="line">      <span class="string">"id="</span> + id +</div><div class="line">      <span class="string">", title='"</span> + title + <span class="string">'\''</span> +</div><div class="line">      <span class="string">", completed="</span> + completed +</div><div class="line">      <span class="string">", order="</span> + order +</div><div class="line">      <span class="string">", url='"</span> + url + <span class="string">'\''</span> +</div><div class="line">      <span class="string">'&#125;'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">getOrElse</span><span class="params">(T value, T defaultValue)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> value == <span class="keyword">null</span> ? defaultValue : value;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Todo <span class="title">merge</span><span class="params">(Todo todo)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Todo(id,</div><div class="line">      getOrElse(todo.title, title),</div><div class="line">      getOrElse(todo.completed, completed),</div><div class="line">      getOrElse(todo.order, order),</div><div class="line">      url);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们的 <code>Todo</code> 实体对象由序号<code>id</code>、标题<code>title</code>、次序<code>order</code>、地址<code>url</code>以及代表待办事项是否完成的一个标识<code>complete</code>组成。我们可以把它看作是一个简单的Java Bean。它可以被编码成JSON格式的数据，我们在后边会大量使用JSON（事实上，在Vert.x中JSON非常普遍）。同时注意到我们给<code>Todo</code>类加上了一个注解：<code>@DataObject</code>，这是用于生成JSON转换类的注解。</p>
<blockquote>
<p><code>@DataObject</code> 注解</p>
<p>被 <code>@DataObject</code> 注解的实体类需要满足以下条件：拥有一个拷贝构造函数以及一个接受一个 <code>JsonObject</code> 对象的构造函数。</p>
</blockquote>
<p>我们利用Vert.x Codegen来自动生成JSON转换类。我们需要在<code>build.gradle</code>中添加依赖：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compileOnly <span class="string">'io.vertx:vertx-codegen:3.3.3'</span></div></pre></td></tr></table></figure>
<p>由于Vert.x Codegen仅在编译期生成代码，因此我们这里使用了<code>compileOnly</code>(相当于Maven中的<code>provided</code>。需要Gradle 2.12及以上版本)。同时，我们需要在<code>io.vertx.blueprint.todolist.entity</code>包中添加<code>package-info.java</code>文件来指引Vert.x Codegen生成代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Indicates that this module contains classes that need to be generated / processed.</div><div class="line"> */</div><div class="line"><span class="meta">@ModuleGen</span>(name = <span class="string">"vertx-blueprint-todo-entity"</span>, groupPackage = <span class="string">"io.vertx.blueprint.todolist.entity"</span>)</div><div class="line"><span class="keyword">package</span> io.vertx.blueprint.todolist.entity;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.vertx.codegen.annotations.ModuleGen;</div></pre></td></tr></table></figure>
<p>Vert.x Codegen本质上是一个注解处理器(annotation processing tool)，因此我们还需要在<code>build.gradle</code>中配置apt。往里面添加以下代码：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">task</span> annotationProcessing(type: JavaCompile, <span class="keyword">group</span>: <span class="string">'build'</span>) &#123;</div><div class="line">  <span class="keyword">source</span> = <span class="keyword">sourceSets</span>.main.java</div><div class="line">  <span class="keyword">classpath</span> = <span class="keyword">configurations</span>.<span class="keyword">compile</span> + <span class="keyword">configurations</span>.compileOnly</div><div class="line">  <span class="keyword">destinationDir</span> = <span class="keyword">project</span>.<span class="keyword">file</span>(<span class="string">'src/main/generated'</span>)</div><div class="line">  <span class="keyword">options</span>.compilerArgs = [</div><div class="line">    <span class="string">"-proc:only"</span>,</div><div class="line">    <span class="string">"-processor"</span>, <span class="string">"io.vertx.codegen.CodeGenProcessor"</span>,</div><div class="line">    <span class="string">"-AoutputDirectory=$&#123;destinationDir.absolutePath&#125;"</span></div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">sourceSets</span> &#123;</div><div class="line">  main &#123;</div><div class="line">    java &#123;</div><div class="line">      srcDirs += <span class="string">'src/main/generated'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">compileJava &#123;</div><div class="line">  <span class="keyword">targetCompatibility</span> = <span class="number">1.8</span></div><div class="line">  <span class="keyword">sourceCompatibility</span> = <span class="number">1.8</span></div><div class="line"></div><div class="line">  dependsOn annotationProcessing</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样，每次我们在编译项目的时候，Vert.x Codegen都会自动检测含有 <code>@DataObject</code> 注解的类并且根据配置生成JSON转换类。在本例中，我们应该会得到一个 <code>TodoConverter</code> 类，然后我们可以在<code>Todo</code>类中使用它。</p>
<h2 id="Verticle">Verticle</h2><p>下面我们来写我们的应用组件。在<code>io.vertx.blueprint.todolist.verticles</code>包中创建<code>SingleApplicationVerticle</code>类，并编写以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.vertx.blueprint.todolist.verticles;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.vertx.core.AbstractVerticle;</div><div class="line"><span class="keyword">import</span> io.vertx.core.Future;</div><div class="line"><span class="keyword">import</span> io.vertx.redis.RedisClient;</div><div class="line"><span class="keyword">import</span> io.vertx.redis.RedisOptions;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleApplicationVerticle</span> <span class="keyword">extends</span> <span class="title">AbstractVerticle</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HTTP_HOST = <span class="string">"0.0.0.0"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REDIS_HOST = <span class="string">"127.0.0.1"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HTTP_PORT = <span class="number">8082</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REDIS_PORT = <span class="number">6379</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> RedisClient redis;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Future&lt;Void&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">      <span class="comment">// TODO with start...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们的<code>SingleApplicationVerticle</code>类继承了<code>AbstractVerticle</code>抽象类。那么什么是 <code>Verticle</code> 呢？在Vert.x中，一个<code>Verticle</code>代表应用的某一组件。我们可以通过部署<code>Verticle</code>来运行这些组件。如果你了解 <strong>Actor</strong> 模型的话，你会发现它和Actor非常类似。</p>
<p>当<code>Verticle</code>被部署的时候，其<code>start</code>方法会被调用。我们注意到这里的<code>start</code>方法接受一个类型为<code>Future&lt;Void&gt;</code>的参数，这代表了这是一个异步的初始化方法。这里的<code>Future</code>代表着<code>Verticle</code>的初始化过程是否完成。你可以通过调用Future的<code>complete</code>方法来代表初始化过程完成，或者<code>fail</code>方法代表初始化过程失败。</p>
<p>现在我们<code>Verticle</code>的轮廓已经搞好了，那么下一步也就很明了了 - 创建HTTP Client并且配置路由，处理HTTP请求。</p>
<h1 id="Vert-x_Web与REST_API">Vert.x Web与REST API</h1><h2 id="创建HTTP服务端并配置路由">创建HTTP服务端并配置路由</h2><p>我们来给<code>start</code>方法加点东西：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Future&lt;Void&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">  initData();</div><div class="line">  Router router = Router.router(vertx); <span class="comment">// &lt;1&gt;</span></div><div class="line">  <span class="comment">// CORS support</span></div><div class="line">  Set&lt;String&gt; allowHeaders = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">  allowHeaders.add(<span class="string">"x-requested-with"</span>);</div><div class="line">  allowHeaders.add(<span class="string">"Access-Control-Allow-Origin"</span>);</div><div class="line">  allowHeaders.add(<span class="string">"origin"</span>);</div><div class="line">  allowHeaders.add(<span class="string">"Content-Type"</span>);</div><div class="line">  allowHeaders.add(<span class="string">"accept"</span>);</div><div class="line">  Set&lt;HttpMethod&gt; allowMethods = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">  allowMethods.add(HttpMethod.GET);</div><div class="line">  allowMethods.add(HttpMethod.POST);</div><div class="line">  allowMethods.add(HttpMethod.DELETE);</div><div class="line">  allowMethods.add(HttpMethod.PATCH);</div><div class="line"></div><div class="line">  router.route().handler(CorsHandler.create(<span class="string">"*"</span>) <span class="comment">// &lt;2&gt;</span></div><div class="line">    .allowedHeaders(allowHeaders)</div><div class="line">    .allowedMethods(allowMethods));</div><div class="line">  router.route().handler(BodyHandler.create()); <span class="comment">// &lt;3&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">// <span class="doctag">TODO:</span>routes</span></div><div class="line"></div><div class="line">  vertx.createHttpServer() <span class="comment">// &lt;4&gt;</span></div><div class="line">    .requestHandler(router::accept)</div><div class="line">    .listen(PORT, HOST, result -&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (result.succeeded())</div><div class="line">          future.complete();</div><div class="line">        <span class="keyword">else</span></div><div class="line">          future.fail(result.cause());</div><div class="line">      &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(⊙o⊙)…一长串代码诶。。是不是看着很晕呢？我们来详细解释一下。</p>
<p>首先我们创建了一个 <code>Router</code> 实例 （1）。这里的<code>Router</code>代表路由器，相信做过Web开发的开发者们一定不会陌生。路由器负责将对应的HTTP请求分发至对应的处理逻辑（Handler）中。每个<code>Handler</code>负责处理请求并且写入回应结果。当HTTP请求到达时，对应的<code>Handler</code>会被调用。</p>
<p>然后我们创建了两个<code>Set</code>：<code>allowHeaders</code>和<code>allowMethods</code>，并且我们向里面添加了一些HTTP Header以及HTTP Method，然后我们给路由器绑定了一个<code>CorsHandler</code> （2）。<code>route()</code>方法（无参数）代表此路由匹配所有请求。这两个<code>Set</code>的作用是支持 <em>CORS</em>，因为我们的API需要开启CORS以便配合前端正常工作。有关CORS的详细内容我们就不在这里细说了，详情可以参考<a href="http://enable-cors.org/server.html" target="_blank" rel="external">这里</a>。我们这里只需要知道如何开启CORS支持即可。</p>
<p>接下来我们给路由器绑定了一个全局的<code>BodyHandler</code> （3），它的作用是处理HTTP请求正文并获取其中的数据。比如，在实现添加待办事项逻辑的时候，我们需要读取请求正文中的JSON数据，这时候我们就可以用<code>BodyHandler</code>。</p>
<p>最后，我们通过<code>vertx.createHttpServer()</code>方法来创建一个HTTP服务端 （4）。注意这个功能是Vert.x Core提供的底层功能之一。然后我们将我们的路由处理器绑定到服务端上，这也是Vert.x Web的核心。你可能不熟悉<code>router::accept</code>这样的表示，这是Java 8中的 <em>方法引用</em>，它相当于一个分发路由的<code>Handler</code>。当有请求到达时，Vert.x会调用<code>accept</code>方法。然后我们通过<code>listen</code>方法监听8082端口。因为创建服务端的过程可能失败，因此我们还需要给<code>listen</code>方法传递一个<code>Handler</code>来检查服务端是否创建成功。正如我们前面所提到的，我们可以使用<code>future.complete</code>来表示过程成功，或者用<code>future.fail</code>来表示过程失败。</p>
<p>到现在为止，我们已经创建好HTTP服务端了，但我们还没有见到任何的路由呢！不要着急，是时候去声明路由了！</p>
<h2 id="配置路由">配置路由</h2><p>下面我们来声明路由。正如我们之前提到的，我们的路由可以设计成这样：</p>
<ul>
<li>添加待办事项: <code>POST /todos</code></li>
<li>获取某一待办事项: <code>GET /todos/:todoId</code></li>
<li>获取所有待办事项: <code>GET /todos</code></li>
<li>更新待办事项: <code>PATCH /todos/:todoId</code></li>
<li>删除某一待办事项: <code>DELETE /todos/:todoId</code></li>
<li>删除所有待办事项: <code>DELETE /todos</code></li>
</ul>
<blockquote>
<p>路径参数</p>
<p>在URL中，我们可以通过<code>:name</code>的形式定义路径参数。当处理请求的时候，Vert.x会自动获取这些路径参数并允许我们访问它们。拿我们的路由举个例子，<code>/todos/19</code> 将 <code>todoId</code> 映射为 <code>19</code>。</p>
</blockquote>
<p>首先我们先在 <code>io.vertx.blueprint.todolist</code> 包下创建一个<code>Constants</code>类用于存储各种全局常量（当然也可以放到其对应的类中）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.vertx.blueprint.todolist;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Constants</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Constants</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">/** API Route */</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_GET = <span class="string">"/todos/:todoId"</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_LIST_ALL = <span class="string">"/todos"</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_CREATE = <span class="string">"/todos"</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_UPDATE = <span class="string">"/todos/:todoId"</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_DELETE = <span class="string">"/todos/:todoId"</span>;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String API_DELETE_ALL = <span class="string">"/todos"</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们将<code>start</code>方法中的<code>TODO</code>标识处替换为以下的内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// routes</span></div><div class="line">router.get(Constants.API_GET).handler(<span class="keyword">this</span>::handleGetTodo);</div><div class="line">router.get(Constants.API_LIST_ALL).handler(<span class="keyword">this</span>::handleGetAll);</div><div class="line">router.post(Constants.API_CREATE).handler(<span class="keyword">this</span>::handleCreateTodo);</div><div class="line">router.patch(Constants.API_UPDATE).handler(<span class="keyword">this</span>::handleUpdateTodo);</div><div class="line">router.delete(Constants.API_DELETE).handler(<span class="keyword">this</span>::handleDeleteOne);</div><div class="line">router.delete(Constants.API_DELETE_ALL).handler(<span class="keyword">this</span>::handleDeleteAll);</div></pre></td></tr></table></figure>
<p>代码很直观、明了。我们用对应的方法（如<code>get</code>,<code>post</code>,<code>patch</code>等等）将路由路径与路由器绑定，并且我们调用<code>handler</code>方法给每个路由绑定上对应的<code>Handler</code>，接受的<code>Handler</code>类型为<code>Handler&lt;RoutingContext&gt;</code>。这里我们分别绑定了六个方法引用，它们的形式都类似于这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们将在稍后实现这六个方法，这也是我们待办事项服务逻辑的核心。</p>
<h2 id="异步方法模式">异步方法模式</h2><p>我们之前提到过，Vert.x是 <strong>异步、非阻塞的</strong> 。每一个异步的方法总会接受一个 <code>Handler</code> 参数作为回调函数，当对应的操作完成时会调用接受的<code>Handler</code>，这是异步方法的一种实现。还有一种等价的实现是返回<code>Future</code>对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">doAsync</span><span class="params">(A a, B b, Handler&lt;R&gt; handler)</span></span>;</div><div class="line"><span class="comment">// 这两种实现等价</span></div><div class="line"><span class="function">Future&lt;R&gt; <span class="title">doAsync</span><span class="params">(A a, B b)</span></span>;</div></pre></td></tr></table></figure>
<p>其中，<code>Future</code> 对象代表着一个操作的结果，这个操作可能还没有进行，可能正在进行，可能成功也可能失败。当操作完成时，<code>Future</code>对象会得到对应的结果。我们也可以通过<code>setHandler</code>方法给<code>Future</code>绑定一个<code>Handler</code>，当<code>Future</code>被赋予结果的时候，此<code>Handler</code>会被调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Future&lt;R&gt; future = doAsync(A a, B b);</div><div class="line">future.setHandler(r -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (r.failed()) &#123;</div><div class="line">        <span class="comment">// 处理失败</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 操作结果</span></div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Vert.x中大多数异步方法都是基于Handler的。而在本教程中，这两种异步模式我们都会接触到。</p>
<h2 id="待办事项逻辑实现">待办事项逻辑实现</h2><p>现在是时候来实现我们的待办事项业务逻辑了！这里我们使用 Redis 作为数据持久化存储。有关Redis的详细介绍请参照<a href="http://redis.io/" target="_blank" rel="external">Redis 官方网站</a>。Vert.x给我们提供了一个组件—— Vert.x-redis，允许我们以异步的形式操作Redis数据。</p>
<blockquote>
<p>如何安装Redis？</p>
<p>请参照Redis官方网站上详细的<a href="http://redis.io/download#installation" target="_blank" rel="external">安装指南</a>。</p>
</blockquote>
<h3 id="Vert-x_Redis">Vert.x Redis</h3><p>Vert.x Redis允许我们以异步的形式操作Redis数据。我们首先需要在<code>build.gradle</code>中添加以下依赖：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">compile</span> <span class="string">'io.vertx:vertx-redis-client:3.3.3'</span></div></pre></td></tr></table></figure>
<p>我们通过<code>RedisClient</code>对象来操作Redis中的数据，因此我们定义了一个类成员<code>redis</code>。在使用<code>RedisClient</code>之前，我们首先需要与Redis建立连接，并且需要配置（以<code>RedisOptions</code>的形式），后边我们再讲需要配置哪些东西。</p>
<p>我们来实现 <code>initData</code> 方法用于初始化 <code>RedisClient</code> 并且测试连接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</div><div class="line">  RedisOptions config = <span class="keyword">new</span> RedisOptions()</div><div class="line">      .setHost(config().getString(<span class="string">"redis.host"</span>, REDIS_HOST)) <span class="comment">// redis host</span></div><div class="line">      .setPort(config().getInteger(<span class="string">"redis.port"</span>, REDIS_PORT)); <span class="comment">// redis port</span></div><div class="line"></div><div class="line">  <span class="keyword">this</span>.redis = RedisClient.create(vertx, config); <span class="comment">// create redis client</span></div><div class="line"></div><div class="line">  redis.hset(Constants.REDIS_TODO_KEY, <span class="string">"24"</span>, Json.encodePrettily( <span class="comment">// test connection</span></div><div class="line">    <span class="keyword">new</span> Todo(<span class="number">24</span>, <span class="string">"Something to do..."</span>, <span class="keyword">false</span>, <span class="number">1</span>, <span class="string">"todo/ex"</span>)), res -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (res.failed()) &#123;</div><div class="line">      LOGGER.error(<span class="string">"Redis service is not running!"</span>);</div><div class="line">      res.cause().printStackTrace();</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当我们在加载Verticle的时候，我们会首先调用<code>initData</code>方法，这样可以保证<code>RedisClient</code>可以被正常创建。</p>
<h3 id="存储格式">存储格式</h3><p>我们知道，Redis支持各种格式的数据，并且支持多种方式存储（如<code>list</code>、<code>hash map</code>等）。这里我们将我们的待办事项存储在 <em>哈希表(map)</em> 中。我们使用待办事项的<code>id</code>作为key，JSON格式的待办事项数据作为value。同时，我们的哈希表本身也要有个key，我们把它命名为 <em>VERT_TODO</em>，并且存储到<code>Constants</code>类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REDIS_TODO_KEY = <span class="string">"VERT_TODO"</span>;</div></pre></td></tr></table></figure>
<p>正如我们之前提到的，我们利用了生成的JSON数据转换类来实现<code>Todo</code>实体与JSON数据之间的转换（通过几个构造函数），在后面实现待办事项服务的时候可以广泛利用。</p>
<h3 id="获取/获取所有待办事项">获取/获取所有待办事项</h3><p>我们首先来实现获取待办事项的逻辑。正如我们之前所提到的，我们的处理逻辑方法需要接受一个<code>RoutingContext</code>类型的参数。我们看一下获取某一待办事项的逻辑方法(<code>handleGetTodo</code>)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleGetTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  String todoID = context.request().getParam(<span class="string">"todoId"</span>); <span class="comment">// (1)</span></div><div class="line">  <span class="keyword">if</span> (todoID == <span class="keyword">null</span>)</div><div class="line">    sendError(<span class="number">400</span>, context.response()); <span class="comment">// (2)</span></div><div class="line">  <span class="keyword">else</span> &#123;</div><div class="line">    redis.hget(Constants.REDIS_TODO_KEY, todoID, x -&gt; &#123; <span class="comment">// (3)</span></div><div class="line">      <span class="keyword">if</span> (x.succeeded()) &#123;</div><div class="line">        String result = x.result();</div><div class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>)</div><div class="line">          sendError(<span class="number">404</span>, context.response());</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">          context.response()</div><div class="line">            .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">            .end(result); <span class="comment">// (4)</span></div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span></div><div class="line">        sendError(<span class="number">503</span>, context.response());</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先我们先通过<code>getParam</code>方法获取路径参数<code>todoId</code> (1)。我们需要检测路径参数获取是否成功，如果不成功就返回 <code>400 Bad Request</code> 错误 (2)。这里我们写一个函数封装返回错误response的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendError</span><span class="params">(<span class="keyword">int</span> statusCode, HttpServerResponse response)</span> </span>&#123;</div><div class="line">  response.setStatusCode(statusCode).end();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里面，<code>end</code>方法是非常重要的。只有我们调用<code>end</code>方法时，对应的HTTP Response才能被发送回客户端。</p>
<p>再回到<code>handleGetTodo</code>方法中。如果我们成功获取到了<code>todoId</code>，我们可以通过<code>hget</code>操作从Redis中获取对应的待办事项 (3)。<code>hget</code>代表通过key从对应的哈希表中获取对应的value，我们来看一下<code>hget</code>函数的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">RedisClient <span class="title">hget</span><span class="params">(String key, String field, Handler&lt;AsyncResult&lt;String&gt;&gt; handler)</span></span>;</div></pre></td></tr></table></figure>
<p>第一个参数<code>key</code>对应哈希表的key，第二个参数<code>field</code>代表待办事项的key，第三个参数代表当获取操作成功时对应的回调。在<code>Handler</code>中，我们首先检查操作是否成功，如果不成功就返回<code>503</code>错误。如果成功了，我们就可以获取操作的结果了。结果是<code>null</code>的话，说明Redis中没有对应的待办事项，因此我们返回<code>404 Not Found</code>代表不存在。如果结果存在，那么我们就可以通过<code>end</code>方法将其写入response中 (4)。注意到我们所有的RESTful API都返回JSON格式的数据，所以我们将<code>content-type</code>头设为<code>JSON</code>。</p>
<p>获取所有待办事项的逻辑<code>handleGetAll</code>与<code>handleGetTodo</code>大体上类似，但实现上有些许不同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleGetAll</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  redis.hvals(Constants.REDIS_TODO_KEY, res -&gt; &#123; <span class="comment">// (1)</span></div><div class="line">    <span class="keyword">if</span> (res.succeeded()) &#123;</div><div class="line">      String encoded = Json.encodePrettily(res.result().stream() <span class="comment">// (2)</span></div><div class="line">        .map(x -&gt; <span class="keyword">new</span> Todo((String) x))</div><div class="line">        .collect(Collectors.toList()));</div><div class="line">      context.response()</div><div class="line">        .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">        .end(encoded); <span class="comment">// (3)</span></div><div class="line">    &#125; <span class="keyword">else</span></div><div class="line">      sendError(<span class="number">503</span>, context.response());</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我们通过<code>hvals</code>操作 (1) 来获取某个哈希表中的所有数据（以JSON数组的形式返回，即<code>JsonArray</code>对象）。在Handler中我们还是像之前那样先检查操作是否成功。如果成功的话我们就可以将结果写入response了。注意这里我们不能直接将返回的<code>JsonArray</code>写入response。想象一下返回的<code>JsonArray</code>包括着待办事项的key以及对应的JSON数据（字符串形式），因此此时每个待办事项对应的JSON数据都被转义了，所以我们需要先把这些转义过的JSON数据转换成实体对象，再重新编码。</p>
<p>我们这里采用了一种响应式编程思想的方法。首先我们了解到<code>JsonArray</code>类继承了<code>Iterable&lt;Object&gt;</code>接口（是不是感觉它很像<code>List</code>呢？），因此我们可以通过<code>stream</code>方法将其转化为<code>Stream</code>对象。注意这里的<code>Stream</code>可不是传统意义上讲的输入输出流(I/O stream)，而是数据流(data flow)。我们需要对数据流进行一系列的变换处理操作，这就是响应式编程的思想（也有点函数式编程的思想）。我们将数据流中的每个字符串数据转换为<code>Todo</code>实体对象，这个过程是通过<code>map</code>算子实现的。我们这里就不深入讨论<code>map</code>算子了，但它在函数式编程中非常重要。在<code>map</code>过后，我们通过<code>collect</code>方法将数据流“归约”成<code>List&lt;Todo&gt;</code>。现在我们就可以通过<code>Json.encodePrettily</code>方法对得到的list进行编码了，转换成JSON格式的数据。最后我们将转换后的结果写入到response中 (3)。</p>
<h3 id="创建待办事项">创建待办事项</h3><p>经过了上面两个业务逻辑实现的过程，你应该开始熟悉Vert.x了～现在我们来实现创建待办事项的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">final</span> Todo todo = wrapObject(<span class="keyword">new</span> Todo(context.getBodyAsString()), context);</div><div class="line">    <span class="keyword">final</span> String encoded = Json.encodePrettily(todo);</div><div class="line">    redis.hset(Constants.REDIS_TODO_KEY, String.valueOf(todo.getId()),</div><div class="line">      encoded, res -&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (res.succeeded())</div><div class="line">          context.response()</div><div class="line">            .setStatusCode(<span class="number">201</span>)</div><div class="line">            .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">            .end(encoded);</div><div class="line">        <span class="keyword">else</span></div><div class="line">          sendError(<span class="number">503</span>, context.response());</div><div class="line">      &#125;);</div><div class="line">  &#125; <span class="keyword">catch</span> (DecodeException e) &#123;</div><div class="line">    sendError(<span class="number">400</span>, context.response());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先我们通过<code>context.getBodyAsString()</code>方法来从请求正文中获取JSON数据并转换成<code>Todo</code>实体对象 (1)。这里我们包装了一个处理<code>Todo</code>实例的方法，用于给其添加必要的信息（如URL）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Todo <span class="title">wrapObject</span><span class="params">(Todo todo, RoutingContext context)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> id = todo.getId();</div><div class="line">  <span class="keyword">if</span> (id &gt; Todo.getIncId()) &#123;</div><div class="line">    Todo.setIncIdWith(id);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="number">0</span>)</div><div class="line">    todo.setIncId();</div><div class="line">  todo.setUrl(context.request().absoluteURI() + <span class="string">"/"</span> + todo.getId());</div><div class="line">  <span class="keyword">return</span> todo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于没有ID（或者为默认ID）的待办事项，我们会给它分配一个ID。这里我们采用了自增ID的策略，通过<code>AtomicInteger</code>来实现。</p>
<p>然后我们通过<code>Json.encodePrettily</code>方法将我们的<code>Todo</code>实例再次编码成JSON格式的数据 (2)。接下来我们利用<code>hset</code>函数将待办事项实例插入到对应的哈希表中 (3)。如果插入成功，返回 <code>201</code> 状态码 (4)。</p>
<p>[NOTE 201 状态码? | 正如你所看到的那样，我们将状态码设为<code>201</code>，这代表<code>CREATED</code>（已创建）。另外，如果不指定状态码的话，Vert.x Web默认将状态码设为 <code>200 OK</code>。]</p>
<p>同时，我们接收到的HTTP请求首部可能格式不正确，因此我们需要在方法中捕获<code>DecodeException</code>异常。这样一旦捕获到<code>DecodeException</code>异常，我们就返回<code>400 Bad Request</code>状态码。</p>
<h3 id="更新待办事项">更新待办事项</h3><p>如果你想改变你的计划，你就需要更新你的待办事项。我们来实现更新待办事项的逻辑，它有点小复杂（或者说是，繁琐？）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PATCH /todos/:todoId</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleUpdateTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    String todoID = context.request().getParam(<span class="string">"todoId"</span>); <span class="comment">// (1)</span></div><div class="line">    <span class="keyword">final</span> Todo newTodo = <span class="keyword">new</span> Todo(context.getBodyAsString()); <span class="comment">// (2)</span></div><div class="line">    <span class="comment">// handle error</span></div><div class="line">    <span class="keyword">if</span> (todoID == <span class="keyword">null</span> || newTodo == <span class="keyword">null</span>) &#123;</div><div class="line">      sendError(<span class="number">400</span>, context.response());</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    redis.hget(Constants.REDIS_TODO_KEY, todoID, x -&gt; &#123; <span class="comment">// (3)</span></div><div class="line">      <span class="keyword">if</span> (x.succeeded()) &#123;</div><div class="line">        String result = x.result();</div><div class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>)</div><div class="line">          sendError(<span class="number">404</span>, context.response()); <span class="comment">// (4)</span></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">          Todo oldTodo = <span class="keyword">new</span> Todo(result);</div><div class="line">          String response = Json.encodePrettily(oldTodo.merge(newTodo)); <span class="comment">// (5)</span></div><div class="line">          redis.hset(Constants.REDIS_TODO_KEY, todoID, response, res -&gt; &#123; <span class="comment">// (6)</span></div><div class="line">            <span class="keyword">if</span> (res.succeeded()) &#123;</div><div class="line">              context.response()</div><div class="line">                .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">                .end(response); <span class="comment">// (7)</span></div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span></div><div class="line">        sendError(<span class="number">503</span>, context.response());</div><div class="line">    &#125;);</div><div class="line">  &#125; <span class="keyword">catch</span> (DecodeException e) &#123;</div><div class="line">    sendError(<span class="number">400</span>, context.response());</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>唔。。。一大长串代码诶。。。我们来看一下。首先我们从 <code>RoutingContext</code> 中获取路径参数 <code>todoId</code> (1)，这是我们想要更改待办事项对应的id。然后我们从请求正文中获取新的待办事项数据 (2)。这一步也有可能抛出 <code>DecodeException</code> 异常因此我们也需要去捕获它。要更新待办事项，我们需要先通过<code>hget</code>函数获取之前的待办事项 (3)，检查其是否存在。获取旧的待办事项之后，我们调用之前在<code>Todo</code>类中实现的<code>merge</code>方法将旧待办事项与新待办事项整合到一起 (5)，然后编码成JSON格式的数据。然后我们通过<code>hset</code>函数更新对应的待办事项 (6)（<code>hset</code>表示如果不存在就插入，存在就更新）。操作成功的话，返回 <code>200 OK</code> 状态。</p>
<p>这就是更新待办事项的逻辑～要有耐心哟，我们马上就要见到胜利的曙光了～下面我们来实现删除待办事项的逻辑。</p>
<h3 id="删除/删除全部待办事项">删除/删除全部待办事项</h3><p>删除待办事项的逻辑非常简单。我们利用<code>hdel</code>函数来删除某一待办事项，用<code>del</code>函数删掉所有待办事项（实际上是直接把那个哈希表给删了）。如果删除操作成功，返回<code>204 No Content</code> 状态。</p>
<p>这里直接给出代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleDeleteOne</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  String todoID = context.request().getParam(<span class="string">"todoId"</span>);</div><div class="line">  redis.hdel(Constants.REDIS_TODO_KEY, todoID, res -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (res.succeeded())</div><div class="line">      context.response().setStatusCode(<span class="number">204</span>).end();</div><div class="line">    <span class="keyword">else</span></div><div class="line">      sendError(<span class="number">503</span>, context.response());</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleDeleteAll</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  redis.del(Constants.REDIS_TODO_KEY, res -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (res.succeeded())</div><div class="line">      context.response().setStatusCode(<span class="number">204</span>).end();</div><div class="line">    <span class="keyword">else</span></div><div class="line">      sendError(<span class="number">503</span>, context.response());</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>啊哈！我们实现待办事项服务的Verticle已经完成咯～一颗赛艇！但是我们该如何去运行我们的<code>Verticle</code>呢？答案是，我们需要 <em>部署并运行</em> 我们的Verticle。还好Vert.x提供了一个运行Verticle的辅助工具：Vert.x Launcher，让我们来看看如何利用它。</p>
<h2 id="将应用与Vert-x_Launcher一起打包">将应用与Vert.x Launcher一起打包</h2><p>要通过Vert.x Launcher来运行Verticle，我们需要在<code>build.gradle</code>中配置一下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">jar &#123;</div><div class="line">  <span class="comment">// by default fat jar</span></div><div class="line">  archiveName = <span class="string">'vertx-blueprint-todo-backend-fat.jar'</span></div><div class="line">  <span class="keyword">from</span> &#123; <span class="keyword">configurations</span>.<span class="keyword">compile</span>.<span class="keyword">collect</span> &#123; it.isDirectory() ? it : zipTree(it) &#125; &#125;</div><div class="line">  manifest &#123;</div><div class="line">      attributes <span class="string">'Main-Class'</span>: <span class="string">'io.vertx.core.Launcher'</span></div><div class="line">      attributes <span class="string">'Main-Verticle'</span>: <span class="string">'io.vertx.blueprint.todolist.verticles.SingleApplicationVerticle'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>在<code>jar</code>区块中，我们配置Gradle使其生成 <strong>fat-jar</strong>，并指定启动类。<em>fat-jar</em> 是一个给Vert.x应用打包的简便方法，它直接将我们的应用连同所有的依赖都给打包到jar包中去了，这样我们可以直接通过jar包运行我们的应用而不必再指定依赖的 <code>CLASSPATH</code></li>
<li>我们将<code>Main-Class</code>属性设为<code>io.vertx.core.Launcher</code>，这样就可以通过Vert.x Launcher来启动对应的Verticle了。另外我们需要将<code>Main-Verticle</code>属性设为我们想要部署的Verticle的类名（全名）。</li>
</ul>
<p>配置好了以后，我们就可以打包了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle build</div></pre></td></tr></table></figure>
<h2 id="运行我们的服务">运行我们的服务</h2><p>万事俱备，只欠东风。是时候运行我们的待办事项服务了！首先我们先启动Redis服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redis-server</div></pre></td></tr></table></figure>
<p>然后运行服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar build/libs/vertx-blueprint-todo-backend-fat.jar</div></pre></td></tr></table></figure>
<p>如果没问题的话，你将会在终端中看到 <code>Succeeded in deploying verticle</code> 的字样。下面我们可以自由测试我们的API了，其中最简便的方法是借助 <a href="https://github.com/TodoBackend/todo-backend-js-spec" target="_blank" rel="external">todo-backend-js-spec</a> 来测试。</p>
<p>键入 <code>http://127.0.0.1:8082/todos</code>：</p>
<p><img src="https://github.com/sczyh30/vertx-blueprint-todo-backend/raw/master/docs/img/todo-test-input.png" alt=""></p>
<p>测试结果：</p>
<p><img src="https://github.com/sczyh30/vertx-blueprint-todo-backend/raw/master/docs/img/todo-test-result.png" alt=""></p>
<p>当然，我们也可以用其它工具，比如 <code>curl</code> ：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">sczyh30@sczyh30-workshop:~$ curl http://127.0.0.1:8082/todos</div><div class="line">[ &#123;</div><div class="line">  "id" : 20578623,</div><div class="line">  "title" : "blah",</div><div class="line">  "completed" : false,</div><div class="line">  "order" : 95,</div><div class="line">  "url" : "http://127.0.0.1:8082/todos/20578623"</div><div class="line">&#125;, &#123;</div><div class="line">  "id" : 1744802607,</div><div class="line">  "title" : "blah",</div><div class="line">  "completed" : false,</div><div class="line">  "order" : 523,</div><div class="line">  "url" : "http://127.0.0.1:8082/todos/1744802607"</div><div class="line">&#125;, &#123;</div><div class="line">  "id" : 981337975,</div><div class="line">  "title" : "blah",</div><div class="line">  "completed" : false,</div><div class="line">  "order" : 95,</div><div class="line">  "url" : "http://127.0.0.1:8082/todos/981337975"</div><div class="line">&#125; ]</div></pre></td></tr></table></figure>
<h1 id="将服务与控制器分离">将服务与控制器分离</h1><p>啊哈～我们的待办事项服务已经可以正常运行了，但是回头再来看看 <code>SingleApplicationVerticle</code> 类的代码，你会发现它非常混乱，待办事项业务逻辑与控制器混杂在一起，让这个类非常的庞大，并且这也不利于我们服务的扩展。根据面向对象解耦的思想，我们需要将控制器部分与业务逻辑部分分离。</p>
<h2 id="用Future实现异步服务">用Future实现异步服务</h2><p>下面我们来设计我们的业务逻辑层。就像我们之前提到的那样，我们的服务需要是异步的，因此这些服务的方法要么需要接受一个<code>Handler</code>参数作为回调，要么需要返回一个<code>Future</code>对象。但是想象一下很多个<code>Handler</code>混杂在一起嵌套的情况，你会陷入 <em>回调地狱</em>，这是非常糟糕的。因此，这里我们用<code>Future</code>实现我们的待办事项服务。</p>
<p>在 <code>io.vertx.blueprint.todolist.service</code> 包下创建 <code>TodoService</code> 接口并且编写以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.vertx.blueprint.todolist.service;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.vertx.blueprint.todolist.entity.Todo;</div><div class="line"><span class="keyword">import</span> io.vertx.core.Future;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Optional;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TodoService</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function">Future&lt;Boolean&gt; <span class="title">initData</span><span class="params">()</span></span>; <span class="comment">// 初始化数据（或数据库）</span></div><div class="line"></div><div class="line">  <span class="function">Future&lt;Boolean&gt; <span class="title">insert</span><span class="params">(Todo todo)</span></span>;</div><div class="line"></div><div class="line">  Future&lt;List&lt;Todo&gt;&gt; getAll();</div><div class="line"></div><div class="line">  Future&lt;Optional&lt;Todo&gt;&gt; getCertain(String todoID);</div><div class="line"></div><div class="line">  <span class="function">Future&lt;Todo&gt; <span class="title">update</span><span class="params">(String todoId, Todo newTodo)</span></span>;</div><div class="line"></div><div class="line">  <span class="function">Future&lt;Boolean&gt; <span class="title">delete</span><span class="params">(String todoId)</span></span>;</div><div class="line"></div><div class="line">  <span class="function">Future&lt;Boolean&gt; <span class="title">deleteAll</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意到<code>getCertain</code>方法返回一个<code>Future&lt;Optional&lt;Todo&gt;&gt;</code>对象。那么<code>Optional</code>是啥呢？它封装了一个可能为空的对象。因为数据库里面可能没有与我们给定的<code>todoId</code>相对应的待办事项，查询的结果可能为空，因此我们给它包装上 <code>Optional</code>。<code>Optional</code> 可以避免万恶的 <code>NullPointerException</code>，并且它在函数式编程中用途特别广泛（在Haskell中对应 <strong>Maybe Monad</strong>）。</p>
<p>既然我们已经设计好我们的异步服务接口了，让我们来重构原先的Verticle吧！</p>
<h2 id="开始重构！">开始重构！</h2><p>我们创建一个新的Verticle。在 <code>io.vertx.blueprint.todolist.verticles</code> 包中创建 <code>TodoVerticle</code> 类，并编写以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.vertx.blueprint.todolist.verticles;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.vertx.blueprint.todolist.Constants;</div><div class="line"><span class="keyword">import</span> io.vertx.blueprint.todolist.entity.Todo;</div><div class="line"><span class="keyword">import</span> io.vertx.blueprint.todolist.service.TodoService;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.vertx.core.AbstractVerticle;</div><div class="line"><span class="keyword">import</span> io.vertx.core.AsyncResult;</div><div class="line"><span class="keyword">import</span> io.vertx.core.Future;</div><div class="line"><span class="keyword">import</span> io.vertx.core.Handler;</div><div class="line"><span class="keyword">import</span> io.vertx.core.http.HttpMethod;</div><div class="line"><span class="keyword">import</span> io.vertx.core.http.HttpServerResponse;</div><div class="line"><span class="keyword">import</span> io.vertx.core.json.DecodeException;</div><div class="line"><span class="keyword">import</span> io.vertx.core.json.Json;</div><div class="line"><span class="keyword">import</span> io.vertx.ext.web.Router;</div><div class="line"><span class="keyword">import</span> io.vertx.ext.web.RoutingContext;</div><div class="line"><span class="keyword">import</span> io.vertx.ext.web.handler.BodyHandler;</div><div class="line"><span class="keyword">import</span> io.vertx.ext.web.handler.CorsHandler;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashSet;</div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"><span class="keyword">import</span> java.util.function.Consumer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TodoVerticle</span> <span class="keyword">extends</span> <span class="title">AbstractVerticle</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">"0.0.0.0"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">8082</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> TodoService service;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Future&lt;Void&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Router router = Router.router(vertx);</div><div class="line">    <span class="comment">// CORS support</span></div><div class="line">    Set&lt;String&gt; allowHeaders = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">    allowHeaders.add(<span class="string">"x-requested-with"</span>);</div><div class="line">    allowHeaders.add(<span class="string">"Access-Control-Allow-Origin"</span>);</div><div class="line">    allowHeaders.add(<span class="string">"origin"</span>);</div><div class="line">    allowHeaders.add(<span class="string">"Content-Type"</span>);</div><div class="line">    allowHeaders.add(<span class="string">"accept"</span>);</div><div class="line">    Set&lt;HttpMethod&gt; allowMethods = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">    allowMethods.add(HttpMethod.GET);</div><div class="line">    allowMethods.add(HttpMethod.POST);</div><div class="line">    allowMethods.add(HttpMethod.DELETE);</div><div class="line">    allowMethods.add(HttpMethod.PATCH);</div><div class="line"></div><div class="line">    router.route().handler(BodyHandler.create());</div><div class="line">    router.route().handler(CorsHandler.create(<span class="string">"*"</span>)</div><div class="line">      .allowedHeaders(allowHeaders)</div><div class="line">      .allowedMethods(allowMethods));</div><div class="line"></div><div class="line">    <span class="comment">// routes</span></div><div class="line">    router.get(Constants.API_GET).handler(<span class="keyword">this</span>::handleGetTodo);</div><div class="line">    router.get(Constants.API_LIST_ALL).handler(<span class="keyword">this</span>::handleGetAll);</div><div class="line">    router.post(Constants.API_CREATE).handler(<span class="keyword">this</span>::handleCreateTodo);</div><div class="line">    router.patch(Constants.API_UPDATE).handler(<span class="keyword">this</span>::handleUpdateTodo);</div><div class="line">    router.delete(Constants.API_DELETE).handler(<span class="keyword">this</span>::handleDeleteOne);</div><div class="line">    router.delete(Constants.API_DELETE_ALL).handler(<span class="keyword">this</span>::handleDeleteAll);</div><div class="line"></div><div class="line">    vertx.createHttpServer()</div><div class="line">      .requestHandler(router::accept)</div><div class="line">      .listen(PORT, HOST, result -&gt; &#123;</div><div class="line">          <span class="keyword">if</span> (result.succeeded())</div><div class="line">            future.complete();</div><div class="line">          <span class="keyword">else</span></div><div class="line">            future.fail(result.cause());</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    initData();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleGetTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleGetAll</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleUpdateTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleDeleteOne</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    <span class="comment">// TODO</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleDeleteAll</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">     <span class="comment">// TODO</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendError</span><span class="params">(<span class="keyword">int</span> statusCode, HttpServerResponse response)</span> </span>&#123;</div><div class="line">    response.setStatusCode(statusCode).end();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">badRequest</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    context.response().setStatusCode(<span class="number">400</span>).end();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notFound</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    context.response().setStatusCode(<span class="number">404</span>).end();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceUnavailable</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    context.response().setStatusCode(<span class="number">503</span>).end();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> Todo <span class="title">wrapObject</span><span class="params">(Todo todo, RoutingContext context)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> id = todo.getId();</div><div class="line">    <span class="keyword">if</span> (id &gt; Todo.getIncId()) &#123;</div><div class="line">      Todo.setIncIdWith(id);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="number">0</span>)</div><div class="line">      todo.setIncId();</div><div class="line">    todo.setUrl(context.request().absoluteURI() + <span class="string">"/"</span> + todo.getId());</div><div class="line">    <span class="keyword">return</span> todo;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很熟悉吧？这个<code>Verticle</code>的结构与我们之前的Verticle相类似，这里就不多说了。下面我们来利用我们之前编写的服务接口实现每一个控制器方法。</p>
<p>首先先实现 <code>initData</code> 方法，此方法用于初始化存储结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> String serviceType = config().getString(<span class="string">"service.type"</span>, <span class="string">"redis"</span>);</div><div class="line">  LOGGER.info(<span class="string">"Service Type: "</span> + serviceType);</div><div class="line">  <span class="keyword">switch</span> (serviceType) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">"jdbc"</span>:</div><div class="line">      service = <span class="keyword">new</span> JdbcTodoService(vertx, config());</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="string">"redis"</span>:</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      RedisOptions config = <span class="keyword">new</span> RedisOptions()</div><div class="line">        .setHost(config().getString(<span class="string">"redis.host"</span>, <span class="string">"127.0.0.1"</span>))</div><div class="line">        .setPort(config().getInteger(<span class="string">"redis.port"</span>, <span class="number">6379</span>));</div><div class="line">      service = <span class="keyword">new</span> RedisTodoService(vertx, config);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  service.initData().setHandler(res -&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (res.failed()) &#123;</div><div class="line">        LOGGER.error(<span class="string">"Persistence service is not running!"</span>);</div><div class="line">        res.cause().printStackTrace();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先我们从配置中获取服务的类型，这里我们有两种类型的服务：<code>redis</code>和<code>jdbc</code>，默认是<code>redis</code>。接着我们会根据服务的类型以及对应的配置来创建服务。在这里，我们的配置都是从JSON格式的配置文件中读取，并通过Vert.x Launcher的<code>-conf</code>项加载。后面我们再讲要配置哪些东西。</p>
<p>接着我们给<code>service.initData()</code>方法返回的<code>Future</code>对象绑定了一个<code>Handler</code>，这个<code>Handler</code>将会在<code>Future</code>得到结果的时候被调用。一旦初始化过程失败，错误信息将会显示到终端上。</p>
<p>其它的方法实现也类似，这里就不详细解释了，直接放上代码，非常简洁明了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Wrap the result handler with failure handler (503 Service Unavailable)</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> &lt;T&gt; Handler&lt;AsyncResult&lt;T&gt;&gt; resultHandler(RoutingContext context, Consumer&lt;T&gt; consumer) &#123;</div><div class="line">  <span class="keyword">return</span> res -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (res.succeeded()) &#123;</div><div class="line">      consumer.accept(res.result());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      serviceUnavailable(context);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">final</span> Todo todo = wrapObject(<span class="keyword">new</span> Todo(context.getBodyAsString()), context);</div><div class="line">    <span class="keyword">final</span> String encoded = Json.encodePrettily(todo);</div><div class="line"></div><div class="line">    service.insert(todo).setHandler(resultHandler(context, res -&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (res) &#123;</div><div class="line">        context.response()</div><div class="line">          .setStatusCode(<span class="number">201</span>)</div><div class="line">          .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">          .end(encoded);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        serviceUnavailable(context);</div><div class="line">      &#125;</div><div class="line">    &#125;));</div><div class="line">  &#125; <span class="keyword">catch</span> (DecodeException e) &#123;</div><div class="line">    sendError(<span class="number">400</span>, context.response());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleGetTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  String todoID = context.request().getParam(<span class="string">"todoId"</span>);</div><div class="line">  <span class="keyword">if</span> (todoID == <span class="keyword">null</span>) &#123;</div><div class="line">    sendError(<span class="number">400</span>, context.response());</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  service.getCertain(todoID).setHandler(resultHandler(context, res -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (!res.isPresent())</div><div class="line">      notFound(context);</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">final</span> String encoded = Json.encodePrettily(res.get());</div><div class="line">      context.response()</div><div class="line">        .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">        .end(encoded);</div><div class="line">    &#125;</div><div class="line">  &#125;));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleGetAll</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  service.getAll().setHandler(resultHandler(context, res -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</div><div class="line">      serviceUnavailable(context);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">final</span> String encoded = Json.encodePrettily(res);</div><div class="line">      context.response()</div><div class="line">        .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">        .end(encoded);</div><div class="line">    &#125;</div><div class="line">  &#125;));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleUpdateTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    String todoID = context.request().getParam(<span class="string">"todoId"</span>);</div><div class="line">    <span class="keyword">final</span> Todo newTodo = <span class="keyword">new</span> Todo(context.getBodyAsString());</div><div class="line">    <span class="comment">// handle error</span></div><div class="line">    <span class="keyword">if</span> (todoID == <span class="keyword">null</span>) &#123;</div><div class="line">      sendError(<span class="number">400</span>, context.response());</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    service.update(todoID, newTodo)</div><div class="line">      .setHandler(resultHandler(context, res -&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (res == <span class="keyword">null</span>)</div><div class="line">          notFound(context);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">final</span> String encoded = Json.encodePrettily(res);</div><div class="line">          context.response()</div><div class="line">            .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">            .end(encoded);</div><div class="line">        &#125;</div><div class="line">      &#125;));</div><div class="line">  &#125; <span class="keyword">catch</span> (DecodeException e) &#123;</div><div class="line">    badRequest(context);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Handler&lt;AsyncResult&lt;Boolean&gt;&gt; deleteResultHandler(RoutingContext context) &#123;</div><div class="line">  <span class="keyword">return</span> res -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (res.succeeded()) &#123;</div><div class="line">      <span class="keyword">if</span> (res.result()) &#123;</div><div class="line">        context.response().setStatusCode(<span class="number">204</span>).end();</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        serviceUnavailable(context);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      serviceUnavailable(context);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleDeleteOne</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  String todoID = context.request().getParam(<span class="string">"todoId"</span>);</div><div class="line">  service.delete(todoID)</div><div class="line">    .setHandler(deleteResultHandler(context));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleDeleteAll</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">  service.deleteAll()</div><div class="line">    .setHandler(deleteResultHandler(context));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>是不是和之前的Verticle很相似呢？这里我们还封装了两个<code>Handler</code>生成器：<code>resultHandler</code> 和 <code>deleteResultHandler</code>。这两个生成器封装了一些重复的代码，可以减少代码量。</p>
<p>嗯。。。我们的新Verticle写好了，那么是时候去实现具体的业务逻辑了。这里我们会实现两个版本的业务逻辑，分别对应两种存储：<strong>Redis</strong> 和 <strong>MySQL</strong>。</p>
<h2 id="Vert-x-Redis版本的待办事项服务">Vert.x-Redis版本的待办事项服务</h2><p>之前我们已经实现过一遍Redis版本的服务了，因此你应该对其非常熟悉了。这里我们仅仅解释一个 <code>update</code> 方法，其它的实现都非常类似，代码可以在<a href="https://github.com/sczyh30/vertx-blueprint-todo-backend/blob/master/src/main/java/io/vertx/blueprint/todolist/service/RedisTodoService.java" target="_blank" rel="external">GitHub</a>上浏览。</p>
<h3 id="Monadic_Future">Monadic Future</h3><p>回想一下我们之前写的更新待办事项的逻辑，我们会发现它其实是由两个独立的操作组成 - <code>get</code> 和 <code>insert</code>（对于Redis来说）。所以呢，我们可不可以复用 <code>getCertain</code> 和 <code>insert</code> 这两个方法？当然了！因为<code>Future</code>是可组合的，因此我们可以将这两个方法返回的<code>Future</code>组合到一起。是不是非常方便呢？我们来编写此方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Future&lt;Todo&gt; <span class="title">update</span><span class="params">(String todoId, Todo newTodo)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.getCertain(todoId).compose(old -&gt; &#123; <span class="comment">// (1)</span></div><div class="line">    <span class="keyword">if</span> (old.isPresent()) &#123;</div><div class="line">      Todo fnTodo = old.get().merge(newTodo);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.insert(fnTodo)</div><div class="line">        .map(r -&gt; r ? fnTodo : <span class="keyword">null</span>); <span class="comment">// (2)</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> Future.succeededFuture(); <span class="comment">// (3)</span></div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先我们调用了<code>getCertain</code>方法，此方法返回一个<code>Future&lt;Optional&lt;Todo&gt;&gt;</code>对象。同时我们使用<code>compose</code>函数将此方法返回的<code>Future</code>与另一个<code>Future</code>进行组合（1），其中<code>compose</code>函数接受一个<code>T =&gt; Future&lt;U&gt;</code>类型的lambda。然后我们接着检查旧的待办事项是否存在，如果存在的话，我们将新的待办事项与旧的待办事项相融合，然后更新待办事项。注意到<code>insert</code>方法返回<code>Future&lt;Boolean&gt;</code>类型的<code>Future</code>，因此我们还需要对此Future的结果做变换，这个变换的过程是通过<code>map</code>函数实现的（2）。<code>map</code>函数接受一个<code>T =&gt; U</code>类型的lambda。如果旧的待办事项不存在，我们返回一个包含null的<code>Future</code>（3）。最后我们返回组合后的<code>Future</code>对象。</p>
<blockquote>
<p><code>Future</code> 的本质</p>
<p>在函数式编程中，<code>Future</code> 实际上是一种 <code>Monad</code>。有关<code>Monad</code>的理论较为复杂，这里就不进行阐述了。你可以简单地把它看作是一个可以进行变换(<code>map</code>)和组合(<code>compose</code>)的包装对象。我们把这种特性叫做 <strong>monadic</strong>。</p>
</blockquote>
<p>下面来实现MySQL版本的待办事项服务。</p>
<h2 id="Vert-x-JDBC版本的待办事项服务">Vert.x-JDBC版本的待办事项服务</h2><h3 id="JDBC_++_异步">JDBC ++ 异步</h3><p>我们使用Vert.x-JDBC和MySQL来实现JDBC版本的待办事项服务。我们知道，数据库操作都是阻塞操作，很可能会占用不少时间。而Vert.x-JDBC提供了一种异步操作数据库的模式，很神奇吧？所以，在传统JDBC代码下我们要执行SQL语句需要这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String SQL = <span class="string">"SELECT * FROM todo"</span>;</div><div class="line"><span class="comment">// ...</span></div><div class="line">ResultSet rs = pstmt.executeQuery(SQL);</div></pre></td></tr></table></figure>
<p>而在Vert.x JDBC中，我们可以利用回调获取数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">connection.query(SQL, result -&gt; &#123;</div><div class="line">    <span class="comment">// do something with result...</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这种异步操作可以有效避免对数据的等待。当数据获取成功时会自动调用回调函数来执行处理数据的逻辑。</p>
<h3 id="添加依赖">添加依赖</h3><p>首先我们需要向<code>build.gradle</code>文件中添加依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">compile <span class="string">'io.vertx:vertx-jdbc-client:3.3.3'</span></div><div class="line">compile <span class="string">'mysql:mysql-connector-java:6.0.2'</span></div></pre></td></tr></table></figure>
<p>其中第二个依赖是MySQL的驱动，如果你想使用其他的数据库，你需要自行替换掉这个依赖。</p>
<h3 id="初始化JDBCClient">初始化JDBCClient</h3><p>在Vert.x JDBC中，我们需要从一个<code>JDBCClient</code>对象中获取数据库连接，因此我们来看一下如何创建<code>JDBCClient</code>实例。在<code>io.vertx.blueprint.todolist.service</code>包下创建<code>JdbcTodoService</code>类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.vertx.blueprint.todolist.service;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.vertx.blueprint.todolist.entity.Todo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.vertx.core.Future;</div><div class="line"><span class="keyword">import</span> io.vertx.core.Vertx;</div><div class="line"><span class="keyword">import</span> io.vertx.core.json.JsonArray;</div><div class="line"><span class="keyword">import</span> io.vertx.core.json.JsonObject;</div><div class="line"><span class="keyword">import</span> io.vertx.ext.jdbc.JDBCClient;</div><div class="line"><span class="keyword">import</span> io.vertx.ext.sql.SQLConnection;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Optional;</div><div class="line"><span class="keyword">import</span> java.util.stream.Collectors;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTodoService</span> <span class="keyword">implements</span> <span class="title">TodoService</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Vertx vertx;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> JsonObject config;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> JDBCClient client;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JdbcTodoService</span><span class="params">(JsonObject config)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(Vertx.vertx(), config);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JdbcTodoService</span><span class="params">(Vertx vertx, JsonObject config)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.vertx = vertx;</div><div class="line">    <span class="keyword">this</span>.config = config;</div><div class="line">    <span class="keyword">this</span>.client = JDBCClient.createShared(vertx, config);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们使用<code>JDBCClient.createShared(vertx, config)</code>方法来创建一个<code>JDBCClient</code>实例，其中我们传入一个<code>JsonObject</code>对象作为配置。一般来说，我们需要配置以下的内容：</p>
<ul>
<li><em>url</em> - JDBC URL，比如 <code>jdbc:mysql://localhost/vertx_blueprint</code></li>
<li><em>driver_class</em> - JDBC驱动名称，比如 <code>com.mysql.cj.jdbc.Driver</code></li>
<li><em>user</em> - 数据库用户</li>
<li><em>password</em> - 数据库密码</li>
</ul>
<p>我们将会通过Vert.x Launcher从配置文件中读取此<code>JsonObject</code>。</p>
<p>现在我们已经创建了<code>JDBCClient</code>实例了，下面我们需要在MySQL中建这样一个表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`todo`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`title`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`completed`</span> TINYINT(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`order`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`url`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">)</div></pre></td></tr></table></figure>
<p>我们把要用到的数据库语句都存到服务类中（这里我们就不讨论如何设计表以及写SQL了）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SQL_CREATE = <span class="string">"CREATE TABLE IF NOT EXISTS `todo` (\n"</span> +</div><div class="line">  <span class="string">"  `id` int(11) NOT NULL AUTO_INCREMENT,\n"</span> +</div><div class="line">  <span class="string">"  `title` varchar(255) DEFAULT NULL,\n"</span> +</div><div class="line">  <span class="string">"  `completed` tinyint(1) DEFAULT NULL,\n"</span> +</div><div class="line">  <span class="string">"  `order` int(11) DEFAULT NULL,\n"</span> +</div><div class="line">  <span class="string">"  `url` varchar(255) DEFAULT NULL,\n"</span> +</div><div class="line">  <span class="string">"  PRIMARY KEY (`id`) )"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SQL_INSERT = <span class="string">"INSERT INTO `todo` "</span> +</div><div class="line">  <span class="string">"(`id`, `title`, `completed`, `order`, `url`) VALUES (?, ?, ?, ?, ?)"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SQL_QUERY = <span class="string">"SELECT * FROM todo WHERE id = ?"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SQL_QUERY_ALL = <span class="string">"SELECT * FROM todo"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SQL_UPDATE = <span class="string">"UPDATE `todo`\n"</span> +</div><div class="line">  <span class="string">"SET `id` = ?,\n"</span> +</div><div class="line">  <span class="string">"`title` = ?,\n"</span> +</div><div class="line">  <span class="string">"`completed` = ?,\n"</span> +</div><div class="line">  <span class="string">"`order` = ?,\n"</span> +</div><div class="line">  <span class="string">"`url` = ?\n"</span> +</div><div class="line">  <span class="string">"WHERE `id` = ?;"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SQL_DELETE = <span class="string">"DELETE FROM `todo` WHERE `id` = ?"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SQL_DELETE_ALL = <span class="string">"DELETE FROM `todo`"</span>;</div></pre></td></tr></table></figure>
<p>OK！一切工作准备就绪，下面我们来实现我们的JDBC版本的服务～</p>
<h3 id="实现JDBC版本的服务">实现JDBC版本的服务</h3><p>所有的获取连接、获取执行数据的操作都要在<code>Handler</code>中完成。比如我们可以这样获取数据库连接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">client.getConnection(conn -&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (conn.succeeded()) &#123;</div><div class="line">        <span class="keyword">final</span> SQLConnection connection = conn.result();</div><div class="line">        <span class="comment">// do something...</span></div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// handle failure</span></div><div class="line">      &#125;</div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>由于每一个数据库操作都需要获取数据库连接，因此我们来包装一个返回<code>Handler&lt;AsyncResult&lt;SQLConnection&gt;&gt;</code>的方法，在此回调中可以直接使用数据库连接，可以减少一些代码量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Handler&lt;AsyncResult&lt;SQLConnection&gt;&gt; connHandler(Future future, Handler&lt;SQLConnection&gt; handler) &#123;</div><div class="line">  <span class="keyword">return</span> conn -&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (conn.succeeded()) &#123;</div><div class="line">      <span class="keyword">final</span> SQLConnection connection = conn.result();</div><div class="line">      handler.handle(connection);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      future.fail(conn.cause());</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>获取数据库连接以后，我们就可以对数据库进行各种操作了：</p>
<ul>
<li><code>query</code> : 执行查询（raw SQL）</li>
<li><code>queryWithParams</code> : 执行预编译查询（prepared statement）</li>
<li><code>updateWithParams</code> : 执行预编译DDL语句（prepared statement）</li>
<li><code>execute</code>: 执行任意SQL语句</li>
</ul>
<p>所有的方法都是异步的所以每个方法最后都接受一个<code>Handler</code>参数，我们可以在此<code>Handler</code>中获取结果并执行相应逻辑。</p>
<p>现在我们来编写初始化数据库表的<code>initData</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Future&lt;Boolean&gt; <span class="title">initData</span><span class="params">()</span> </span>&#123;</div><div class="line">  Future&lt;Boolean&gt; result = Future.future();</div><div class="line">  client.getConnection(connHandler(result, connection -&gt;</div><div class="line">    connection.execute(SQL_CREATE, create -&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (create.succeeded()) &#123;</div><div class="line">        result.complete(<span class="keyword">true</span>);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        result.fail(create.cause());</div><div class="line">      &#125;</div><div class="line">      connection.close();</div><div class="line">    &#125;)));</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此方法仅会在Verticle初始化时被调用，如果<code>todo</code>表不存在的话就创建一下。注意，<strong>最后一定要关闭数据库连接</strong>。</p>
<p>下面我们来实现插入逻辑方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Future&lt;Boolean&gt; <span class="title">insert</span><span class="params">(Todo todo)</span> </span>&#123;</div><div class="line">  Future&lt;Boolean&gt; result = Future.future();</div><div class="line">  client.getConnection(connHandler(result, connection -&gt; &#123;</div><div class="line">    connection.updateWithParams(SQL_INSERT, <span class="keyword">new</span> JsonArray().add(todo.getId())</div><div class="line">      .add(todo.getTitle())</div><div class="line">      .add(todo.isCompleted())</div><div class="line">      .add(todo.getOrder())</div><div class="line">      .add(todo.getUrl()), r -&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (r.failed()) &#123;</div><div class="line">        result.fail(r.cause());</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        result.complete(<span class="keyword">true</span>);</div><div class="line">      &#125;</div><div class="line">      connection.close();</div><div class="line">    &#125;);</div><div class="line">  &#125;));</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们使用<code>updateWithParams</code>方法执行插入逻辑，并且传递了一个<code>JsonArray</code>变量作为预编译参数。这一点很重要，使用预编译语句可以有效防止SQL注入。</p>
<p>我们再来实现<code>getCertain</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> Future&lt;Optional&lt;Todo&gt;&gt; getCertain(String todoID) &#123;</div><div class="line">  Future&lt;Optional&lt;Todo&gt;&gt; result = Future.future();</div><div class="line">  client.getConnection(connHandler(result, connection -&gt; &#123;</div><div class="line">    connection.queryWithParams(SQL_QUERY, <span class="keyword">new</span> JsonArray().add(todoID), r -&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (r.failed()) &#123;</div><div class="line">        result.fail(r.cause());</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        List&lt;JsonObject&gt; list = r.result().getRows();</div><div class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span> || list.isEmpty()) &#123;</div><div class="line">          result.complete(Optional.empty());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          result.complete(Optional.of(<span class="keyword">new</span> Todo(list.get(<span class="number">0</span>))));</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      connection.close();</div><div class="line">    &#125;);</div><div class="line">  &#125;));</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个方法里，当我们的查询语句执行以后，我们获得到了<code>ResultSet</code>实例作为查询的结果集。我们可以通过<code>getColumnNames</code>方法获取字段名称，通过<code>getResults</code>方法获取结果。这里我们通过<code>getRows</code>方法来获取结果集，结果集的类型为<code>List&lt;JsonObject&gt;</code>。</p>
<p>其余的几个方法：<code>getAll</code>, <code>update</code>, <code>delete</code> 以及 <code>deleteAll</code>都遵循上面的模式，这里就不多说了。你可以在<a href="https://github.com/sczyh30/vertx-blueprint-todo-backend/blob/master/src/main/java/io/vertx/blueprint/todolist/service/JdbcTodoService.java" target="_blank" rel="external">GitHub</a>上浏览完整的源代码。</p>
<p>重构完毕，我们来写待办事项服务对应的配置，然后再来运行！</p>
<h2 id="再来运行！">再来运行！</h2><p>首先我们在项目的根目录下创建一个 <code>config</code> 文件夹作为配置文件夹。我们在其中创建一个<code>config_jdbc.json</code>文件作为 <code>jdbc</code> 类型服务的配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"service.type"</span>: <span class="string">"jdbc"</span>,</div><div class="line">  <span class="attr">"url"</span>: <span class="string">"jdbc:mysql://localhost/vertx_blueprint?characterEncoding=UTF-8&amp;useSSL=false"</span>,</div><div class="line">  <span class="attr">"driver_class"</span>: <span class="string">"com.mysql.cj.jdbc.Driver"</span>,</div><div class="line">  <span class="attr">"user"</span>: <span class="string">"vbpdb1"</span>,</div><div class="line">  <span class="attr">"password"</span>: <span class="string">"666666*"</span>,</div><div class="line">  <span class="attr">"max_pool_size"</span>: <span class="number">30</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你需要根据自己的情况替换掉上述配置文件中相应的内容(如 <em>JDBC URL</em>，<em>JDBC 驱动</em> 等)。</p>
<p>再建一个<code>config.json</code>文件作为<code>redis</code>类型服务的配置（其它的项就用默认配置好啦）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"service.type"</span>: <span class="string">"redis"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们的构建文件也需要更新咯～这里直接给出最终的<code>build.gradle</code>文件：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">plugins &#123;</div><div class="line">  id <span class="string">'java'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">version <span class="string">'1.0'</span></div><div class="line"></div><div class="line">ext &#123;</div><div class="line">  vertxVersion = <span class="string">"3.3.3"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">jar &#123;</div><div class="line">  <span class="comment">// by default fat jar</span></div><div class="line">  archiveName = <span class="string">'vertx-blueprint-todo-backend-fat.jar'</span></div><div class="line">  <span class="keyword">from</span> &#123; <span class="keyword">configurations</span>.<span class="keyword">compile</span>.<span class="keyword">collect</span> &#123; it.isDirectory() ? it : zipTree(it) &#125; &#125;</div><div class="line">  manifest &#123;</div><div class="line">    attributes <span class="string">'Main-Class'</span>: <span class="string">'io.vertx.core.Launcher'</span></div><div class="line">    attributes <span class="string">'Main-Verticle'</span>: <span class="string">'io.vertx.blueprint.todolist.verticles.TodoVerticle'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">repositories</span> &#123;</div><div class="line">  jcenter()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// compileOnly requires Gradle 2.12+</span></div><div class="line"><span class="keyword">task</span> annotationProcessing(type: JavaCompile, <span class="keyword">group</span>: <span class="string">'build'</span>) &#123;</div><div class="line">  <span class="keyword">source</span> = <span class="keyword">sourceSets</span>.main.java</div><div class="line">  <span class="keyword">classpath</span> = <span class="keyword">configurations</span>.<span class="keyword">compile</span> + <span class="keyword">configurations</span>.compileOnly</div><div class="line">  <span class="keyword">destinationDir</span> = <span class="keyword">project</span>.<span class="keyword">file</span>(<span class="string">'src/main/generated'</span>)</div><div class="line">  <span class="keyword">options</span>.compilerArgs = [</div><div class="line">    <span class="string">"-proc:only"</span>,</div><div class="line">    <span class="string">"-processor"</span>, <span class="string">"io.vertx.codegen.CodeGenProcessor"</span>,</div><div class="line">    <span class="string">"-AoutputDirectory=$&#123;destinationDir.absolutePath&#125;"</span></div><div class="line">  ]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">sourceSets</span> &#123;</div><div class="line">  main &#123;</div><div class="line">    java &#123;</div><div class="line">      srcDirs += <span class="string">'src/main/generated'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">compileJava &#123;</div><div class="line">  <span class="keyword">targetCompatibility</span> = <span class="number">1.8</span></div><div class="line">  <span class="keyword">sourceCompatibility</span> = <span class="number">1.8</span></div><div class="line"></div><div class="line">  dependsOn annotationProcessing</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">  <span class="keyword">compile</span>(<span class="string">"io.vertx:vertx-core:$&#123;vertxVersion&#125;"</span>)</div><div class="line">  <span class="keyword">compile</span>(<span class="string">"io.vertx:vertx-web:$&#123;vertxVersion&#125;"</span>)</div><div class="line">  <span class="keyword">compile</span>(<span class="string">"io.vertx:vertx-jdbc-client:$&#123;vertxVersion&#125;"</span>)</div><div class="line">  <span class="keyword">compile</span>(<span class="string">"io.vertx:vertx-redis-client:$&#123;vertxVersion&#125;"</span>)</div><div class="line">  compileOnly(<span class="string">"io.vertx:vertx-codegen:$&#123;vertxVersion&#125;"</span>)</div><div class="line">  <span class="keyword">compile</span> <span class="string">'mysql:mysql-connector-java:6.0.2'</span></div><div class="line"></div><div class="line">  testCompile(<span class="string">"io.vertx:vertx-unit:$&#123;vertxVersion&#125;"</span>)</div><div class="line">  testCompile <span class="keyword">group</span>: <span class="string">'junit'</span>, name: <span class="string">'junit'</span>, version: <span class="string">'4.12'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">task</span> wrapper(type: Wrapper) &#123;</div><div class="line">  gradleVersion = <span class="string">'3.0'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好啦好啦，迫不及待了吧？～打开终端，构建我们的应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gradle build</div></pre></td></tr></table></figure>
<p>然后我们可以运行Redis版本的待办事项服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar build/libs/vertx-blueprint-todo-backend-fat.jar -conf config/config.json</div></pre></td></tr></table></figure>
<p>我们也可以运行JDBC版本的待办事项服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar build/libs/vertx-blueprint-todo-backend-fat.jar -conf config/config_jdbc.json</div></pre></td></tr></table></figure>
<p>同样地，我们也可以使用<a href="https://github.com/TodoBackend/todo-backend-js-spec" target="_blank" rel="external">todo-backend-js-spec</a>来测试我们的API。由于我们的API设计没有改变，因此测试结果应该不会有变化。</p>
<p>我们也提供了待办事项服务对应的Docker Compose镜像构建文件，可以直接通过Docker来运行我们的待办事项服务。你可以在仓库的根目录下看到<a href="https://github.com/sczyh30/vertx-blueprint-todo-backend/blob/master/docker-compose.yml" target="_blank" rel="external">相应的配置文件</a>，并通过 <code>docker-compose up -- build</code> 命令来构建并运行。</p>
<p><img src="https://github.com/sczyh30/vertx-blueprint-todo-backend/raw/master/docs/img/vbptds-docker-compose-running.png" alt="Docker Compose"></p>
<h1 id="哈哈，成功了！">哈哈，成功了！</h1><p>哈哈，恭喜你完成了整个待办事项服务，是不是很开心？～在整个教程中，你应该学到了很多关于 <code>Vert.x Web</code>、 <code>Vert.x Redis</code> 和 <code>Vert.x JDBC</code> 的开发知识。当然，最重要的是，你会对Vert.x的 <strong>异步开发模式</strong> 有了更深的理解和领悟。</p>
<p>另外，Vert.x 蓝图系列已经发布至Vert.x官网：<a href="http://vertx.io/blog/vert-x-blueprint-tutorials/" target="_blank" rel="external">Vert.x Blueprint Tutorials</a>。其中<a href="http://sczyh30.github.io/vertx-blueprint-job-queue/cn/kue-core/index.html" target="_blank" rel="external">第二个Blueprint</a>是关于消息应用的，<a href="http://sczyh30.github.io/vertx-blueprint-microservice/cn/index.html" target="_blank" rel="external">第三个Blueprint</a>是关于微服务的，有兴趣的朋友可以参考后面几篇蓝图教程。</p>
<p>更多关于Vert.x的文章，请参考<a href="http://vertx.io/blog/archives/" target="_blank" rel="external">Blog on Vert.x Website</a>。官网的资料是最全面的 :-)</p>
<h1 id="来自其它框架？">来自其它框架？</h1><p>之前你可能用过其它的框架，比如Spring Boot。这一小节，我将会用类比的方式来介绍Vert.x Web的使用。</p>
<h2 id="来自Spring_Boot/Spring_MVC">来自Spring Boot/Spring MVC</h2><p>在Spring Boot中，我们通常在控制器(Controller)中来配置路由以及处理请求，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@ComponentScan</span></div><div class="line"><span class="meta">@EnableAutoConfiguration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TodoController</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Autowired</span></div><div class="line">  <span class="keyword">private</span> TodoService service;</div><div class="line"></div><div class="line">  <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/todos/&#123;id&#125;"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> Todo <span class="title">getCertain</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id) </span>&#123;</div><div class="line">    <span class="keyword">return</span> service.fetch(id);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Spring Boot中，我们使用 <code>@RequestMapping</code> 注解来配置路由，而在Vert.x Web中，我们是通过 <code>Router</code> 对象来配置路由的。并且因为Vert.x Web是异步的，我们会给每个路由绑定一个处理器（<code>Handler</code>）来处理对应的请求。</p>
<p>另外，在Vert.x Web中，我们使用 <code>end</code> 方法来向客户端发送HTTP response。相对地，在Spring Boot中我们直接在每个方法中返回结果作为response。</p>
<h2 id="来自Play_Framework_2">来自Play Framework 2</h2><p>如果之前用过Play Framework 2的话，你一定会非常熟悉异步开发模式。在Play Framework 2中，我们在 <code>routes</code> 文件中定义路由，类似于这样：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">GET</span>     /todos/:todoId      controllers.<span class="type">TodoController</span>.handleGetCertain(todoId: <span class="type">Int</span>)</div></pre></td></tr></table></figure>
<p>而在Vert.x Web中，我们通过<code>Router</code>对象来配置路由：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">"/todos/:todoId"</span>).handler(<span class="keyword">this</span>::handleGetCertain);</div></pre></td></tr></table></figure>
<p><code>this::handleGetCertain</code>是处理对应请求的方法引用（在Scala里可以把它看作是一个函数）。</p>
<p>Play Framework 2中的异步开发模式是基于<code>Future</code>的。每一个路由处理函数都返回一个<code>Action</code>对象（实质上是一个类型为<code>Request[A] =&gt; Result</code>的函数），我们在<code>Action.apply</code>(或<code>Action.async</code>)闭包中编写我们的处理逻辑，类似于这样：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handleGetCertain</span></span>(todoId: <span class="type">Int</span>): <span class="type">Action</span>[<span class="type">AnyContent</span>] = <span class="type">Action</span>.async &#123;</div><div class="line">    service.getCertain(todoId) map &#123; <span class="comment">// 服务返回的类型是 `Future[Option[Todo]]`</span></div><div class="line">        <span class="keyword">case</span> <span class="type">Some</span>(res) =&gt;</div><div class="line">            <span class="type">Ok</span>(<span class="type">Json</span>.toJson(res))</div><div class="line">        <span class="keyword">case</span> <span class="type">None</span> =&gt;</div><div class="line">            <span class="type">NotFound</span>()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而在Vert.x Web中，异步开发模式基本上都是基于回调的（当然也可以用Vert.x RxJava）。我们可以这么写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateTodo</span><span class="params">(RoutingContext context)</span> </span>&#123;</div><div class="line">    String todoId = context.request().getParam(<span class="string">"todoId"</span>); <span class="comment">// 获取Path Variable</span></div><div class="line">    service.getCertain(todoId).setHandler(r -&gt; &#123; <span class="comment">// 服务返回的类型是 `Future&lt;Optional&lt;Todo&gt;&gt;`</span></div><div class="line">        <span class="keyword">if</span> (r.succeeded) &#123;</div><div class="line">            Optional&lt;Todo&gt; res = r.result;</div><div class="line">            <span class="keyword">if</span> (res.isPresent()) &#123;</div><div class="line">                context.response()</div><div class="line">                    .putHeader(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">                    .end(Json.encodePrettily(res));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                sendError(<span class="number">404</span>, context.response()); <span class="comment">// NotFound(404)</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sendError(<span class="number">503</span>, context.response());</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="想要使用其它持久化存储框架？">想要使用其它持久化存储框架？</h2><p>你可能想在Vert.x中使用其它的持久化存储框架或库，比如MyBatis ORM或者Jedis，这当然可以啦！Vert.x允许开发者整合任何其它的框架和库，但是像MyBatis ORM这种框架都是阻塞型的，可能会阻塞Event Loop线程，因此我们需要利用<code>blockingHandler</code>方法去执行阻塞的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">"/todos/:todoId"</span>).blockingHandler(routingContext -&gt; &#123;</div><div class="line">            String todoID = routingContext.request().getParam(<span class="string">"todoId"</span>);</div><div class="line">            Todo res = service.fetchBlocking(todoID); <span class="comment">// 阻塞型</span></div><div class="line"></div><div class="line">            <span class="comment">// 做一些微小的工作</span></div><div class="line"></div><div class="line">            routingContext.next();</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>Vert.x会使用Worker线程去执行<code>blockingHandler</code>方法(或者Worker Verticles)中的操作，因此不会阻塞Event Loop线程。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/">Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">sczyh30</a></p>
        <p><span>发布时间:</span>2016年06月16日</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/" title="Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程">http://www.sczyh30.com/posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/</a>
            <span class="copy-path" data-clipboard-text="原文: http://www.sczyh30.com/posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/　　作者: sczyh30" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"知识共享-保持署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/posts/Asynchronous/vertx-blueprint-2-vertx-kue-core-tutorial/">
                    Vert.x Blueprint 系列教程(二) | 开发基于消息的应用 - Vert.x Kue 教程（Core部分）
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/posts/Architecture/quorum-based-voting-for-replica-control/">
                    基于 Quorum 投票机制的 Replica Control 算法
                </a>
            </div>
        
    </nav>


  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#踏入Vert-x之门"><span class="toc-number">2.</span> <span class="toc-text">踏入Vert.x之门</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#我们的应用_-_待办事项服务"><span class="toc-number">3.</span> <span class="toc-text">我们的应用 - 待办事项服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#说干就干！"><span class="toc-number">4.</span> <span class="toc-text">说干就干！</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Gradle配置文件"><span class="toc-number">4.1.</span> <span class="toc-text">Gradle配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#待办事项对象"><span class="toc-number">4.2.</span> <span class="toc-text">待办事项对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Verticle"><span class="toc-number">4.3.</span> <span class="toc-text">Verticle</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Vert-x_Web与REST_API"><span class="toc-number">5.</span> <span class="toc-text">Vert.x Web与REST API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建HTTP服务端并配置路由"><span class="toc-number">5.1.</span> <span class="toc-text">创建HTTP服务端并配置路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置路由"><span class="toc-number">5.2.</span> <span class="toc-text">配置路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#异步方法模式"><span class="toc-number">5.3.</span> <span class="toc-text">异步方法模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#待办事项逻辑实现"><span class="toc-number">5.4.</span> <span class="toc-text">待办事项逻辑实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vert-x_Redis"><span class="toc-number">5.4.1.</span> <span class="toc-text">Vert.x Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#存储格式"><span class="toc-number">5.4.2.</span> <span class="toc-text">存储格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取/获取所有待办事项"><span class="toc-number">5.4.3.</span> <span class="toc-text">获取/获取所有待办事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建待办事项"><span class="toc-number">5.4.4.</span> <span class="toc-text">创建待办事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更新待办事项"><span class="toc-number">5.4.5.</span> <span class="toc-text">更新待办事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除/删除全部待办事项"><span class="toc-number">5.4.6.</span> <span class="toc-text">删除/删除全部待办事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#将应用与Vert-x_Launcher一起打包"><span class="toc-number">5.5.</span> <span class="toc-text">将应用与Vert.x Launcher一起打包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行我们的服务"><span class="toc-number">5.6.</span> <span class="toc-text">运行我们的服务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#将服务与控制器分离"><span class="toc-number">6.</span> <span class="toc-text">将服务与控制器分离</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#用Future实现异步服务"><span class="toc-number">6.1.</span> <span class="toc-text">用Future实现异步服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开始重构！"><span class="toc-number">6.2.</span> <span class="toc-text">开始重构！</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vert-x-Redis版本的待办事项服务"><span class="toc-number">6.3.</span> <span class="toc-text">Vert.x-Redis版本的待办事项服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Monadic_Future"><span class="toc-number">6.3.1.</span> <span class="toc-text">Monadic Future</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vert-x-JDBC版本的待办事项服务"><span class="toc-number">6.4.</span> <span class="toc-text">Vert.x-JDBC版本的待办事项服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC_++_异步"><span class="toc-number">6.4.1.</span> <span class="toc-text">JDBC ++ 异步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加依赖"><span class="toc-number">6.4.2.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化JDBCClient"><span class="toc-number">6.4.3.</span> <span class="toc-text">初始化JDBCClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现JDBC版本的服务"><span class="toc-number">6.4.4.</span> <span class="toc-text">实现JDBC版本的服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#再来运行！"><span class="toc-number">6.5.</span> <span class="toc-text">再来运行！</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#哈哈，成功了！"><span class="toc-number">7.</span> <span class="toc-text">哈哈，成功了！</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#来自其它框架？"><span class="toc-number">8.</span> <span class="toc-text">来自其它框架？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#来自Spring_Boot/Spring_MVC"><span class="toc-number">8.1.</span> <span class="toc-text">来自Spring Boot/Spring MVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#来自Play_Framework_2"><span class="toc-number">8.2.</span> <span class="toc-text">来自Play Framework 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#想要使用其它持久化存储框架？"><span class="toc-number">8.3.</span> <span class="toc-text">想要使用其它持久化存储框架？</span></a></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程　| 「浮生若梦」 - sczyh30's blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function(){
            this.page.url = 'http://www.sczyh30.com/posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/';
            this.page.identifier = 'posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/';
        };
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = '//sczyh30.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <script> loadComment(); </script>

</section>


    




    <div class="scroll" id="post-nav-button">
        
            <a href="/posts/Asynchronous/vertx-blueprint-2-vertx-kue-core-tutorial/" title="上一篇: Vert.x Blueprint 系列教程(二) | 开发基于消息的应用 - Vert.x Kue 教程（Core部分）">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/posts/Architecture/quorum-based-voting-for-replica-control/" title="下一篇: 基于 Quorum 投票机制的 Replica Control 算法">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/posts/高可用架构/netflix-hystrix-1-5-sliding-window/">Hystrix 1.5 滑动窗口实现原理总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Functional-Programming/call-with-current-continuation/">call/cc 总结 | Scheme</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Distributed-System/distributed-computing-system-gc-osdi16-yak/">分布式计算系统中的 GC 问题 | Yak (OSDI 2016) 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Distributed-System/spark-rdd-paper-summary/">Distributed System | Spark RDD 论文总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Vert-x/vertx-advanced-demystifying-thread-model/">Vert.x 技术内幕 | 解道 Vert.x 线程模型</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Vert-x/vertx-advanced-execute-blocking-internal/">Vert.x 技术内幕 | executeBlocking 实现原理</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Vert-x/vertx-advanced-async-rpc/">Vert.x 技术内幕 | 异步 RPC 实现原理</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Distributed-System/distributed-system-rpc-design/">Distributed System | RPC 模块设计与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Vert-x/vertx-advanced-clustered-event-bus-internal/">Vert.x 技术内幕 | Event Bus 源码分析 (集群模式)</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Vert-x/vertx-advanced-local-event-bus-internal/">Vert.x 技术内幕 | Event Bus 源码分析 (Local模式)</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Life/busy-enough-2016-08/">最近真忙～</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Asynchronous/vertx-blueprint-3-micro-shop-microservice/">Vert.x Blueprint 系列教程(三) | Micro Shop 微服务实战</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Asynchronous/vertx-blueprint-2-vertx-kue-http-tutorial/">Vert.x Blueprint 系列教程(二) | Vert.x Kue 教程（Web部分）</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Asynchronous/vertx-blueprint-2-vertx-kue-core-tutorial/">Vert.x Blueprint 系列教程(二) | 开发基于消息的应用 - Vert.x Kue 教程（Core部分）</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Asynchronous/vertx-blueprint-1-todo-backend-tutorial/">Vert.x Blueprint 系列教程(一) | 待办事项服务开发教程</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Architecture/quorum-based-voting-for-replica-control/">基于 Quorum 投票机制的 Replica Control 算法</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Microservice/netflix-hystrix-how-it-works-summary/">Netflix Hystrix | 工作流程浅析 && HystrixCircuitBreaker 源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Concurrency/concurrency-treiber-stack/">并发编程算法 | Treiber Stack 实现 lock-free stack</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Distributed-System/distributed-system-base/">分布式系统基础总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Architecture/service-with-docker-compose/">使用 Docker Compose 编排容器集群</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Develop/gradle-annotation-processing-vertx-codegen/">在 Gradle 中使用 Annotation Processing Tool | Vert.x Codegen 示例</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Microservice/circuit-breaker-pattern/">微服务设计模式 | Circuit Breaker Pattern</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Functional-Programming/type-system-existential-types-scala-java/">类型系统 | Existential Type | Scala ++ Java ++ Haskell</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Functional-Programming/type-system-refinement-types/">类型系统 | Refinement Type</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Scala/play-framework-2-5-web-summary/">Play Framework 2.5 | Web 开发总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Functional-Programming/scala-type-lambda/">Scala | Type Lambda</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Scala/akka-actor-sender-enclosing/">Akka Actor | 注意 sender 的闭包范围</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Miscellaneous/play-music-on-linux/">在 Linux 环境下玩转 MIDI</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Scala/slick-3-type-system-query-prolouge/">探索万恶的 Slick 3 类型系统 | Prologue</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Scala/slick-3-summary-functional-relational-mapping/">Slick 3 总结 | Functional Relational Mapping</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Scala/play-framework-2-5-dependency-injection-di/">Play Framework 2.5 | Dependency Injection 总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Functional-Programming/functional-programming-type-and-kind/">FP :: Type Theory | Type, Type Constructor 与 Kind</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Functional-Programming/typeclass-scala-haskell/">Scala | Haskell | Type Class总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/java-concurrent-threadlocal/">并发编程 | ThreadLocal 源码深入分析</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/java-8-completable-future/">并发编程 | JDK 1.8 中的 CompletableFuture | FRP风格</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Scala/scala-fp-union-curry-howard-isomorphism/">Scala | 利用 Curry-Howard Isomorphism 实现 union type</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Scala/scala-for-comprehensions-detail/">Scala | for-comprehension 底层转换 | withFilter 解析</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Algorithm/algorithm-quicksort/">快速排序实现及优化 | DualPivotQuicksort</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Network/network-io-model/">POSIX I/O 模型之阻塞、非阻塞、同步、异步浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Network/tcp-series/">TCP 相关知识总结目录</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Network/tcp-keepalive-heartbeat/">TCP Keepalive && Heartbeat</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Network/tcp-congestion-control/">TCP 拥塞控制</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Network/tcp-retransmission/">TCP Retransmission</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Network/tcp-flow-control/">TCP 流量控制</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Network/network-basis/">计算机网络相关知识总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Network/tcp-connection/">TCP 连接的建立和终止</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/jvm-klass-oop/">深入探究 JVM | klass-oop对象模型研究</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/C-C/inside-cpp-object-model-summary-3/">Inside The C++ Object Model 学习笔记(III)</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/C-C/cpp-stl-functional/">C++ 11 STL | functional 标准库</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/C-C/cpp-move-semantic/">Modern C++ | 移动语义与完美转发 | Universal Reference</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/C-C/inside-cpp-object-model-summary-1/">Inside The C++ Object Model 学习笔记(I)</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Architecture/rabbitmq-summary/">消息队列中间件 | RabbitMQ 总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Functional-Programming/y-combinator/">不动点组合子 | Y Combinator</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Functional-Programming/haskell-category-basic/">Haskell 学习笔记 | 范畴论与 Haskell（基础篇）</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Android/android-event-dispatcher/">Android 事件分发机制总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Android/android-refactor-mvp/">Android MVP 架构重构实践</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/C-C/cpp-stl-hashmap/">C++ STL 之哈希表 | unordered_map</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Android/android-performance-1/">Android 应用性能优化总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Android/android-aysnc-message/">Android 异步消息处理机制总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Summary/struct_sizeof/">C/C++ 结构体字节对齐</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/java-hashcode-equal/">hashCode 方法及 equals 方法的规范</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/java-basic-summary-01/">Java 基础技术细节总结 | 语言规范</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Develop/gdb-simple/">gdb 用法总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Algorithm/algorithm-cache/">缓存算法（页面置换算法）总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Web/web-frontend-02/">Web开发笔记 - 前端总结 (性能篇)</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Web/web-frontend-01/">Web开发笔记 - 前端总结(开发篇)</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Algorithm/algorithm-linkedlist-leetcode/">LeetCode | 链表相关算法总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/jvm-classloader-parent-delegation-model/">深入探究 JVM | 类加载器与双亲委派模型</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Life/test-migrate/">博客搬迁咯~</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/jvm-gc-hotspot-implements/">深入探究 JVM | HotSpot JVM 的 GC 实现</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/jvm-gc-safepoint-condition/">深入探究 JVM | Safepoint 及 GC 的触发条件</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/jvm-gc-method-types/">深入探究 JVM | 初探 GC 算法</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/java-reference-type/">Java 中的几种引用 | 弱引用、软引用、虚引用</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/jvm-gc-intro-count-vs-reachability/">深入探究 JVM | 初探 GC - 引用计数 VS 可达分析</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/jvm-metaspace/">深入探究 JVM | 探秘 Metaspace</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/java-reflection-2/">深入解析Java反射（2） - invoke方法</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/java-reflection-1/">深入解析Java反射（1） - 基础</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Java/jvm-memory/">深入探究 JVM | Java 的内存区域解析</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Architecture/docker-tutorial/">Docker 入门学习札记</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Develop/game-dev-unity/">Unity游戏开发总结</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Life/chemistry-jt-2014/">2014晶体培养 - 硫酸铜单晶</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/Life/chemistry-jt-2013/">2013寒假晶体培养 - 硫酸铜单晶</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2015 - 2018 sczyh30's blog
            </div>
            <div class="footer-right">
                <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1255963745'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1255963745%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));
                </script>
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank">Yelee</a> by MOxFIVE. Enhanced by sczyh30 <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 7;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>