<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>「千载弦歌，芳华如梦」 - sczyh30&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!--<meta name="keywords" content="sczyh30, blog"/>-->
  <meta name="description" content="sczyh30&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="「千载弦歌，芳华如梦」 - sczyh30's blog">
<meta property="og:url" content="http://www.sczyh30.com/page/2/index.html">
<meta property="og:site_name" content="「千载弦歌，芳华如梦」 - sczyh30's blog">
<meta property="og:description" content="sczyh30&apos;s blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="「千载弦歌，芳华如梦」 - sczyh30's blog">
<meta name="twitter:description" content="sczyh30&apos;s blog">
  
    <link rel="alternative" href="/atom.xml" title="「千载弦歌，芳华如梦」 - sczyh30&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: true
      }
  </script>
  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="http://7xkkgd.com1.z0.glb.clouddn.com/blog_default_avatar.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">sczyh30</a></h1>
        </hgroup>

        
        <p class="header-subtitle">踏歌长行，梦想永在。</p>
        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about">About Me</a></li>
                        
                            <li><a href="/en/">Blog(EN)</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:sczyh16@gmail.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/sczyh30" title="GitHub"></a></li>
                            
                                <li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/sczyh30" title="新浪微博"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                                <li id="SegmentFault"><a class="SegmentFault" target="_blank" href="https://segmentfault.com/u/sczyh30" title="SegmentFault"></a></li>
                            
                                <li id="Google"><a class="Google" target="_blank" href="https://plus.google.com/u/0/117807083506391735472" title="Google"></a></li>
                            
                                <li id="Twitter"><a class="Twitter" target="_blank" href="https://twitter.com/sczyh30" title="Twitter"></a></li>
                            
                                <li id="Medium"><a class="Medium" target="_blank" href="https://medium.com/@sczyh30" title="Medium"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/AIO/" style="font-size: 10px;">AIO</a> <a href="/tags/AMQP/" style="font-size: 10px;">AMQP</a> <a href="/tags/APT/" style="font-size: 10px;">APT</a> <a href="/tags/Akka-Actor/" style="font-size: 10px;">Akka Actor</a> <a href="/tags/Algorithm/" style="font-size: 13px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/C/" style="font-size: 16px;">C++</a> <a href="/tags/C-11/" style="font-size: 10px;">C++ 11</a> <a href="/tags/CE3/" style="font-size: 10px;">CE3</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Category-Theory/" style="font-size: 10px;">Category Theory</a> <a href="/tags/Chemistry/" style="font-size: 11px;">Chemistry</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/DI/" style="font-size: 10px;">DI</a> <a href="/tags/Database/" style="font-size: 10px;">Database</a> <a href="/tags/Docker/" style="font-size: 11px;">Docker</a> <a href="/tags/Engine/" style="font-size: 10px;">Engine</a> <a href="/tags/Euterpea/" style="font-size: 10px;">Euterpea</a> <a href="/tags/Event-Loop/" style="font-size: 10px;">Event Loop</a> <a href="/tags/FRP/" style="font-size: 10px;">FRP</a> <a href="/tags/Functional-Programming/" style="font-size: 18px;">Functional Programming</a> <a href="/tags/G1/" style="font-size: 10px;">G1</a> <a href="/tags/GC/" style="font-size: 13px;">GC</a> <a href="/tags/GDB/" style="font-size: 10px;">GDB</a> <a href="/tags/Game/" style="font-size: 11px;">Game</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/HashMap/" style="font-size: 11px;">HashMap</a> <a href="/tags/Haskell/" style="font-size: 14px;">Haskell</a> <a href="/tags/HotSpot/" style="font-size: 12px;">HotSpot</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/JUC/" style="font-size: 10px;">JUC</a> <a href="/tags/JVM/" style="font-size: 19px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Klass-oop/" style="font-size: 10px;">Klass-oop</a> <a href="/tags/LinkedList/" style="font-size: 10px;">LinkedList</a> <a href="/tags/Linux/" style="font-size: 12px;">Linux</a> <a href="/tags/MIDI/" style="font-size: 10px;">MIDI</a> <a href="/tags/Mathematical-Logic/" style="font-size: 10px;">Mathematical Logic</a> <a href="/tags/Metaspace/" style="font-size: 10px;">Metaspace</a> <a href="/tags/Netflix-Hystrix/" style="font-size: 10px;">Netflix Hystrix</a> <a href="/tags/Network/" style="font-size: 16px;">Network</a> <a href="/tags/OS/" style="font-size: 10px;">OS</a> <a href="/tags/Object-Model/" style="font-size: 12px;">Object Model</a> <a href="/tags/Play-Framework/" style="font-size: 11px;">Play Framework</a> <a href="/tags/Quorum/" style="font-size: 10px;">Quorum</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Reflection/" style="font-size: 11px;">Reflection</a> <a href="/tags/SQL/" style="font-size: 10px;">SQL</a> <a href="/tags/STL/" style="font-size: 11px;">STL</a> <a href="/tags/Scala/" style="font-size: 19px;">Scala</a> <a href="/tags/Slick/" style="font-size: 11px;">Slick</a> <a href="/tags/Sort/" style="font-size: 10px;">Sort</a> <a href="/tags/Struct/" style="font-size: 10px;">Struct</a> <a href="/tags/Summary/" style="font-size: 12px;">Summary</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/Type-Lambda/" style="font-size: 10px;">Type Lambda</a> <a href="/tags/Type-System/" style="font-size: 10px;">Type System</a> <a href="/tags/Type-Theory/" style="font-size: 12px;">Type Theory</a> <a href="/tags/UE4/" style="font-size: 10px;">UE4</a> <a href="/tags/Unity/" style="font-size: 10px;">Unity</a> <a href="/tags/Vert-x/" style="font-size: 19px;">Vert.x</a> <a href="/tags/View/" style="font-size: 10px;">View</a> <a href="/tags/Web/" style="font-size: 12px;">Web</a> <a href="/tags/Web开发/" style="font-size: 12px;">Web开发</a> <a href="/tags/event/" style="font-size: 10px;">event</a> <a href="/tags/functional/" style="font-size: 10px;">functional</a> <a href="/tags/中间件/" style="font-size: 10px;">中间件</a> <a href="/tags/事务/" style="font-size: 10px;">事务</a> <a href="/tags/云服务/" style="font-size: 12px;">云服务</a> <a href="/tags/内存区域/" style="font-size: 10px;">内存区域</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/分布式系统/" style="font-size: 12px;">分布式系统</a> <a href="/tags/前端/" style="font-size: 12px;">前端</a> <a href="/tags/基础/" style="font-size: 10px;">基础</a> <a href="/tags/多线程/" style="font-size: 11px;">多线程</a> <a href="/tags/容器/" style="font-size: 10px;">容器</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/开发/" style="font-size: 17px;">开发</a> <a href="/tags/异步/" style="font-size: 13px;">异步</a> <a href="/tags/异步编程/" style="font-size: 18px;">异步编程</a> <a href="/tags/微服务/" style="font-size: 13px;">微服务</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/性能优化/" style="font-size: 10px;">性能优化</a> <a href="/tags/操作系统/" style="font-size: 10px;">操作系统</a> <a href="/tags/数据库/" style="font-size: 11px;">数据库</a> <a href="/tags/架构/" style="font-size: 11px;">架构</a> <a href="/tags/消息系统/" style="font-size: 10px;">消息系统</a> <a href="/tags/源码分析/" style="font-size: 14px;">源码分析</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/线程安全/" style="font-size: 10px;">线程安全</a> <a href="/tags/编译原理/" style="font-size: 10px;">编译原理</a> <a href="/tags/虚拟化/" style="font-size: 10px;">虚拟化</a>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">Fighting</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">sczyh30</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="http://7xkkgd.com1.z0.glb.clouddn.com/blog_default_avatar.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">sczyh30</a></h1>
            </hgroup>
            
            <p class="header-subtitle">踏歌长行，梦想永在。</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about">About Me</a></li>
                
                    <li><a href="/en/">Blog(EN)</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:sczyh16@gmail.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/sczyh30" title="GitHub"></a></li>
                            
                                <li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/sczyh30" title="新浪微博"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                                <li id="SegmentFault"><a class="SegmentFault" target="_blank" href="https://segmentfault.com/u/sczyh30" title="SegmentFault"></a></li>
                            
                                <li id="Google"><a class="Google" target="_blank" href="https://plus.google.com/u/0/117807083506391735472" title="Google"></a></li>
                            
                                <li id="Twitter"><a class="Twitter" target="_blank" href="https://twitter.com/sczyh30" title="Twitter"></a></li>
                            
                                <li id="Medium"><a class="Medium" target="_blank" href="https://medium.com/@sczyh30" title="Medium"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-quorum-based-voting-for-replica-control" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Architecture/quorum-based-voting-for-replica-control/" class="article-date">
      <time datetime="2016-05-24T16:00:00.000Z" itemprop="datePublished">2016-05-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Architecture/quorum-based-voting-for-replica-control/">基于Quorum投票机制的Replica Control算法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在分布式系统中，一份数据可能有多份副本（冗余数据）。为了保证数据读写的正确性，同一时刻一份数据的多份副本只能用于读或用于写，而不能同时被超过两个访问对象并发读写。Quorum机制就可以保证这一点，我们来看一下它的思想。</p>
<p>一个分布式系统中，我们给每个数据副本都赋予一票。假设一共有 <strong>V</strong> 个数据副本，那么总共就有 <strong>V</strong> 个票数。每个操作必须要获得读票数(完成读操作所需要读取的最小副本数，read quorum,  <strong>V(r)</strong> )或写票数(完成写操作所需要读取的最小副本数write quorum,  <strong>V(w)</strong> )才能够对数据进行读或写。票数需要遵循以下规则：</p>
<ol>
<li>$V_{r} + V_{w} &gt; V$</li>
<li>$V_{w} &gt; \frac{V}{2}$</li>
</ol>
<p>第一条规则有两个作用：第一个作用是保证了一个数据不会被同时读写。当请求一个写操作时，它需要的得到 <strong>V(w)</strong> 读票数，而剩下的票数为 <strong>V - V(w) &lt; V(r)</strong>，因此不再允许读操作。请求读操作时也是同理；第二个作用是保证了强一致性。根据 <strong>鸽巢原理</strong>，写数据操作与读新数据操作之间是有重叠的，这就确保至少有一个读操作是可以读到最新数据的。</p>
<p>第二条规则保证了数据的串行化修改，同一个数据不能同时被两个写操作并发修改。</p>
<p>Quorum投票机制非常有用。比如一份数据在5个结点上存有副本，进行一次写操作的时候，必须等待五个结点的写操作都完成，整个写操作才返回（因为可以从任意结点读取）。这样会导致写操作负载太高，而有了Quorum机制以后，我们可以让写操作在至少3个结点上完成就可以返回，另外的结点可以等待后台同步，而读操作V(r)也需要大于 <strong>V-V(w)</strong> 才能确保至少一个读操作可以读到最新数据。</p>
<h1 id="Reference">Reference</h1><ul>
<li><em>Weighted Voting for Replicated Data</em>, David K. Gifford, Stanford University and Xerox Palo Alto Research Center</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Architecture/">Architecture</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Quorum/">Quorum</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云服务/">云服务</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分布式系统/">分布式系统</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-netflix-hystrix-how-it-works-summary" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Microservice/netflix-hystrix-how-it-works-summary/" class="article-date">
      <time datetime="2016-05-23T16:00:00.000Z" itemprop="datePublished">2016-05-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Microservice/netflix-hystrix-how-it-works-summary/">Netflix Hystrix | 工作流程浅析 &amp;&amp; HystrixCircuitBreaker源码分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>这篇文章里我们来总结一下Netflix Hystrix的工作流程。这是官方提供的流程图(来自GitHub)：</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/hystrix-command-flow-chart.png" alt="Netflix Hystrix Flow Chart"></p>
<h1 id="工作流程">工作流程</h1><p>我们来根据流程图来分析一下工作流程。</p>
<p>首先我们需要创建一个 <code>HystrixCommand</code> 或 <code>HystrixObservableCommand</code> 实例来代表向其它组件发出的操作请求（指令），然后通过相关的方法执行操作指令。这里有4个方法，前两个对应<code>HystrixCommand</code>，后两个对应<code>HystrixObservableCommand</code>：</p>
<ul>
<li><code>execute()</code>：阻塞型方法，返回单个结果（或者抛出异常）</li>
<li><code>queue()</code>：异步方法，返回一个<code>Future</code>对象，可以从中取出单个结果（或者抛出异常）</li>
<li><code>observe()</code>和<code>toObservable()</code>都返回对应的<code>Observable</code>对象，代表（多个）操作结果。注意<code>observe</code>方法在调用的时候就开始执行对应的指令，而<code>toObservable</code>方法相当于是<code>observe</code>方法的lazy版本，当我们去<code>subscribe</code>的时候，对应的指令才会被执行并产生结果</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">K             value   = command.execute();</span><br><span class="line">Future&lt;K&gt;     fValue  = command.queue();</span><br><span class="line">Observable&lt;K&gt; ohValue = command.observe();         <span class="comment">//hot observable</span></span><br><span class="line">Observable&lt;K&gt; ocValue = command.toObservable();    <span class="comment">//cold observable</span></span><br></pre></td></tr></table></figure>
<p>从底层实现来讲，<code>HystrixCommand</code>也是利用<code>Observable</code>实现的（看Hystrix源码的话可以发现里面大量使用了RxJava），尽管它只返回单个结果。<code>HystrixCommand</code>的<code>queue</code>方法实际上是调用了<code>toObservable().toBlocking().toFuture()</code>，而<code>execute</code>方法实际上是调用了<code>queue().get()</code>。</p>
<p>执行操作指令时，Hystrix首先会检查缓存内是否有对应指令的结果，如果有的话，将缓存的结果直接以<code>Observable</code>对象的形式返回。如果没有对应的缓存，Hystrix会检查Circuit Breaker的状态。如果Circuit Breaker的状态为开启状态，Hystrix将不会执行对应指令，而是直接进入失败处理状态（图中8 Fallback）。如果Circuit Breaker的状态为关闭状态，Hystrix会继续进行线程池、任务队列、信号量的检查（图中5），确认是否有足够的资源执行操作指令。如果资源满，Hystrix同样将不会执行对应指令并且直接进入失败处理状态。</p>
<p>如果资源充足，Hystrix将会执行操作指令。操作指令的调用最终都会到这两个方法：</p>
<ul>
<li><code>HystrixCommand.run()</code></li>
<li><code>HystrixObservableCommand.construct()</code></li>
</ul>
<p>如果执行指令的时间超时，执行线程会抛出<code>TimeoutException</code>异常。Hystrix会抛弃结果并直接进入失败处理状态。如果执行指令成功，Hystrix会进行一系列的数据记录，然后返回执行的结果。</p>
<p>同时，Hystrix会根据记录的数据来计算失败比率，一旦失败比率达到某一阈值将自动开启Circuit Breaker。</p>
<p>最后我们再来看一下Hystrix是如何处理失败的。如果我们在Command中实现了<code>HystrixCommand.getFallback()</code>方法（或<code>HystrixObservableCommand.resumeWithFallback()</code>方法，Hystrix会返回对应方法的结果。如果没有实现这些方法的话，从底层看Hystrix将会返回一个空的<code>Observable</code>对象，并且可以通过<code>onError</code>来终止并处理错误。从上层看：</p>
<ul>
<li><code>execute</code>方法将会抛出异常</li>
<li><code>queue</code>方法将会返回一个失败状态的<code>Future</code>对象</li>
<li><code>observe()</code>和<code>toObservable()</code>方法都会返回上述的<code>Observable</code>对象</li>
</ul>
<h1 id="HystrixCircuitBreaker源码分析">HystrixCircuitBreaker源码分析</h1><p>Hystrix中的Circuit Breaker的实现比较明了。整个<code>HystrixCircuitBreaker</code>接口一共有三个方法和三个静态类：</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/hystrix-circuit-breaker-class-structure.png" alt="Class Hierarchy of HystrixCircuitBreaker"></p>
<p>其中<code>allowRequest()</code>方法表示是否允许指令执行，<code>isOpen()</code>方法表示断路器是否为开启状态，<code>markSuccess()</code>用于将断路器关闭。</p>
<p><code>Factory</code>静态类相当于Circuit Breaker Factory，用于获取相应的<code>HystrixCircuitBreaker</code>。我们来看一下其实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="comment">// String is HystrixCommandKey.name() (we can't use HystrixCommandKey directly as we can't guarantee it implements hashcode/equals correctly)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, HystrixCircuitBreaker&gt; circuitBreakersByCommand = <span class="keyword">new</span> ConcurrentHashMap&lt;String, HystrixCircuitBreaker&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HystrixCircuitBreaker <span class="title">getInstance</span><span class="params">(HystrixCommandKey key, HystrixCommandGroupKey group, HystrixCommandProperties properties, HystrixCommandMetrics metrics)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// this should find it for all but the first time</span></span><br><span class="line">        HystrixCircuitBreaker previouslyCached = circuitBreakersByCommand.get(key.name());</span><br><span class="line">        <span class="keyword">if</span> (previouslyCached != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> previouslyCached;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if we get here this is the first time so we need to initialize</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create and add to the map ... use putIfAbsent to atomically handle the possible race-condition of</span></span><br><span class="line">        <span class="comment">// 2 threads hitting this point at the same time and let ConcurrentHashMap provide us our thread-safety</span></span><br><span class="line">        <span class="comment">// If 2 threads hit here only one will get added and the other will get a non-null response instead.</span></span><br><span class="line">        HystrixCircuitBreaker cbForCommand = circuitBreakersByCommand.putIfAbsent(key.name(), <span class="keyword">new</span> HystrixCircuitBreakerImpl(key, group, properties, metrics));</span><br><span class="line">        <span class="keyword">if</span> (cbForCommand == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// this means the putIfAbsent step just created a new one so let's retrieve and return it</span></span><br><span class="line">            <span class="keyword">return</span> circuitBreakersByCommand.get(key.name());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// this means a race occurred and while attempting to 'put' another one got there before</span></span><br><span class="line">            <span class="comment">// and we instead retrieved it and will now return it</span></span><br><span class="line">            <span class="keyword">return</span> cbForCommand;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HystrixCircuitBreaker <span class="title">getInstance</span><span class="params">(HystrixCommandKey key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> circuitBreakersByCommand.get(key.name());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* package */</span><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        circuitBreakersByCommand.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hystrix在<code>Factory</code>类中维护了一个<code>ConcurrentHashMap</code>用于存储与每一个<code>HystrixCommandKey</code>相对应的<code>HystrixCircuitBreaker</code>。每当我们通过<code>getInstance</code>方法从中获取<code>HystrixCircuitBreaker</code>的时候，Hystrix首先会检查<code>ConcurrentHashMap</code>中有没有对应的缓存的断路器，如果有的话直接返回。如果没有的话就会新创建一个<code>HystrixCircuitBreaker</code>实例，将其添加到缓存中并且返回。</p>
<p><code>HystrixCircuitBreakerImpl</code>静态类是<code>HystrixCircuitBreaker</code>接口的实现。我们可以看到<code>HystrixCircuitBreakerImpl</code>类中有四个成员变量。其中<code>properties</code>是对应<code>HystrixCommand</code>的属性类，<code>metrics</code>是对应<code>HystrixCommand</code>的度量数据类。由于会工作在并发环境下，我们用一个<code>AtomicBoolean</code>类型的变量<code>circuitOpen</code>来代表断路器的状态（默认是<code>false</code>代表关闭，这里没有特意实现Half-Open这个状态），并用一个<code>AtomicLong</code>类型的变量<code>circuitOpenedOrLastTestedTime</code>记录着断路恢复计时器的初始时间，用于Open状态向Close状态的转换。</p>
<p>我们首先来看一下<code>isOpen</code>方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOpen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (circuitOpen.get()) &#123;</span><br><span class="line">        <span class="comment">// if we're open we immediately return true and don't bother attempting to 'close' ourself as that is left to allowSingleTest and a subsequent successful test to close</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we're closed, so let's see if errors have made us so we should trip the circuit open</span></span><br><span class="line">    HealthCounts health = metrics.getHealthCounts();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check if we are past the statisticalWindowVolumeThreshold</span></span><br><span class="line">    <span class="keyword">if</span> (health.getTotalRequests() &lt; properties.circuitBreakerRequestVolumeThreshold().get()) &#123;</span><br><span class="line">        <span class="comment">// we are not past the minimum volume threshold for the statisticalWindow so we'll return false immediately and not calculate anything</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (health.getErrorPercentage() &lt; properties.circuitBreakerErrorThresholdPercentage().get()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// our failure rate is too high, trip the circuit</span></span><br><span class="line">        <span class="keyword">if</span> (circuitOpen.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="comment">// if the previousValue was false then we want to set the currentTime</span></span><br><span class="line">            circuitOpenedOrLastTestedTime.set(System.currentTimeMillis());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// How could previousValue be true? If another thread was going through this code at the same time a race-condition could have</span></span><br><span class="line">            <span class="comment">// caused another thread to set it to true already even though we were in the process of doing the same</span></span><br><span class="line">            <span class="comment">// In this case, we know the circuit is open, so let the other thread set the currentTime and report back that the circuit is open</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过<code>circuitOpen.get()</code>获取断路器的状态，如果是开启状态(<code>true</code>)则返回<code>true</code>。否则，Hystrix会从Metrics数据中获取<code>HealthCounts</code>对象，然后检查对应的请求总数(<code>totalCount</code>)是否小于属性中的请求容量阈值(<code>circuitBreakerRequestVolumeThreshold</code>)，如果是的话表示断路器可以保持关闭状态，返回<code>false</code>。如果不满足请求总数条件，就再检查错误比率(<code>errorPercentage</code>)是否小于属性中的错误百分比阈值(<code>circuitBreakerErrorThresholdPercentage</code>，默认 <strong>50</strong>)，如果是的话表示断路器可以保持关闭状态，返回 <code>false</code>；如果超过阈值，Hystrix会判定服务的某些地方出现了问题，因此通过CAS操作将断路器设为开启状态，并记录此时的系统时间作为定时器初始时间，最后返回 <code>true</code>。</p>
<p>我们再来看一下判断Open状态下计时器的实现方法<code>allowSingleTest</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">allowSingleTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> timeCircuitOpenedOrWasLastTested = circuitOpenedOrLastTestedTime.get();</span><br><span class="line">    <span class="comment">// 1) if the circuit is open</span></span><br><span class="line">    <span class="comment">// 2) and it's been longer than 'sleepWindow' since we opened the circuit</span></span><br><span class="line">    <span class="keyword">if</span> (circuitOpen.get() &amp;&amp; System.currentTimeMillis() &gt; timeCircuitOpenedOrWasLastTested + properties.circuitBreakerSleepWindowInMilliseconds().get()) &#123;</span><br><span class="line">        <span class="comment">// We push the 'circuitOpenedTime' ahead by 'sleepWindow' since we have allowed one request to try.</span></span><br><span class="line">        <span class="comment">// If it succeeds the circuit will be closed, otherwise another singleTest will be allowed at the end of the 'sleepWindow'.</span></span><br><span class="line">        <span class="keyword">if</span> (circuitOpenedOrLastTestedTime.compareAndSet(timeCircuitOpenedOrWasLastTested, System.currentTimeMillis())) &#123;</span><br><span class="line">            <span class="comment">// if this returns true that means we set the time so we'll return true to allow the singleTest</span></span><br><span class="line">            <span class="comment">// if it returned false it means another thread raced us and allowed the singleTest before we did</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先获取断路恢复计时器记录的初始时间<code>circuitOpenedOrLastTestedTime</code>，然后判断以下两个条件是否同时满足：</p>
<ul>
<li>断路器的状态为开启状态(<code>circuitOpen.get() == true</code>)</li>
<li>当前时间与计时器初始时间之差大于计时器阈值<code>circuitBreakerSleepWindowInMilliseconds</code>(默认为 <strong>5</strong> 秒)</li>
</ul>
<p>如果同时满足的话，表示可以从<code>Open</code>状态向<code>Close</code>状态转换。Hystrix会通过CAS操作将<code>circuitOpenedOrLastTestedTime</code>设为当前时间，并返回<code>true</code>。如果不同时满足，返回<code>false</code>，代表断路器关闭或者计时器时间未到。</p>
<p>有了这个函数以后，我们再来看一下<code>allowRequest</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">allowRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (properties.circuitBreakerForceOpen().get()) &#123;</span><br><span class="line">        <span class="comment">// properties have asked us to force the circuit open so we will allow NO requests</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (properties.circuitBreakerForceClosed().get()) &#123;</span><br><span class="line">        <span class="comment">// we still want to allow isOpen() to perform it's calculations so we simulate normal behavior</span></span><br><span class="line">        isOpen();</span><br><span class="line">        <span class="comment">// properties have asked us to ignore errors so we will ignore the results of isOpen and just allow all traffic through</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !isOpen() || allowSingleTest();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常直观。首先先读取属性中的强制设定值（可以强制设定状态），如果没有设定的话，就判断断路器是否关闭或者断路恢复计时器是否到达时间，只要满足其中一个条件就返回<code>true</code>，即允许执行操作指令。</p>
<p>最后就是<code>markSuccess</code>方法了，它用于关闭断路器并重置统计数据。代码非常直观，就不多说了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">markSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (circuitOpen.get()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (circuitOpen.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            metrics.resetStream();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hystrix的Circuit Breaker可以用以下的图来总结：</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/hystrix-circuit-breaker-1280.png" alt="Hystrix Circuit Breaker"></p>
<p>至于Hystrix在底层执行Command时是如何利用<code>HystrixCircuitBreaker</code>的，可以看<code>AbstractCommand</code>类中<code>toObservable</code>方法和<code>getRunObservableDecoratedForMetricsAndErrorHandling</code>方法的源码，后边再总结。</p>
<hr>
<h1 id="Reference">Reference</h1><ul>
<li><a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works" target="_blank" rel="external">How it Works - Netflix/Hystrix - Wiki</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Microservice/">Microservice</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Netflix-Hystrix/">Netflix Hystrix</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云服务/">云服务</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/分布式系统/">分布式系统</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微服务/">微服务</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-concurrency-treiber-stack" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Concurrency/concurrency-treiber-stack/" class="article-date">
      <time datetime="2016-05-21T16:00:00.000Z" itemprop="datePublished">2016-05-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Concurrency/concurrency-treiber-stack/">并发编程算法 | Treiber Stack实现lock-free stack</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>多线程环境下各种数据结构的实现有了很大的变化，每当我们更新某个数据的时候，我们都要考虑其它线程是否对其进行了修改。最简单的一种方法就是加锁，不过加锁会导致性能低下，而且可能阻塞其他线程。因此，我们引入了非阻塞(non-blocking)的算法 —— 通过CAS操作保证操作的原子性，同时我们还引入了 <em>lock-free</em> 的概念，它指的是一个线程出现问题（如阻塞，失败）但不影响其他线程（从总体看程序仍然是在运行的）。这里就来看一下Non-blocking stack的一个实现 —— <strong>Treiber Stack</strong>。</p>
<h1 id="Treiber_Stack">Treiber Stack</h1><p>这里给出的是Treiber Stack的一个简化版的Java实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Concurrent stack implementation</span><br><span class="line"> * Treiber's Algorithm</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentStack</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicReference&lt;Node&lt;E&gt;&gt; top = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(E elem)</span> </span>&#123;</span><br><span class="line">        Node&lt;E&gt; newHead = <span class="keyword">new</span> Node&lt;&gt;(elem);</span><br><span class="line">        Node&lt;E&gt; oldHead;</span><br><span class="line">        do &#123;</span><br><span class="line">            oldHead = top.get();</span><br><span class="line">            newHead.next = oldHead;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!top.compareAndSet(oldHead, newHead));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Node&lt;E&gt; oldHead;</span><br><span class="line">        Node&lt;E&gt; newHead;</span><br><span class="line">        do &#123;</span><br><span class="line">            oldHead = top.get();</span><br><span class="line">            <span class="keyword">if</span> (oldHead == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            newHead = oldHead.next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (!top.compareAndSet(oldHead, newHead));</span><br><span class="line">        <span class="keyword">return</span> oldHead.item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> E item;</span><br><span class="line">        <span class="keyword">public</span> Node&lt;E&gt; next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(E item)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.item = item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用了<code>AtomicReference</code>来实现Treiber Stack。每当我们<code>push</code>进去一个元素的时候，我们首先根据要添加的元素创建一个<code>Node</code>，然后获取原栈顶结点，并将新结点的下一个结点指向原栈顶结点。此时我们使用CAS操作来更改栈顶结点，如果此时的栈顶和之前的相同，代表CAS操作成功，那么就把新插入的元素设为栈顶；如果此时的栈顶和之前的不同（即其他线程改变了栈顶结点），CAS操作失败，那么需要重复上述操作（更新当前的栈顶元素并且重设next），直到成功。<code>pop</code>操作的原理也相似。</p>
<hr>
<h1 id="Reference">Reference</h1><ul>
<li><em>Java Concurrency In Practice</em></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Concurrency/">Concurrency</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Algorithm/">Algorithm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发/">并发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-service-with-docker-compose" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Architecture/service-with-docker-compose/" class="article-date">
      <time datetime="2016-05-19T16:00:00.000Z" itemprop="datePublished">2016-05-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Architecture/service-with-docker-compose/">使用 Docker Compose 编排容器集群</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="https://docs.docker.com/compose/" target="_blank" rel="external">Docker Compose</a>可以让我们方便、快速地编排容器集群，有利于分布式架构的实现。</p>
<p>假设我们有一个应用以MySQL作为数据存储，如果没有编排工具的话，我们在构建此应用的Docker镜像时必须将MySQL一同打包进镜像中，这样不仅会使镜像体积臃肿，而且不利于分布式架构的实现（假如要做读写分离、主从复制之类的）。而有了Docker Compose，我们就可以创建两个镜像：单独的应用镜像和MySQL镜像。在运行时，分别创建两个容器，并且将两个容器链接(link)在一起，使它们之间可以按照配置相互通信。这样就将我们的单体应用拆分成了多个组件构成的应用（其实这就是微服务的思想），从而更有利于服务间的解耦以及分布式架构的实现。</p>
<p>下面举一个例子，完整实现可见<a href="https://github.com/sczyh30/vertx-blueprint-todo-backend" target="_blank" rel="external">vertx-blueprint-todo-backend | GitHub</a>。现有一服务<code>Vert.x Blueprint Todo Backend</code>已打包成jar包，该服务以Redis作为数据存储。该服务以及Redis监听的地址和端口通过JSON配置文件来提供。我们可以设计两个镜像：服务镜像（通过<code>Dockerfile</code>构建）以及官方Redis镜像，运行时分别创建一个容器实例，然后通过Docker Compose将两个容器组合起来。首先来看一下我们的<code>Dockerfile</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FROM</span> java:<span class="number">8</span>-jre</span><br><span class="line"></span><br><span class="line"><span class="built_in">ENV</span> VERTICLE_FILE build/libs/vertx-blueprint-todo-backend-fat.jar</span><br><span class="line"></span><br><span class="line"><span class="built_in">ENV</span> VERTICLE_HOME /usr/verticles</span><br><span class="line"></span><br><span class="line"><span class="built_in">EXPOSE</span> <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">COPY</span> <span class="bash"><span class="variable">$VERTICLE_FILE</span> <span class="variable">$VERTICLE_HOME</span>/</span><br><span class="line"></span><span class="built_in">COPY</span> <span class="bash">config/config_docker.json <span class="variable">$VERTICLE_HOME</span>/</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">WORKDIR</span> <span class="bash"><span class="variable">$VERTICLE_HOME</span></span><br><span class="line"></span><span class="built_in">ENTRYPOINT</span> <span class="bash">[<span class="string">"sh"</span>, <span class="string">"-c"</span>]</span><br><span class="line"></span><span class="built_in">CMD</span> <span class="bash">[<span class="string">"java -jar vertx-blueprint-todo-backend-fat.jar -conf config_docker.json"</span>]</span></span><br></pre></td></tr></table></figure>
<p>服务容器运行时对外暴露8082端口。再看一下服务配置文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">service.type</span>": <span class="value"><span class="string">"redis"</span></span>,</span><br><span class="line">  "<span class="attribute">http.port</span>": <span class="value"><span class="number">8082</span></span>,</span><br><span class="line">  "<span class="attribute">http.address</span>": <span class="value"><span class="string">"0.0.0.0"</span></span>,</span><br><span class="line">  "<span class="attribute">redis.host</span>": <span class="value"><span class="string">"redis"</span></span>,</span><br><span class="line">  "<span class="attribute">redis.port</span>": <span class="value"><span class="number">6379</span></span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>注意我们将Redis的host设为<code>redis</code>，这个<code>redis</code>是对应的访问路径，后面会提到。下面来看Docker Compose的配置文件<code>docker-compose.yml</code>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">version: &#34;2&#34;&#10;services:&#10;  redis:&#10;    container_name: vertx-todo-backend_redis&#10;    image: redis:latest&#10;    expose:&#10;      - &#34;6379&#34;&#10;&#10;  vertx-todo-backend:&#10;    depends_on:&#10;      - redis&#10;    container_name: vertx-todo-backend_service&#10;    build: .&#10;    links:&#10;      - redis&#10;    ports:&#10;      - &#34;8082:8082&#34;</span><br></pre></td></tr></table></figure>
<p>其中<code>version: &quot;2&quot;</code>代表对应镜像版本，最新的需要Docker 1.10.0支持。在<code>services</code>中，我们定义了两个<code>service</code>：<code>redis</code>和<code>vertx-todo-backend</code>。</p>
<p>先来看<code>redis</code>中的配置。<code>container_name</code>代表容器名称，<code>image</code>代表对应的镜像，<code>expose</code>代表在集群内暴露的端口号（不对外暴露）。其它容器通过服务名<code>redis</code>访问此镜像。</p>
<p>再来看<code>vertx-todo-backend</code>。我们的服务需要依赖Redis，因此容器的启动顺序应该是<code>redis -&gt; vertx-todo-backend</code>，因此我们配置了<code>depends_on</code>选项，此选项下的所有容器都将会在本容器启动之前启动（注意只是启动，并不是其它容器初始化完成后本容器才启动。如果需要等待其它容器初始化完毕，则需要另写脚本）。<code>build</code>对应着<code>Dockerfile</code>文件的路径，<code>links</code>代表链接的镜像，<code>ports</code>代表对外暴露的端口。</p>
<p>配置好以后，我们在目录下执行<code>docker-compose up --build</code>，一会就可以看到容器集群运行起来了，非常方便。</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/vbptds-docker-compose-running.png" alt="Docker Compose"></p>
<p>更多的有关Docker Compose的信息，参考<a href="https://docs.docker.com/compose/" target="_blank" rel="external">官方文档</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Architecture/">Architecture</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/容器/">容器</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微服务/">微服务</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-gradle-annotation-processing-vertx-codegen" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Develop/gradle-annotation-processing-vertx-codegen/" class="article-date">
      <time datetime="2016-05-17T16:00:00.000Z" itemprop="datePublished">2016-05-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Develop/gradle-annotation-processing-vertx-codegen/">在Gradle中使用Annotation Processing Tool | Vert.x Codegen 示例</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在Maven中，我们可以很方便地利用 <em>Annotation Processing Tool(APT)</em> 来生成代码，配置简洁明了。比如在Maven中配置<a href="https://github.com/vert-x3/vertx-codegen" target="_blank" rel="external">Vert.x Codegen</a>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">pluginManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">plugins</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Configure the execution of the compiler to execute the codegen processor --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="title">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="title">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="title">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="tag">&lt;/<span class="title">encoding</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">id</span>&gt;</span>default-compile<span class="tag">&lt;/<span class="title">id</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="title">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">annotationProcessors</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">annotationProcessor</span>&gt;</span>io.vertx.codegen.CodeGenProcessor<span class="tag">&lt;/<span class="title">annotationProcessor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">annotationProcessors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">compilerArgs</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="title">arg</span>&gt;</span>-AoutputDirectory=$&#123;project.basedir&#125;/src/main<span class="tag">&lt;/<span class="title">arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">compilerArgs</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="title">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="title">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">pluginManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>而Gradle就不是那么方便了，官方文档里没有讲，各种插件又不太好使，因此自己摸索了摸索。其实，我们只要搞明白<code>APT</code>的处理过程，一切问题就迎刃而解了。在编译阶段，我们可以通过<code>-processor</code>来配置对应的注解处理器，并将注解处理器的包文件加到<code>CLASSPATH</code>中。因此，我们可以在Gradle中写一个task来处理注解：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">task</span> annotationProcessing(type: JavaCompile, <span class="keyword">group</span>: <span class="string">'build'</span>) &#123;</span><br><span class="line">  <span class="keyword">source</span> = <span class="keyword">sourceSets</span>.main.java</span><br><span class="line">  <span class="keyword">classpath</span> = <span class="keyword">configurations</span>.<span class="keyword">compile</span></span><br><span class="line">  <span class="keyword">destinationDir</span> = <span class="keyword">project</span>.<span class="keyword">file</span>(<span class="string">'src/main/generated'</span>)</span><br><span class="line">  <span class="keyword">options</span>.compilerArgs = [</span><br><span class="line">    <span class="string">"-proc:only"</span>,</span><br><span class="line">    <span class="string">"-processor"</span>, <span class="string">"xxx.yyy.zzzProcessor"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>source</code>代表源代码目录，<code>classpath</code>设为所有的依赖，<code>destinationDir</code>代表输出路径，<code>options.compilerArgs</code>代表<code>javac</code>的配置项。</p>
<p>下面我们来看一个例子：如何在Gradle中使用Vert.x Codegen。首先先写处理注解的task：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">task</span> annotationProcessing(type: JavaCompile, <span class="keyword">group</span>: <span class="string">'build'</span>) &#123;</span><br><span class="line">  <span class="keyword">source</span> = <span class="keyword">sourceSets</span>.main.java</span><br><span class="line">  <span class="keyword">classpath</span> = <span class="keyword">configurations</span>.<span class="keyword">compile</span></span><br><span class="line">  <span class="keyword">destinationDir</span> = <span class="keyword">project</span>.<span class="keyword">file</span>(<span class="string">'src/main/generated'</span>)</span><br><span class="line">  <span class="keyword">options</span>.compilerArgs = [</span><br><span class="line">    <span class="string">"-proc:only"</span>,</span><br><span class="line">    <span class="string">"-processor"</span>, <span class="string">"io.vertx.codegen.CodeGenProcessor"</span>,</span><br><span class="line">    <span class="string">"-AoutputDirectory=$&#123;destinationDir.absolutePath&#125;"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意Vert.x Codegen要设定<code>outputDirectory</code>项（输出路径）方可生成代码。</p>
<p>下面我们在 <code>compileJava</code> 中引用 <code>annotationProcessing</code> ：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">compileJava &#123;</span><br><span class="line">  <span class="keyword">targetCompatibility</span> = <span class="number">1.8</span></span><br><span class="line">  <span class="keyword">sourceCompatibility</span> = <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">  dependsOn annotationProcessing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在进行构建的时候，Gradle就可以利用APT来处理注解，生成代码了。如果要引用这些生成的代码，还要把它们加到源码路径中：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sourceSets</span> &#123;</span><br><span class="line">  main &#123;</span><br><span class="line">    java &#123;</span><br><span class="line">      srcDirs += <span class="string">'src/main/generated'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Develop/">Develop</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APT/">APT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gradle/">Gradle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vert-x/">Vert.x</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-circuit-breaker-pattern" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Microservice/circuit-breaker-pattern/" class="article-date">
      <time datetime="2016-05-05T16:00:00.000Z" itemprop="datePublished">2016-05-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Microservice/circuit-breaker-pattern/">微服务设计模式 | Circuit Breaker Pattern</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在分布式环境中，我们的应用可能会面临着各种各样的可恢复的异常（比如超时，网络环境异常），此时我们可以利用不断重试的方式来从异常中恢复(Retry Pattern)，使整个集群正常运行。</p>
<p>然而，也有一些异常比较顽固，突然发生，无法预测，而且很难恢复，并且还会导致级联失败（举个例子，假设一个服务集群的负载非常高，如果这时候集群的一部分挂掉了，还占了很大一部分资源，整个集群都有可能遭殃）。如果我们这时还是不断进行重试的话，结果大多都是失败的。因此，此时我们的应用需要立即进入失败状态(fast-fail)，并采取合适的方法进行恢复。</p>
<p><strong>Circuit Breaker Pattern</strong>（熔断器模式）就是这样的一种设计思想。它可以防止一个应用不断地去尝试一个很可能失败的操作。一个Circuit Breaker相当于一个代理，用于监测某个操作对应的失败比率(<code>fail / fail + success</code>)。它会根据得到的数据来决定是否允许执行此操作，或者是立即抛出异常。</p>
<h1 id="Circuit_Breaker原理">Circuit Breaker原理</h1><p>我们可以用状态机来实现Circuit Breaker，它有以下三种状态：</p>
<ul>
<li>关闭(<strong>Closed</strong>)：默认情况下Circuit Breaker是关闭的，此时允许操作执行。Circuit Breaker内部记录着最近失败的次数，如果对应的操作执行失败，次数就会续一次。如果在某个时间段内，失败次数（或者失败比率）达到阈值，Circuit Breaker会转换到开启(<strong>Open</strong>)状态。在开启状态中，Circuit Breaker会启用一个超时计时器，设这个计时器的目的是给集群相应的时间来恢复故障。当计时器时间到的时候，Circuit Breaker会转换到半开启(<strong>Half-Open</strong>)状态。</li>
<li>开启(<strong>Open</strong>)：在此状态下，执行对应的操作将会立即失败并且立即抛出异常。</li>
<li>半开启(<strong>Half-Open</strong>)：在此状态下，Circuit Breaker会允许执行一定数量的操作。如果所有操作全部成功，Circuit Breaker就会假定故障已经恢复，它就会转换到关闭状态，并且重置失败次数。如果其中 <strong>任意一次</strong> 操作失败了，Circuit Breaker就会认为故障仍然存在，所以它会转换到开启状态并再次开启计时器（再给系统一些时间使其从失败中恢复）。</li>
</ul>
<p>Circuit Breaker的状态图：</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/circuit-breaker-states.png" alt="Circuit Breaker Pattern States"></p>
<h1 id="简单实现">简单实现</h1><p><em>TODO</em></p>
<hr>
<h1 id="Reference">Reference</h1><ul>
<li><em>Cloud Design Patterns</em>, Microsoft</li>
<li><a href="http://martinfowler.com/bliki/CircuitBreaker.html" target="_blank" rel="external">CircuitBreaker | Martin Fowler</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Microservice/">Microservice</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云服务/">云服务</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微服务/">微服务</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-type-system-existential-types-scala-java" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Functional-Programming/type-system-existential-types-scala-java/" class="article-date">
      <time datetime="2016-04-25T16:00:00.000Z" itemprop="datePublished">2016-04-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Functional-Programming/type-system-existential-types-scala-java/">类型系统 | Existential Type | Scala ++ Java ++ Haskell</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><strong>Existential type</strong>(存在类型)提供了一种在类型系统上抽象的方式，其中<strong>existential type</strong>这个名称源于<strong>existential quantification</strong>(全称量词，数学符号<code>∃</code>)。可以这样理解：某种形式的类型存在，但是在上下文中不知道它的具体类型。比如我们定义一种类型<code>type T = ∃x {a: x; f: (x =&gt; Int);}</code>，它可以表示这种类型有一个类型为<code>x</code>的成员变量a，一个类型为<code>x =&gt; Int</code>的成员函数f，而类型<code>x</code>是任意的。</p>
<p>这篇文章我们来探讨一下existential type在Java、Scala和Haskell中的运用。</p>
<h1 id="Existential_type_in_Java">Existential type in Java</h1><p>Existential Type在Java如此烂的类型系统中发挥着重要的作用。Java泛型中的<strong>Wildcards</strong>(占位符)其实就是一种existential type，比如<code>java.util.List&lt;?&gt;</code>。</p>
<p>由于JVM在编译时会对type parameters进行类型擦除，让它们回归为raw types，因此很多人认为existential type就相当于raw types，比如<code>List =:= List&lt;?&gt;</code>，这是不正确的。它们两种类型最大的区别就是existential type是type safe的，而raw types则不是。在将一个具化的泛型扒掉所有的type parameters的时候，后者是不安全的。我们测试一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Existential</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="string">"Java"</span>, <span class="string">"sucks"</span>));</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">t1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		List a = list;</span><br><span class="line">		a.forEach(System.out::println);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">t2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		List&lt;?&gt; b = list;</span><br><span class="line">		b.forEach(System.out::println);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		t1();</span><br><span class="line">		t2();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译一下，编译器会提示t1方法不安全，而t2则无警告：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">λ javac ./Existential.java -Xlint:unchecked</span><br><span class="line">./Existential.java:<span class="number">11</span>: 警告: [unchecked] 对作为原始类型Iterable的成员的forEach(Consumer&lt;? <span class="keyword">super</span> T&gt;)的调用未经过检查</span><br><span class="line">                a.forEach(System.out::println);</span><br><span class="line">                         ^</span><br><span class="line">  其中, T是类型变量:</span><br><span class="line">    T扩展已在接口 Iterable中声明的Object</span><br><span class="line"><span class="number">1</span> 个警告</span><br></pre></td></tr></table></figure>
<p>因此我们要避免使用原始类型。(貌似越写越偏了。。那就顺便总结一下Java的Bounded Wildcards吧:)</p>
<p>Java通过 <strong>Bounded Wildcards</strong>（限定通配符）来实现有限的可变性(variance)，比如</p>
<ul>
<li><code>List&lt;? extends Object&gt;</code>（协变, covariance）</li>
<li><code>List&lt;? super User&gt;</code>（逆变, contravariance）</li>
<li><code>List&lt;?&gt;</code>（不可变, invariance）</li>
</ul>
<p>注意我们无法给限定通配符的List添加任何对象，因为它的类型参数无法确定（这即是existential的含义）。我们可以在方法参数中使用Bounded Wildcards来达到协变和逆变的效果，使用时遵循 <strong>PECS原则</strong> (Producer Extends, Consumer Super)。</p>
<p>注：这里的variance其实是一种<strong>use-site variance</strong>，后边有时间探究一下它与<strong>declaration-site variance</strong>的区别。</p>
<h1 id="Existential_type_in_Scala">Existential type in Scala</h1><p>Scala同样兼容Java的这种use-site variance，语法有两种。一种和Java类似，一种是完整表示方法（<code>forSome</code>关键字）。举个例子：</p>
<table>
<thead>
<tr>
<th>简单表示</th>
<th>完整表示</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Seq[_]</code></td>
<td><code>Seq[T] forSome {type T}</code></td>
<td>T可以是Any类型的任意子类</td>
</tr>
<tr>
<td><code>Seq[_ &lt;: A]</code></td>
<td><code>Seq[T] forSome {type T &lt;: A}</code></td>
<td>T可以是A类型的任意子类</td>
</tr>
<tr>
<td><code>Seq[_ &gt;: Z &lt;: A]</code></td>
<td><code>Seq[T] forSome {type T &gt;: Z &lt;: A}</code></td>
<td>T可以是A类型的任意子类，同时需要是Z类型的父类</td>
</tr>
</tbody>
</table>
<h1 id="Existential_type_in_Haskell">Existential type in Haskell</h1><p>在GHC中使用Existential Types需要开启扩展(<code>-XExistentialQuantification</code>)。Haskell中的Existential Type通过<code>forall</code>关键字来实现。但是，<code>forall</code>代表全称量词<code>∀</code>，这似乎和existential type的含义是对立的，是不是很神奇呢？我们将在稍后解释。这里我们先来看一下我们最熟悉的<code>map</code>函数：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">map</span> :: (a -&gt; b) -&gt; [a] -&gt; [b]</span><br></pre></td></tr></table></figure>
<p>我们还可以通过全称量化的方法构造map：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">map</span> :: <span class="keyword">forall</span> a b. (a -&gt; b) -&gt; [a] -&gt; [b]</span><br></pre></td></tr></table></figure></p>
<p>这两个map的定义是等价的。其实在Haskell中，很多类型的定义都是隐式地使用了<code>forall</code>。</p>
<p>再比如下边的例子定义了可以show的existential type：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="pragma">&#123;-# LANGUAGE ExistentialQuantification #-&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="typedef"><span class="keyword">data</span> <span class="type">ShowObj</span> = forall a. <span class="type">Show</span> a =&gt; <span class="type">S</span> a</span></span><br><span class="line"><span class="class"></span><br><span class="line"><span class="keyword">instance</span> <span class="type">Show</span> <span class="type">ShowObj</span> <span class="keyword">where</span></span></span><br><span class="line">	show (<span class="type">S</span> a) = show a</span><br><span class="line"></span><br><span class="line"><span class="title">li</span> :: [<span class="type">ShowObj</span>]</span><br><span class="line"><span class="title">li</span>  = [<span class="type">S</span> <span class="number">1</span>, <span class="type">S</span> <span class="string">"Java"</span>, <span class="type">S</span> <span class="string">"sucks"</span>, <span class="type">S</span> <span class="type">True</span>, <span class="type">S</span> ()]</span><br><span class="line"></span><br><span class="line"><span class="title">f</span> :: [<span class="type">ShowObj</span>] -&gt; <span class="type">IO</span> ()</span><br><span class="line"><span class="title">f</span> xs = mapM_ print xs</span><br><span class="line"></span><br><span class="line"><span class="title">main</span> = f li</span><br></pre></td></tr></table></figure>
<p>下面我们来探究一下<code>existential</code>和<code>forall</code>的真正含义。我们可以将类型看作是某些值的集合，比如<code>Bool</code>类型对应集合<code>{True, False, ⊥}</code>，<code>Integer</code>对应数的集合。注意bottom(<code>⊥</code>)属于每一个类型。</p>
<p><code>forall</code>代表这些集合的交集。我们举一些例子：</p>
<ul>
<li><code>forall a. a</code>是所有类型的交集，也就是<code>{⊥}</code></li>
<li><code>[forall a. Show a =&gt; a]</code>代表一种所含元素均为<code>forall a. Show a =&gt; a</code>类型的列表类型，<code>Show</code> Typeclass限定了只能在<code>Show</code>的instance里取交集</li>
</ul>
<p>我们随便定义一个existential datatype(下面我们用<code>∀</code>代替forall，用<code>∃</code>代替exists)：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="typedef"><span class="keyword">data</span> <span class="type">T</span> = ∀ a. <span class="type">MkT</span> a</span></span><br></pre></td></tr></table></figure></p>
<p>其中MkT的含义是产生一个T类型：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MkT</span> :: <span class="keyword">forall</span> a. a -&gt; <span class="type">T</span></span><br><span class="line"><span class="type">MkT</span> :: a -&gt; <span class="type">T</span> <span class="comment">&#123;- 等价 -&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>那么当我们对MkT进行解构的时候又会发生什么呢？比如进行模式匹配的时候：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">f</span> (<span class="type">MkT</span> x) = ...</span><br></pre></td></tr></table></figure></p>
<p>此时<code>x</code>的类型可以是任意的，也就是说我们可以用存在量词来表示x：<code>x :: ∃ a. a</code>。我们知道存在这种类型x，但不清楚x的真正类型。这样的定义<strong>同构</strong>于上边我们用全称量词的定义，即这两种定义等价：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="typedef"><span class="keyword">data</span> <span class="type">T</span> = ∀ a. <span class="type">MkT</span> a</span></span><br><span class="line"></span><br><span class="line"><span class="typedef"><span class="keyword">data</span> <span class="type">T</span> = <span class="type">MkT</span> <span class="container">(∃ <span class="title">a</span>. <span class="title">a</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>而Haskell选择了前者的表达方式(<code>forall</code>)，即在Haskell中existential type通过<code>forall</code>关键字来实现。（为何不用<code>exists</code>？我也不清楚。。）</p>
<p>所以现在再回头来看我们之前定义的<code>ShowObj</code>类型，我们可以把它转化为用存在量词表达的existential type:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="typedef"><span class="keyword">data</span> <span class="type">ShowObj</span> = forall a. <span class="type">Show</span> a =&gt; <span class="type">S</span> a</span></span><br><span class="line"></span><br><span class="line"><span class="typedef"><span class="keyword">data</span> <span class="type">ShowObj'</span> = <span class="type">S'</span> <span class="container">(<span class="title">exists</span> <span class="title">a</span>. <span class="type">Show</span> <span class="title">a</span> =&gt; <span class="title">a</span>)</span> <span class="container">&#123;- <span class="type">Haskell</span>里不能这么写 -&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>在Haskell各种类库中existential type用的非常多，例如<code>Control.Monad.ST</code>中的<code>runST</code>：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">runST</span> :: <span class="keyword">forall</span> α. (<span class="keyword">forall</span> s. <span class="type">ST</span> s α) -&gt; α</span><br></pre></td></tr></table></figure></p>
<p>这里先不展开写了，后边有时间多实践实践再说。。。</p>
<h1 id="Heterogeneous_List">Heterogeneous List</h1><p><strong>待填坑</strong>。。Miles Sabin大神的Shapeless库中的 <strong>Heterogeneous List(HList)</strong> 值得一读。。</p>
<h1 id="Reference">Reference</h1><ul>
<li><em>Scala Language Specification</em>, 3.2.10</li>
<li><a href="https://en.wikibooks.org/wiki/Haskell/Existentially_quantified_types" target="_blank" rel="external">Haskell/Existentially quantified types</a></li>
<li><a href="http://typelevel.org/blog/2015/02/26/rawtypes.html" target="_blank" rel="external">Existential types are not raw types</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Functional-Programming/">Functional Programming</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functional-Programming/">Functional Programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Haskell/">Haskell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scala/">Scala</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Type-System/">Type System</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-vertx-instance-internal-and-create" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Asynchronous/vertx-instance-internal-and-create/" class="article-date">
      <time datetime="2016-04-20T16:00:00.000Z" itemprop="datePublished">2016-04-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Asynchronous/vertx-instance-internal-and-create/">Vert.x 异步编程 | Vertx实例的创建流程及内部实现</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在Vert.x中，<code>Vertx</code>接口是最为重要的一个接口，vertx-core的基础功能都在此接口中提供。这篇文章中我们就来分析一下<code>Vertx</code>接口体系的内部实现以及创建流程。本文对应Vert.x的版本为 <strong>3.2.1</strong>。</p>
<h1 id="Vertx接口体系">Vertx接口体系</h1><p>我们来看一下<code>Vertx</code>接口的UML关系：</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/vertximpl-class-hc.png" alt=""></p>
<p>可以看到有<code>VertxImpl &lt;:&lt; VertxInternal &lt;:&lt; Vertx</code>这个继承链。这里我们先不研究<code>Measured</code>和<code>MetricsProvider</code>这两个接口。我们先来看一下<code>VertxInternal</code>的结构：</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/vertxInternal-structure.png" alt=""></p>
<p>可以看到里边包含了各种操作多线程、执行回调等等的方法。<code>VertxInternal</code>接口仅供vertx-core内部调用。</p>
<p><code>VertxImpl</code>类是对<code>VertxInternal</code>和<code>Vertx</code>接口的实现。我们创建的Vertx实例都是<code>VertxImpl</code>。</p>
<h1 id="Vertx创建流程以及内部实现">Vertx创建流程以及内部实现</h1><p>通常，我们都会通过<code>Vertx</code>接口中的静态方法<code>vertx</code>创建Vertx实例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vertx vertx = Vertx.vertx();</span><br></pre></td></tr></table></figure></p>
<p><code>vertx</code>方法底层通过工厂模式创建VertxImpl实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Vertx <span class="title">vertx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> factory.vertx();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VertxFactoryImpl</span> <span class="keyword">implements</span> <span class="title">VertxFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Vertx <span class="title">vertx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> VertxImpl();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来探究一下<code>VertxImpl</code>类的创建流程和内部实现。我们首先来看一下<code>VertxImpl</code>类的实例成员：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FileSystem fileSystem = getFileSystem();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SharedData sharedData;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> VertxMetrics metrics;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Long, InternalTimerHandler&gt; timeouts = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong timeoutCounter = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ClusterManager clusterManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DeploymentManager deploymentManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FileResolver fileResolver;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ServerID, HttpServerImpl&gt; sharedHttpServers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ServerID, NetServerImpl&gt; sharedNetServers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExecutorService workerPool;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExecutorService internalBlockingPool;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OrderedExecutorFactory workerOrderedFact;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OrderedExecutorFactory internalOrderedFact;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadFactory eventLoopThreadFactory;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NioEventLoopGroup eventLoopGroup;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> NioEventLoopGroup acceptorEventLoopGroup;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockedThreadChecker checker;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> haEnabled;</span><br><span class="line"><span class="keyword">private</span> EventBus eventBus;</span><br><span class="line"><span class="keyword">private</span> HAManager haManager;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> closed;</span><br></pre></td></tr></table></figure></p>
<p>这里面包含了一系列重要的类。我们将在初始化部分来分析这些成员的作用。下面我们来看一下构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VertxImpl() &#123;</span><br><span class="line">  <span class="keyword">this</span>(<span class="keyword">new</span> VertxOptions());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VertxImpl(VertxOptions options) &#123;</span><br><span class="line">  <span class="keyword">this</span>(options, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VertxImpl(VertxOptions options, Handler&lt;AsyncResult&lt;Vertx&gt;&gt; resultHandler) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到最终都会调用到<code>VertxImpl(VertxOptions options, Handler&lt;AsyncResult&lt;Vertx&gt;&gt; resultHandler)</code>这个构造函数，下面我们就来分析一下。</p>
<p>首先，Vertx会检查当前是否有Vertx实例运行（通过<code>factory.context()</code>方法）。如果有实例运行的话就会给出警告。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sanity check</span></span><br><span class="line"><span class="keyword">if</span> (Vertx.currentContext() != <span class="keyword">null</span>) &#123;</span><br><span class="line">  log.warn(<span class="string">"You're already on a Vert.x context, are you sure you want to create a new Vertx instance?"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着Vertx会初始化<code>checker</code>成员，它是一个<code>BlockedThreadChecker</code>，作用是检查vertx context中是否有阻塞的线程，如果有线程阻塞则给出警告。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">checker = <span class="keyword">new</span> BlockedThreadChecker(options.getBlockedThreadCheckInterval(), options.getMaxEventLoopExecuteTime(),</span><br><span class="line">                                   options.getMaxWorkerExecuteTime(), options.getWarningExceptionTime());</span><br></pre></td></tr></table></figure></p>
<p>接下来，Vertx会初始化EventLoop线程工厂<code>eventLoopThreadFactory</code>，它用于产生EventLoop线程。然后初始化<code>eventLoopGroup</code>并进行配置。<code>NioEventLoopGroup</code>是Netty里的概念，将在稍后进行介绍。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eventLoopThreadFactory = <span class="keyword">new</span> VertxThreadFactory(<span class="string">"vert.x-eventloop-thread-"</span>, checker, <span class="keyword">false</span>);</span><br><span class="line">eventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup(options.getEventLoopPoolSize(), eventLoopThreadFactory);</span><br><span class="line">eventLoopGroup.setIoRatio(NETTY_IO_RATIO);</span><br></pre></td></tr></table></figure></p>
<p>接下来，Vertx会初始化Acceptor EventLoop线程工厂，并对其进行配置。然后对<code>workerPool</code>和<code>internalBlockingPool</code>这两个线程池进行初始化。其中<code>workerPool</code>用于执行worker线程，<code>internalBlockingPool</code>用于执行阻塞操作线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ThreadFactory acceptorEventLoopThreadFactory = <span class="keyword">new</span> VertxThreadFactory(<span class="string">"vert.x-acceptor-thread-"</span>, checker, <span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// The acceptor event loop thread needs to be from a different pool otherwise can get lags in accepted connections</span></span><br><span class="line"><span class="comment">// under a lot of load</span></span><br><span class="line">acceptorEventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>, acceptorEventLoopThreadFactory);</span><br><span class="line">acceptorEventLoopGroup.setIoRatio(<span class="number">100</span>);</span><br><span class="line">workerPool = Executors.newFixedThreadPool(options.getWorkerPoolSize(),</span><br><span class="line">                                          <span class="keyword">new</span> VertxThreadFactory(<span class="string">"vert.x-worker-thread-"</span>, checker, <span class="keyword">true</span>));</span><br><span class="line">internalBlockingPool = Executors.newFixedThreadPool(options.getInternalBlockingPoolSize(),</span><br><span class="line">                                                    <span class="keyword">new</span> VertxThreadFactory(<span class="string">"vert.x-internal-blocking-"</span>, checker, <span class="keyword">true</span>));</span><br></pre></td></tr></table></figure></p>
<p>然后，Vertx会初始化两个线程池工厂<code>workerOrderedFact</code>和<code>internalOrderedFact</code>，它们的类型是<code>OrderedExecutorFactory</code>，里边包含一种能够按照次序执行线程的线程池。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workerOrderedFact = <span class="keyword">new</span> OrderedExecutorFactory(workerPool);</span><br><span class="line">internalOrderedFact = <span class="keyword">new</span> OrderedExecutorFactory(internalBlockingPool);</span><br></pre></td></tr></table></figure></p>
<p>接下来，Vertx会依次对文件解析器<code>fileResolver</code>、部署管理器<code>deploymentManager</code>、SPI管理器<code>metrics</code>进行初始化，并且根据配置来决定是否初始化集群管理器<code>clusterManager</code>和高可用管理器<code>haManager</code>。然后Vertx会调用<code>createAndStartEventBus(options, resultHandler)</code>方法，创建并启动EventBus。最后对共享数据成员<code>sharedData</code>进行初始化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.fileResolver = <span class="keyword">new</span> FileResolver(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">this</span>.deploymentManager = <span class="keyword">new</span> DeploymentManager(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">this</span>.metrics = initialiseMetrics(options);</span><br><span class="line"><span class="keyword">this</span>.haEnabled = options.isClustered() &amp;&amp; options.isHAEnabled();</span><br><span class="line"><span class="keyword">if</span> (options.isClustered()) &#123;</span><br><span class="line">  <span class="keyword">this</span>.clusterManager = getClusterManager(options);</span><br><span class="line">  <span class="keyword">this</span>.clusterManager.setVertx(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>.clusterManager.join(ar -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ar.failed()) &#123;</span><br><span class="line">      log.error(<span class="string">"Failed to join cluster"</span>, ar.cause());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Provide a memory barrier as we are setting from a different thread</span></span><br><span class="line">      <span class="keyword">synchronized</span> (VertxImpl.<span class="keyword">this</span>) &#123;</span><br><span class="line">        haManager = <span class="keyword">new</span> HAManager(<span class="keyword">this</span>, deploymentManager, clusterManager, options.getQuorumSize(),</span><br><span class="line">                                  options.getHAGroup(), haEnabled);</span><br><span class="line">        createAndStartEventBus(options, resultHandler);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.clusterManager = <span class="keyword">null</span>;</span><br><span class="line">  createAndStartEventBus(options, resultHandler);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.sharedData = <span class="keyword">new</span> SharedDataImpl(<span class="keyword">this</span>, clusterManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>经过一系列的构造后，<code>VertxImpl</code>创建完成。</p>
<p>未完待续！</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Asynchronous/">Asynchronous</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vert-x/">Vert.x</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/异步编程/">异步编程</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-play-framework-2-5-summary-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Scala/play-framework-2-5-summary-1/" class="article-date">
      <time datetime="2016-04-16T16:00:00.000Z" itemprop="datePublished">2016-04-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Scala/play-framework-2-5-summary-1/">Play Framework 2.5 | Web开发总结(1)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>Samsara Aquarius已完成，是时候总结一下Play Framework的一些有用的东西和一些坑了～这里对应的Play版本为 <strong>2.5.2</strong>。</p>
<h1 id="Action,_Controller_和_Result">Action, Controller 和 Result</h1><p>在Play的Web开发中，<strong>Action</strong>, <strong>Controller</strong> 和 <strong>Result</strong> 这三个东西最为重要了。我们一个一个来解释：</p>
<h2 id="Result">Result</h2><p><code>Result</code>代表HTTP请求的结果，它包含header和body两部分。Play内部封装了常见的HTTP response状态，可以在这些Status的基础上生成Result，比如<code>200 OK</code>：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Generates a ‘200 OK’ result. */</span></span><br><span class="line"><span class="function"><span class="keyword">val</span> <span class="title">Ok</span> =</span> <span class="keyword">new</span> <span class="type">Status</span>(<span class="type">OK</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="Action">Action</h2><p>每个Action相当于一个<code>Request =&gt; Result</code>类型（处理请求并返回结果）的函数，即每个Action都接受一个<code>Request</code>对象（代表HTTP请求），并产生<code>Result</code>对象（代表HTTP回应）。</p>
<p>关于Action的详细实现，后边我还会专门写一篇文章分析，这里先粗略总结一下。</p>
<h2 id="Controller">Controller</h2><p>在Play中，Controller里的函数用于生成Action。其实Action就相当于处理请求的函数，只不过将普通的函数包装了一层而已（继承关系：<code>Action &lt;:&lt; EssentialAction &lt;:&lt; (RequestHeader =&gt; Accumulator[ByteString, Result])</code>），因此调用这些函数其实就是在调用Action中包装的函数。</p>
<h1 id="Session、Cookie与Flash">Session、Cookie与Flash</h1><p>Play中处理Session、Cookie的语法都比较简洁。比如Cookie的添加与删除：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">val</span> <span class="title">res1</span> =</span> <span class="type">Ok</span>(<span class="string">"Good Scala"</span>) withCookies <span class="type">Cookie</span>(<span class="string">"fuck"</span>, <span class="string">"shit"</span>)</span><br><span class="line"><span class="function"><span class="keyword">val</span> <span class="title">res2</span> =</span> res1.discardingCookies(<span class="type">DiscardingCookie</span>(<span class="string">"fuck"</span>))</span><br></pre></td></tr></table></figure>
<p>Session的使用也类似：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">val</span> <span class="title">res2</span> =</span> <span class="type">Ok</span>(<span class="string">"Good Scala"</span>) withSession <span class="type">Session</span>(<span class="string">"fuck"</span>, <span class="string">"shit"</span>)</span><br><span class="line"><span class="function"><span class="keyword">val</span> <span class="title">res_rm</span> =</span> res2 withNewSession <span class="comment">// clear session</span></span><br></pre></td></tr></table></figure>
<p>但是Play里的session有个坑，它没实现expiration的功能，因此需要我们自己在session中加个时间戳，然后自己实现expiration的逻辑。</p>
<p>另外还有个<strong>大坑</strong>！如果需要添加session的话，需要这样：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Ok</span>(<span class="string">"Good Scala"</span>) withSession (request.session + <span class="type">Session</span>(<span class="string">"fuck"</span>, <span class="string">"shit"</span>))</span><br></pre></td></tr></table></figure></p>
<p>因为<code>withSession(s)</code>方法会将<code>s</code>设为当前的session，原先的session将会被抹掉。<br>。所以一定要把原先的session加上，要不然原先的session会丢失。</p>
<p>Flash和Session类似，但Flash只在一个request内有效，多用于request之间数据的传递：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Ok</span>(<span class="string">"Good Scala"</span>) flashing <span class="string">"fuck"</span> -&gt; <span class="string">"shit"</span></span><br></pre></td></tr></table></figure></p>
<h1 id="自定义Action">自定义Action</h1><p>比如有一些逻辑中，我们需要验证用户是否登录，如果没有登录就自动跳转到登录界面。如果在每个Action中都写上登录验证逻辑的话会非常不优美，因此我们可以自定义一个<code>AuthenticatedAction</code>，里面包装了权限验证的逻辑：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">AuthenticatedAction</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">ActionBuilder</span>[</span><span class="type">Request</span>] &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">invokeBlock</span>[</span><span class="type">A</span>](request: <span class="type">Request</span>[<span class="type">A</span>],</span><br><span class="line">                              block: (<span class="type">Request</span>[<span class="type">A</span>]) =&gt; <span class="type">Future</span>[<span class="type">Result</span>]): <span class="type">Future</span>[<span class="type">Result</span>] = &#123;</span><br><span class="line">    utils.<span class="type">DateUtils</span>.ensureSession(request)</span><br><span class="line">    request.session.get(<span class="string">"user_token"</span>) <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Some</span>(u) =&gt;</span><br><span class="line">        block(request)</span><br><span class="line">      <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">        <span class="type">Future</span>.successful(<span class="type">Redirect</span>(routes.<span class="type">UserController</span>.loginIndex()))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们自定义的Action需要实现<code>ActionBuilder[Request]</code>接口，并重写<code>invokeBlock</code>函数。</p>
<h1 id="拦截器">拦截器</h1><p>在Play中使用Filter也非常方便。比如我们想给应用添加安全拦截器，我们可以写一个Filter：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.inject.<span class="type">Inject</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> play.api.http.<span class="type">HttpFilters</span></span><br><span class="line"><span class="keyword">import</span> play.filters.headers.<span class="type">SecurityHeadersFilter</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filters</span> <span class="title">@Inject</span>(</span>) (security: <span class="type">SecurityHeadersFilter</span>) <span class="keyword">extends</span> <span class="type">HttpFilters</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">filters</span> =</span> <span class="type">Seq</span>(security)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中我们通过依赖注入获取安全拦截器<code>SecurityHeadersFilter</code>实例。然后，我们在<code>application.conf</code>中配置拦截器：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">play.http.filters=filters.<span class="type">Filters</span></span><br></pre></td></tr></table></figure></p>
<hr>
<p>未完待续，还会不断补充。。。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Scala/">Scala</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Play-Framework/">Play Framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scala/">Scala</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web开发/">Web开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-type-system-refinement-types" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Functional-Programming/type-system-refinement-types/" class="article-date">
      <time datetime="2016-04-16T16:00:00.000Z" itemprop="datePublished">2016-04-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Functional-Programming/type-system-refinement-types/">类型系统 | Refinement Type</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>最近在看某个Slide的时候里了解到了Refinement type这个玩意儿，今天拿来总结总结。</p>
<h1 id="何为Refinement_Type">何为Refinement Type</h1><p>言简意赅的讲：</p>
<blockquote>
<p>Refinement Types = Types + Logical Predicates</p>
</blockquote>
<p>即Refinement Type是由类型和谓词逻辑组合而成的，其中谓词逻辑可以对类型的值域进行约束。也就是说，我们可以在原有类型的基础上给它加个值的限定，并且可以在编译时检测是否符合谓词逻辑限定。</p>
<p>下面我们来玩一下Haskell和Scala中典型的Refinement Type库。</p>
<h1 id="LiquidHaskell">LiquidHaskell</h1><p><a href="https://github.com/ucsd-progsys/liquidhaskell" target="_blank" rel="external">LiquidHaskell</a>是Haskell上一个基于Liquid Types的静态分析器，可以通过Refinement Type进行静态检查。安装的时候注意需要系统环境中有logic solvers(比如<code>z3</code>)。</p>
<p>下边我们来看看如何使用LiquidHaskell：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="module"><span class="keyword">module</span> RfT <span class="keyword">where</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#123;-@ zero'' :: &#123;v: Int | v &gt;= 0 &amp;&amp; v &lt; 24 &#125; @-&#125;</span></span><br><span class="line"><span class="title">zero'</span> :: <span class="type">Int</span></span><br><span class="line"><span class="title">zero'</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#123;-@ zero'' :: &#123;v: Int | v &gt; 5 &#125; @-&#125;</span></span><br><span class="line"><span class="title">zero''</span> :: <span class="type">Int</span></span><br><span class="line"><span class="title">zero''</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>我们定义了两个函数<code>zero&#39;</code>和<code>zero&#39;&#39;</code>，这两个函数的值都是0。我们在每个函数的声明前都加了一行谓词逻辑的限定，语法类似于：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;-@ f :: &#123;x: T | predicate &#125; @-&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>比如<code>{-@ zero&#39;&#39; :: {v: Int | v &gt; 5 } @-}</code>代表<code>zero&#39;&#39;</code>函数有一个类型为Int的参数，而且接受的值必须大于5，这就是谓词逻辑限定。我们运行一下看看结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ liquid --diff rft1.hs</span><br></pre></td></tr></table></figure></p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">LiquidHaskell</span> <span class="type">Copyright</span> <span class="number">2009</span>-<span class="number">15</span> <span class="type">Regents</span> <span class="keyword">of</span> the <span class="type">University</span> <span class="keyword">of</span> <span class="type">California</span>. <span class="type">All</span> <span class="type">Rights</span> <span class="type">Reserved</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**** <span class="type">DONE</span>:  <span class="type">Parsed</span> <span class="type">All</span> <span class="type">Specifications</span> ******************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**** <span class="type">DONE</span>:  <span class="type">Loaded</span> <span class="type">Targets</span> *****************************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**** <span class="type">DONE</span>:  <span class="type">Extracted</span> <span class="type">Core</span> using <span class="type">GHC</span> *******************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**** <span class="type">DONE</span>:  generateConstraints ************************************************</span><br><span class="line"></span><br><span class="line"><span class="type">Done</span> solving.</span><br><span class="line"><span class="type">Safe</span></span><br><span class="line"></span><br><span class="line">**** <span class="type">DONE</span>:  solve **************************************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**** <span class="type">DONE</span>:  annotate ***********************************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**** <span class="type">Checked</span> <span class="type">Binders</span>: <span class="type">None</span> *****************************************************</span><br><span class="line"></span><br><span class="line">**** <span class="type">RESULT</span>: <span class="type">UNSAFE</span> ************************************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> rft1.hs:<span class="number">10</span>:<span class="number">1</span>-<span class="number">6</span>: <span class="type">Error</span>: <span class="type">Liquid</span> <span class="type">Type</span> <span class="type">Mismatch</span></span><br><span class="line">  <span class="type">Inferred</span> <span class="typedef"><span class="keyword">type</span></span></span><br><span class="line">    <span class="type">VV</span> : &#123;<span class="type">VV</span> : <span class="type">GHC</span>.<span class="type">Types</span>.<span class="type">Int</span> | <span class="type">VV</span> == (<span class="number">0</span> : int)&#125;</span><br><span class="line"></span><br><span class="line">  not a subtype <span class="keyword">of</span> <span class="type">Required</span> <span class="typedef"><span class="keyword">type</span></span></span><br><span class="line">    <span class="type">VV</span> : &#123;<span class="type">VV</span> : <span class="type">GHC</span>.<span class="type">Types</span>.<span class="type">Int</span> | <span class="type">VV</span> &gt; <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">In</span> <span class="type">Context</span></span><br></pre></td></tr></table></figure>
<p>LiquidHaskell成功地检测出了错误 —— <code>zero&#39;&#39;</code>函数不符合谓词逻辑限定。</p>
<p>下边再举个对函数参数和返回值进行refine的例子：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;- Preconditions -&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#123;-@ divide :: Int -&gt; &#123;v: Int | v != 0 &#125; -&gt; Int @-&#125;</span></span><br><span class="line"><span class="title">divide</span> :: <span class="type">Int</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Int</span></span><br><span class="line"><span class="title">divide</span> n d = n `div` d</span><br><span class="line"></span><br><span class="line"><span class="title">f1</span> :: <span class="type">Int</span></span><br><span class="line"><span class="title">f1</span> = divide <span class="number">1</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="title">f2</span> :: <span class="type">Int</span></span><br><span class="line"><span class="title">f2</span> = divide <span class="number">1</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&#123;- Postconditions -&#125;</span></span><br><span class="line"><span class="comment">&#123;-@ abs' :: Int -&gt; &#123;v: Int | v &gt;= 0 &#125; @-&#125;</span></span><br><span class="line"><span class="title">abs'</span> :: <span class="type">Int</span> -&gt; <span class="type">Int</span></span><br><span class="line"><span class="title">abs'</span> n | n &gt; <span class="number">0</span> 	   = n</span><br><span class="line">	   | otherwise = <span class="number">0</span> - n</span><br></pre></td></tr></table></figure></p>
<p>验证结果符合我们的期望：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">rft1</span>.hs:<span class="number">19</span>:<span class="number">6</span>-<span class="number">15</span>: <span class="type">Error</span>: <span class="type">Liquid</span> <span class="type">Type</span> <span class="type">Mismatch</span></span><br><span class="line"></span><br><span class="line"><span class="number">19</span> | f1 = divide <span class="number">1</span> <span class="number">0</span></span><br><span class="line">          ^^^^^^^^^^</span><br><span class="line"></span><br><span class="line">  <span class="type">Inferred</span> <span class="typedef"><span class="keyword">type</span></span></span><br><span class="line">    <span class="type">VV</span> : &#123;<span class="type">VV</span> : <span class="type">GHC</span>.<span class="type">Types</span>.<span class="type">Int</span> | <span class="type">VV</span> == ?a&#125;</span><br><span class="line"></span><br><span class="line">  not a subtype <span class="keyword">of</span> <span class="type">Required</span> <span class="typedef"><span class="keyword">type</span></span></span><br><span class="line">    <span class="type">VV</span> : &#123;<span class="type">VV</span> : <span class="type">GHC</span>.<span class="type">Types</span>.<span class="type">Int</span> | <span class="type">VV</span> /= <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">In</span> <span class="type">Context</span></span><br><span class="line">    ?a := &#123;?a : <span class="type">GHC</span>.<span class="type">Types</span>.<span class="type">Int</span> | ?a == (<span class="number">0</span> : int)&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到LiquidHaskell可以验证函数的先验条件和后验条件。</p>
<p>至于其中的实现原理，可以参考这篇论文：<a href="http://goto.ucsd.edu/~rjhala/liquid/liquid_types.pdf" target="_blank" rel="external">Liquid Types</a>（数学推导太多，没看懂&gt;_&lt;）</p>
<h1 id="refined(Scala)">refined(Scala)</h1><p><a href="https://github.com/fthomas/refined" target="_blank" rel="external">refined</a>是Scala中一个Refinement Type的实现（貌似也是借鉴的Haskell的库，连名字都抄过来了）。我们在REPL里玩玩，首先导入相关的包：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> eu.timepit.refined._</span><br><span class="line"><span class="keyword">import</span> eu.timepit.refined.api.<span class="type">Refined</span></span><br><span class="line"><span class="keyword">import</span> eu.timepit.refined.auto._</span><br><span class="line"><span class="keyword">import</span> eu.timepit.refined.numeric._</span><br><span class="line"><span class="keyword">import</span> eu.timepit.refined.boolean._</span><br><span class="line"><span class="keyword">import</span> eu.timepit.refined.char._</span><br><span class="line"><span class="keyword">import</span> eu.timepit.refined.collection._</span><br><span class="line"><span class="keyword">import</span> eu.timepit.refined.generic._</span><br><span class="line"><span class="keyword">import</span> eu.timepit.refined.string._</span><br><span class="line"><span class="keyword">import</span> shapeless.&#123; ::, <span class="type">HNil</span> &#125;</span><br></pre></td></tr></table></figure></p>
<p>refined这个库直接在类型系统上进行限定，通过一个<code>Refined[T, P]</code>类型(aka <code>T Refined P</code>, T - 类型， P - 谓词逻辑)来表示，比如正整数可以表示为<code>Int Refined Positive</code>，非空字符串可以表示为<code>String Refined NonEmpty</code>。几个例子：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="function"><span class="keyword">val</span> <span class="title">i1</span>:</span> <span class="type">Int</span> <span class="type">Refined</span> <span class="type">Positive</span> = <span class="number">5</span></span><br><span class="line">i1: eu.timepit.refined.api.<span class="type">Refined</span>[<span class="type">Int</span>,eu.timepit.refined.numeric.<span class="type">Positive</span>] = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">val</span> <span class="title">i2</span>:</span> <span class="type">Int</span> <span class="type">Refined</span> <span class="type">Positive</span> = -<span class="number">5</span></span><br><span class="line">&lt;console&gt;:<span class="number">21</span>: error: <span class="type">Predicate</span> failed: (-<span class="number">5</span> &gt; <span class="number">0</span>).</span><br><span class="line">       <span class="function"><span class="keyword">val</span> <span class="title">i2</span>:</span> <span class="type">Int</span> <span class="type">Refined</span> <span class="type">Positive</span> = -<span class="number">5</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">val</span> <span class="title">i3</span>:</span> <span class="type">String</span> <span class="type">Refined</span> <span class="type">NonEmpty</span> = <span class="string">""</span></span><br><span class="line">&lt;console&gt;:<span class="number">37</span>: error: <span class="type">Predicate</span> isEmpty() did not fail.</span><br><span class="line">       <span class="function"><span class="keyword">val</span> <span class="title">i3</span>:</span> <span class="type">String</span> <span class="type">Refined</span> <span class="type">NonEmpty</span> = <span class="string">""</span></span><br><span class="line">                                         ^</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="function"><span class="keyword">val</span> <span class="title">u1</span>:</span> <span class="type">String</span> <span class="type">Refined</span> <span class="type">Url</span> = <span class="string">"htp://example.com"</span></span><br><span class="line">&lt;console&gt;:<span class="number">37</span>: error: <span class="type">Url</span> predicate failed: unknown protocol: htp</span><br><span class="line">       <span class="function"><span class="keyword">val</span> <span class="title">u1</span>:</span> <span class="type">String</span> <span class="type">Refined</span> <span class="type">Url</span> = <span class="string">"htp://example.com"</span></span><br><span class="line">                                    ^</span><br></pre></td></tr></table></figure></p>
<p>可以看到refined内置不少Predicate，也可以自己自定义Predicate。</p>
<h1 id="Reference">Reference</h1><ul>
<li><a href="http://goto.ucsd.edu/~rjhala/liquid/haskell/blog/blog/2013/01/01/refinement-types-101.lhs" target="_blank" rel="external">Refinement Types 101 - LiquidHaskell</a></li>
<li><a href="http://refined.timepit.eu" target="_blank" rel="external">refined: simple refinement types for Scala</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Functional-Programming/">Functional Programming</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functional-Programming/">Functional Programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Haskell/">Haskell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scala/">Scala</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Type-Theory/">Type Theory</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2015 - 2016 sczyh30's blog
            </div>
            <div class="footer-right">
                <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1255963745'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1255963745%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));
                </script>
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank">Yelee</a> by MOxFIVE. Enhanced by sczyh30.
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>