<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>「千载弦歌，芳华如梦」 - sczyh30&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!--<meta name="keywords" content="sczyh30, blog"/>-->
  <meta name="description" content="sczyh30&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="「千载弦歌，芳华如梦」 - sczyh30's blog">
<meta property="og:url" content="http://www.sczyh30.com/page/5/index.html">
<meta property="og:site_name" content="「千载弦歌，芳华如梦」 - sczyh30's blog">
<meta property="og:description" content="sczyh30&apos;s blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="「千载弦歌，芳华如梦」 - sczyh30's blog">
<meta name="twitter:description" content="sczyh30&apos;s blog">
  
    <link rel="alternative" href="/atom.xml" title="「千载弦歌，芳华如梦」 - sczyh30&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: true
      }
  </script>
  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="http://7xkkgd.com1.z0.glb.clouddn.com/blog_default_avatar.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">sczyh30</a></h1>
        </hgroup>

        
        <p class="header-subtitle">踏歌长行，梦想永在。</p>
        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about">About Me</a></li>
                        
                            <li><a href="/en/">Blog(EN)</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:sczyh16@gmail.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/sczyh30" title="GitHub"></a></li>
                            
                                <li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/sczyh30" title="新浪微博"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                                <li id="SegmentFault"><a class="SegmentFault" target="_blank" href="https://segmentfault.com/u/sczyh30" title="SegmentFault"></a></li>
                            
                                <li id="Google"><a class="Google" target="_blank" href="https://plus.google.com/u/0/117807083506391735472" title="Google"></a></li>
                            
                                <li id="Twitter"><a class="Twitter" target="_blank" href="https://twitter.com/sczyh30" title="Twitter"></a></li>
                            
                                <li id="Medium"><a class="Medium" target="_blank" href="https://medium.com/@sczyh30" title="Medium"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/AIO/" style="font-size: 10px;">AIO</a> <a href="/tags/AMQP/" style="font-size: 10px;">AMQP</a> <a href="/tags/APT/" style="font-size: 10px;">APT</a> <a href="/tags/Akka-Actor/" style="font-size: 10px;">Akka Actor</a> <a href="/tags/Algorithm/" style="font-size: 13px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/C/" style="font-size: 16px;">C++</a> <a href="/tags/C-11/" style="font-size: 10px;">C++ 11</a> <a href="/tags/CE3/" style="font-size: 10px;">CE3</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Category-Theory/" style="font-size: 10px;">Category Theory</a> <a href="/tags/Chemistry/" style="font-size: 11px;">Chemistry</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/DI/" style="font-size: 10px;">DI</a> <a href="/tags/Database/" style="font-size: 10px;">Database</a> <a href="/tags/Docker/" style="font-size: 11px;">Docker</a> <a href="/tags/Engine/" style="font-size: 10px;">Engine</a> <a href="/tags/Euterpea/" style="font-size: 10px;">Euterpea</a> <a href="/tags/FRP/" style="font-size: 10px;">FRP</a> <a href="/tags/Functional-Programming/" style="font-size: 18px;">Functional Programming</a> <a href="/tags/G1/" style="font-size: 10px;">G1</a> <a href="/tags/GC/" style="font-size: 13px;">GC</a> <a href="/tags/GDB/" style="font-size: 10px;">GDB</a> <a href="/tags/Game/" style="font-size: 11px;">Game</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/HashMap/" style="font-size: 11px;">HashMap</a> <a href="/tags/Haskell/" style="font-size: 14px;">Haskell</a> <a href="/tags/HotSpot/" style="font-size: 12px;">HotSpot</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/JUC/" style="font-size: 10px;">JUC</a> <a href="/tags/JVM/" style="font-size: 19px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Klass-oop/" style="font-size: 10px;">Klass-oop</a> <a href="/tags/LinkedList/" style="font-size: 10px;">LinkedList</a> <a href="/tags/Linux/" style="font-size: 12px;">Linux</a> <a href="/tags/MIDI/" style="font-size: 10px;">MIDI</a> <a href="/tags/Mathematical-Logic/" style="font-size: 10px;">Mathematical Logic</a> <a href="/tags/Metaspace/" style="font-size: 10px;">Metaspace</a> <a href="/tags/Netflix-Hystrix/" style="font-size: 10px;">Netflix Hystrix</a> <a href="/tags/Network/" style="font-size: 16px;">Network</a> <a href="/tags/OS/" style="font-size: 10px;">OS</a> <a href="/tags/Object-Model/" style="font-size: 12px;">Object Model</a> <a href="/tags/Play-Framework/" style="font-size: 11px;">Play Framework</a> <a href="/tags/Quorum/" style="font-size: 10px;">Quorum</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/Reflection/" style="font-size: 11px;">Reflection</a> <a href="/tags/SQL/" style="font-size: 10px;">SQL</a> <a href="/tags/STL/" style="font-size: 11px;">STL</a> <a href="/tags/Scala/" style="font-size: 19px;">Scala</a> <a href="/tags/Slick/" style="font-size: 11px;">Slick</a> <a href="/tags/Sort/" style="font-size: 10px;">Sort</a> <a href="/tags/Struct/" style="font-size: 10px;">Struct</a> <a href="/tags/Summary/" style="font-size: 12px;">Summary</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/Type-Lambda/" style="font-size: 10px;">Type Lambda</a> <a href="/tags/Type-System/" style="font-size: 10px;">Type System</a> <a href="/tags/Type-Theory/" style="font-size: 12px;">Type Theory</a> <a href="/tags/UE4/" style="font-size: 10px;">UE4</a> <a href="/tags/Unity/" style="font-size: 10px;">Unity</a> <a href="/tags/Vert-x/" style="font-size: 17px;">Vert.x</a> <a href="/tags/View/" style="font-size: 10px;">View</a> <a href="/tags/Web/" style="font-size: 12px;">Web</a> <a href="/tags/Web开发/" style="font-size: 12px;">Web开发</a> <a href="/tags/event/" style="font-size: 10px;">event</a> <a href="/tags/functional/" style="font-size: 10px;">functional</a> <a href="/tags/中间件/" style="font-size: 10px;">中间件</a> <a href="/tags/事务/" style="font-size: 10px;">事务</a> <a href="/tags/云服务/" style="font-size: 12px;">云服务</a> <a href="/tags/内存区域/" style="font-size: 10px;">内存区域</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/分布式系统/" style="font-size: 12px;">分布式系统</a> <a href="/tags/前端/" style="font-size: 12px;">前端</a> <a href="/tags/基础/" style="font-size: 10px;">基础</a> <a href="/tags/多线程/" style="font-size: 11px;">多线程</a> <a href="/tags/容器/" style="font-size: 10px;">容器</a> <a href="/tags/并发/" style="font-size: 13px;">并发</a> <a href="/tags/开发/" style="font-size: 17px;">开发</a> <a href="/tags/异步/" style="font-size: 13px;">异步</a> <a href="/tags/异步编程/" style="font-size: 16px;">异步编程</a> <a href="/tags/微服务/" style="font-size: 13px;">微服务</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/性能优化/" style="font-size: 10px;">性能优化</a> <a href="/tags/操作系统/" style="font-size: 10px;">操作系统</a> <a href="/tags/数据库/" style="font-size: 11px;">数据库</a> <a href="/tags/架构/" style="font-size: 11px;">架构</a> <a href="/tags/消息系统/" style="font-size: 10px;">消息系统</a> <a href="/tags/源码分析/" style="font-size: 12px;">源码分析</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/线程安全/" style="font-size: 10px;">线程安全</a> <a href="/tags/编译原理/" style="font-size: 10px;">编译原理</a> <a href="/tags/虚拟化/" style="font-size: 10px;">虚拟化</a>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">Fighting</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">sczyh30</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="http://7xkkgd.com1.z0.glb.clouddn.com/blog_default_avatar.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">sczyh30</a></h1>
            </hgroup>
            
            <p class="header-subtitle">踏歌长行，梦想永在。</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about">About Me</a></li>
                
                    <li><a href="/en/">Blog(EN)</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:sczyh16@gmail.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/sczyh30" title="GitHub"></a></li>
                            
                                <li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/sczyh30" title="新浪微博"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                                <li id="SegmentFault"><a class="SegmentFault" target="_blank" href="https://segmentfault.com/u/sczyh30" title="SegmentFault"></a></li>
                            
                                <li id="Google"><a class="Google" target="_blank" href="https://plus.google.com/u/0/117807083506391735472" title="Google"></a></li>
                            
                                <li id="Twitter"><a class="Twitter" target="_blank" href="https://twitter.com/sczyh30" title="Twitter"></a></li>
                            
                                <li id="Medium"><a class="Medium" target="_blank" href="https://medium.com/@sczyh30" title="Medium"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-cpp-stl-functional" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/C-C/cpp-stl-functional/" class="article-date">
      <time datetime="2015-12-19T16:00:00.000Z" itemprop="datePublished">2015-12-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/C-C/cpp-stl-functional/">C++ 11 STL | functional 标准库</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>最近正好用到了这个，就顺便总结下吧。</p>
<p>C++ 11引入了函数对象标准库<code>&lt;functional&gt;</code>，里面包含各种内建的函数对象以及相关的操作函数，非常方便。这里总结一下<code>std::function</code>和<code>std::bind</code>的相关用法。</p>
<h1 id="Callable_type">Callable type</h1><p>Callable type指可以像调用函数一样被调用的对象或函数，包括：</p>
<ul>
<li><code>std::function</code></li>
<li><code>std::bind</code></li>
<li><code>std::result_of</code></li>
<li><code>std::thread::thread</code></li>
<li><code>std::call_once</code></li>
<li><code>std::async</code></li>
<li><code>std::packaged_task</code></li>
<li><code>std::reference_wrapper</code></li>
</ul>
<p>根据C++ 17 Standard，所有Callable type都可以通过<code>std::invoke</code>方法进行<a href="http://en.cppreference.com/w/cpp/utility/functional/invoke" target="_blank" rel="external">显式调用</a>。</p>
<h1 id="std::function">std::function</h1><p><code>std::function</code>类模板是一种通用的函数包装器，它可以容纳所有可以调用的对象（<a href="http://en.cppreference.com/w/cpp/concept/Callable" target="_blank" rel="external">Callable</a>），包括<strong>函数</strong>、<strong>函数指针</strong>、<strong>Lambda表达式</strong>、<strong>bind表达式</strong>、成员函数及成员变量或者其他函数对象。通过std::function可以储存、拷贝或调用Callable对象。它的模板参数如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt; <span class="keyword">class</span> R, <span class="keyword">class</span>... Args &gt;</span><br><span class="line"><span class="keyword">class</span> function&lt;R(Args...)&gt;</span><br></pre></td></tr></table></figure></p>
<p>使用时，模板参数与要存储的函数参数一致即可，下面是一些例子：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;iostream&gt;</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;functional&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">char</span> y, <span class="keyword">double</span> z)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y + z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_num</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> Dog &#123;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Dog</span><span class="params">(<span class="keyword">int</span> id)</span>: <span class="title">id</span><span class="params">(id)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print_add</span><span class="params">(<span class="keyword">int</span> i)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; id + i &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> PrintString &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span>&amp;&amp; s)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; s &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// common function</span></span><br><span class="line">    <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">int</span>)&gt; func_display_num = print_num;</span><br><span class="line">    func_display_num(<span class="number">9</span>);</span><br><span class="line">    <span class="comment">// common function</span></span><br><span class="line">    <span class="built_in">std</span>::function&lt;<span class="keyword">double</span>(<span class="keyword">int</span>, <span class="keyword">char</span>, <span class="keyword">double</span>)&gt; func_display = f;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; func_display(<span class="number">3</span>, <span class="string">'a'</span>, <span class="number">1.7</span>) &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment">// lambda expression</span></span><br><span class="line">    <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">const</span> <span class="keyword">char</span>*)&gt; lbd_dsp_str = [](<span class="keyword">const</span> <span class="keyword">char</span> *s) &#123;<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; s &lt;&lt; <span class="built_in">std</span>::endl;&#125;;   </span><br><span class="line">    lbd_dsp_str(<span class="string">"Scala"</span>);</span><br><span class="line">    <span class="comment">// bind expression</span></span><br><span class="line">    <span class="keyword">auto</span> func_num_bind = <span class="built_in">std</span>::bind(&amp;f, <span class="built_in">std</span>::placeholders::_1, <span class="string">'c'</span>, <span class="number">2.4</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; func_num_bind(<span class="number">24</span>) &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment">// function object</span></span><br><span class="line">    <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="built_in">std</span>::<span class="built_in">string</span>&amp;&amp;)&gt; func_obj_print = PrintString();</span><br><span class="line">    func_obj_print(<span class="string">"C++ 17 Nice!"</span>);</span><br><span class="line">    <span class="comment">// member function</span></span><br><span class="line">    <span class="function"><span class="keyword">const</span> Dog <span class="title">dog</span><span class="params">(2424)</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">const</span> Dog&amp;, <span class="keyword">int</span>)&gt; func_mem_display_num = &amp;Dog::print_add;</span><br><span class="line">    func_mem_display_num(dog, <span class="number">24</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意声明时可用<code>auto</code>进行自动类型推导，这样可以节约时间，不过这样会牺牲代码的可读性，因此需要根据情况合理使用<code>auto</code>。</p>
<h1 id="std::bind">std::bind</h1><p>顾名思义，<code>std::bind</code>函数用来绑定函数的某些参数并生成一个新的<code>function</code>对象。<br><code>bind</code>用于实现偏函数（Partial Function），相当于实现了函数式编程中的 <strong>Currying</strong>（柯里化）。<br>比如有一函数的定义为：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func_muti</span><span class="params">(<span class="keyword">int</span> a, <span class="built_in">std</span>::<span class="built_in">string</span>&amp;&amp; b, <span class="keyword">const</span> <span class="keyword">char</span>* c, <span class="keyword">double</span> d, <span class="keyword">char</span> e)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a &lt;&lt; <span class="string">", "</span> &lt;&lt; b &lt;&lt; <span class="string">", "</span> &lt;&lt; c &lt;&lt; <span class="string">", "</span> &lt;&lt; d &lt;&lt; <span class="string">", "</span> &lt;&lt; e &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在将此函数的一些参数绑定上值，其余部分用占位符对象（std::placeholders）表示。占位符是有序号的，代表调用此函数对象时参数在参数列表中的位置。比如：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> f = <span class="built_in">std</span>::bind(&amp;func_muti, <span class="number">24</span>, <span class="built_in">std</span>::placeholders::_1, <span class="string">"Haha"</span>, <span class="built_in">std</span>::placeholders::_2, <span class="string">'P'</span>);  </span><br><span class="line">f(<span class="string">"Hehe"</span>, <span class="number">24.24</span>);</span><br></pre></td></tr></table></figure></p>
<p>调用这个函数对象相当于调用以下函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span>&amp;&amp; b, <span class="keyword">double</span> d)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"24"</span> &lt;&lt; <span class="string">", "</span> &lt;&lt; b &lt;&lt; <span class="string">", "</span> &lt;&lt; <span class="string">"Haha"</span> &lt;&lt; <span class="string">", "</span> &lt;&lt; d &lt;&lt; <span class="string">", "</span> &lt;&lt; <span class="string">'P'</span> &lt;&lt; <span class="string">"\n"</span>;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/C-C/">C/C++</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STL/">STL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/functional/">functional</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-cpp-move-semantic" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/C-C/cpp-move-semantic/" class="article-date">
      <time datetime="2015-12-02T16:00:00.000Z" itemprop="datePublished">2015-12-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/C-C/cpp-move-semantic/">C++ 11 Move Sementics/Perfect Forwarding</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="lvalue_&amp;&amp;_rvalue">lvalue &amp;&amp; rvalue</h1><p>表达式可以分为lvalue（左值）和rvalue（右值）两种。<br>左值与右值的区别是左值具名，<strong>可以取址</strong>并访问；而右值不具名，通常是临时的变量，不可取址，仅在当前作用域有效。<br>对于函数及运算符，如果返回类型是左值引用类型(A&amp;)，那么返回值是左值；若返回类型是原对象类型(A)，那么返回值就是右值<br>举一些例子来说明：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">int</span> a = <span class="number">0</span>, b = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> *p = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">24</span>);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> str1 = <span class="string">"nice"</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> str2 = <span class="string">"Scala"</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line">vec.push_back(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span>&amp; m = <span class="number">666</span>;</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>Expression</th>
<th>Value category</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>rvalue</td>
</tr>
<tr>
<td>i</td>
<td>lvalue</td>
</tr>
<tr>
<td>a+b</td>
<td>rvalue</td>
</tr>
<tr>
<td>&amp;a</td>
<td>rvalue</td>
</tr>
<tr>
<td>*p</td>
<td>lvalue</td>
</tr>
<tr>
<td>++i</td>
<td>lvalue(前缀自增运算符直接在原变量上自增)</td>
</tr>
<tr>
<td>i++</td>
<td>rvalue(后缀自增运算符先拷贝一份变量，自增后再重新赋值给原变量)</td>
</tr>
<tr>
<td>std::string(“oye”)</td>
<td>rvalue</td>
</tr>
<tr>
<td>str1+str2</td>
<td>rvalue(重载的‘+’运算符返回的是一个临时的std::string对象而不是引用)</td>
</tr>
<tr>
<td>vec[0]</td>
<td>lvalue(重载的[]运算符返回类型为<strong>int&amp;</strong>)</td>
</tr>
<tr>
<td>m</td>
<td>lvalue(引用了一个右值，但本身是左值)</td>
</tr>
</tbody>
</table>
<p>更详细的信息见<a href="http://en.cppreference.com/w/cpp/language/value_category" target="_blank" rel="external">Value categories</a>.</p>
<h1 id="Move_semantic">Move semantic</h1><p>右值引用(移动语义)的意义：进行数据复制的时候，将动态申请的内存空间的所有权直接转让出去，不用进行大量的数据移动，既节省空间又提高效率。</p>
<p>被移动语义的数据交出了所有权，为了不出现析构两次同一数据区，要将交出所有权的数据的指向动态申请内存去的指针赋值为nullptr，即空指针。对空指针执行delete[]是合法的。</p>
<p>拷贝构造函数与移动构造函数的区别：<br><img src="" alt=""></p>
<p>也就是说，移动构造函数可以直接利用右值的内存空间而不用再另开辟空间进行数据的拷贝。</p>
<p>将左值转化为右值可以用<code>std::move</code>，比如：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">f(<span class="keyword">int</span>&amp;&amp; a);</span><br><span class="line">f(<span class="keyword">int</span>&amp; a);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> s = <span class="number">4</span>;</span><br><span class="line">f(s); <span class="comment">// invoke f(&amp;)</span></span><br><span class="line">f(<span class="built_in">std</span>::move(s));<span class="comment">// invoke f(&amp;&amp;)</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Perfect_forwarding">Perfect forwarding</h1><p>有的时候，我们需要将一个函数某一组参数原封不动地传递给另一个函数。这里不仅需要参数的值不变，而且需要参数的类型属性（左值/右值，const/volatile属性)保持不变，这叫做<strong>Perfect Forwarding</strong>（参数的精确传递 or 完美转发）<br>从C++ 11开始，Perfect Forwarding可以通过<code>std::forward</code>函数实现，其原型为：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++ 14 definition</span></span><br><span class="line"><span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;</span><br><span class="line"><span class="keyword">constexpr</span> T&amp;&amp; forward( <span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;T&gt;::type&amp; t );</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;</span><br><span class="line"><span class="keyword">constexpr</span> T&amp;&amp; forward( <span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;T&gt;::type&amp;&amp; t );</span><br></pre></td></tr></table></figure></p>
<p>使用示例：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;iostream&gt;</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;utility&gt;</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;memory&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	A(<span class="keyword">int</span> &amp;&amp; n) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"rvalue constructor -&gt; n="</span> &lt;&lt; n &lt;&lt; <span class="built_in">std</span>::endl;&#125;</span><br><span class="line">	A(<span class="keyword">int</span>&amp; n) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"lvalue constructor -&gt; n="</span> &lt;&lt; n &lt;&lt; <span class="built_in">std</span>::endl;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keyword">class</span> U&gt;</span><br><span class="line"><span class="built_in">std</span>::unique_ptr&lt;T&gt; make_unique1(U&amp;&amp; u) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">std</span>::unique_ptr&lt;T&gt;(<span class="keyword">new</span> T(<span class="built_in">std</span>::forward&lt;U&gt;(u)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">24</span>;</span><br><span class="line">	<span class="keyword">auto</span> p1 = make_unique1&lt;A&gt;(<span class="number">666</span>); <span class="comment">// rvalue forwarding</span></span><br><span class="line">	<span class="keyword">auto</span> p2 = make_unique1&lt;A&gt;(i); <span class="comment">// lvalue forwarding</span></span><br><span class="line">	<span class="keyword">auto</span> p3 = make_unique1&lt;A&gt;(<span class="built_in">std</span>::move(i)); <span class="comment">// rvalue forwarding</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序运行结果：<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rvalue <span class="function"><span class="keyword">constructor</span> -&gt; <span class="title">n</span>=666</span><br><span class="line"><span class="title">lvalue</span> <span class="title">constructor</span> -&gt; <span class="title">n</span>=24</span><br><span class="line"><span class="title">rvalue</span> <span class="title">constructor</span> -&gt; <span class="title">n</span>=24</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，参数在传递时都保留了参数原本的属性。</p>
<h1 id="实现原理">实现原理</h1><p>先放上源码，后面再分析。。</p>
<p>源码(g++ 4.9.2)：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   *  @brief  Forward an lvalue.</span><br><span class="line">   *  @return The parameter cast to the specified type.</span><br><span class="line">   *</span><br><span class="line">   *  This function is used to implement "perfect forwarding".</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">constexpr</span> _Tp&amp;&amp;</span><br><span class="line">    forward(<span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;_Tp&gt;::type&amp; <span class="keyword">__t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    &#123; <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;_Tp&amp;&amp;&gt;(<span class="keyword">__t</span>); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   *  @brief  Forward an rvalue.</span><br><span class="line">   *  @return The parameter cast to the specified type.</span><br><span class="line">   *</span><br><span class="line">   *  This function is used to implement "perfect forwarding".</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">constexpr</span> _Tp&amp;&amp;</span><br><span class="line">    forward(<span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;_Tp&gt;::type&amp;&amp; <span class="keyword">__t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">static_assert</span>(!<span class="built_in">std</span>::is_lvalue_reference&lt;_Tp&gt;::value, <span class="string">"template argument"</span></span><br><span class="line">		    <span class="string">" substituting _Tp is an lvalue reference type"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;_Tp&amp;&amp;&gt;(<span class="keyword">__t</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   *  @brief  Convert a value to an rvalue.</span><br><span class="line">   *  @param  __t  A thing of arbitrary type.</span><br><span class="line">   *  @return The parameter cast to an rvalue-reference to allow moving it.</span><br><span class="line">  */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;_Tp&gt;::type&amp;&amp;</span><br><span class="line">    move(_Tp&amp;&amp; <span class="keyword">__t</span>) <span class="keyword">noexcept</span></span><br><span class="line">    &#123; <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> <span class="built_in">std</span>::remove_reference&lt;_Tp&gt;::type&amp;&amp;&gt;(<span class="keyword">__t</span>); &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// remove_reference</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> remove_reference</span><br><span class="line">    &#123; <span class="keyword">typedef</span> _Tp   type; &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> remove_reference&lt;_Tp&amp;&gt;</span><br><span class="line">    &#123; <span class="keyword">typedef</span> _Tp   type; &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp&gt;</span><br><span class="line">    <span class="keyword">struct</span> remove_reference&lt;_Tp&amp;&amp;&gt;</span><br><span class="line">    &#123; <span class="keyword">typedef</span> _Tp   type; &#125;;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/C-C/">C/C++</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C-11/">C++ 11</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-inside-cpp-object-model-summary-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/C-C/inside-cpp-object-model-summary-1/" class="article-date">
      <time datetime="2015-11-20T16:00:00.000Z" itemprop="datePublished">2015-11-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/C-C/inside-cpp-object-model-summary-1/">Inside The C++ Object Model Summary I</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>最近一直在看 <em>Inside The C++ Object Model</em>， 希望从这本书中了解一下底层对象模型的设计，也为以后研究JVM的对象模型做铺垫。<br>注：由于这本书比较老，最新也就是C++ 98标准。因此这些总结都是基于C++ 98标准的。如果有C++ 11中新增的特性或新的优化（貌似析构函数那一部分变了挺多），我会单独指出。</p>
<p>这篇将总结C++的构造函数语义学相关的内容( <em>Inside The C++ Object Model, Chapter 2</em> )。</p>
<p>第二章主要讲述了构造函数的相关模型及事项。</p>
<h1 id="Implicit_Default_Constructor（C++_98）">Implicit Default Constructor（C++ 98）</h1><p>在我们没有声明默认构造函数的时候，编译器有可能会为我们自动生成默认构造函数。不过，并非在所有情况下，编译器都自动生成default constructor。当且仅当以下四种情况下，编译器会自动为一个类生成default constructor：</p>
<ul>
<li>1、此类有一个显式地实现了默认构造函数（explicit default constructor）的对象成员变量</li>
<li>2、此类的父类显式地实现了默认构造函数</li>
<li>3、此类中存在虚函数</li>
<li>4、此类间接继承了虚基类</li>
</ul>
<p><strong>注：</strong> C++ 11标准增加了移动构造函数（move constructor），有关移动构造函数相关的东西可以看C++ 11标准。</p>
<h1 id="Copy_Constructor（C++_98）">Copy Constructor（C++ 98）</h1><h2 id="No_Bitwise_copy">No Bitwise copy</h2><p>编译器不能简单地拷贝对象，因为编译器需要保证vptr和vtbl的正确性。</p>
<p>复制的时候要注意正确赋值。比如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> A &#123; <span class="comment">// virtual base class</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">A</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">A</span><span class="params">(<span class="keyword">int</span> i)</span>:<span class="title">i</span><span class="params">(i)</span> </span>&#123;&#125;</span><br><span class="line">        <span class="keyword">virtual</span> ~A() &#123;&#125; <span class="comment">// virtual deconstructor</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>-&gt;i;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> B : <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> C : <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> D : <span class="keyword">public</span> b, <span class="keyword">public</span> C &#123;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如果在赋值的时候将sub object赋值给base object，编译器为了确保vptr和vtbl的一致性，会对其截断：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2 id="Return_Value_Initialization">Return Value Initialization</h2><p>注：不确定现在还有没有这种优化。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Test <span class="title">genTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Test test;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do something to wrap the object ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> test;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>经过编译器解析后被转化为：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">genTest</span><span class="params">(Test&amp; __temp)</span> </span>&#123;</span><br><span class="line">    Test test;</span><br><span class="line">    <span class="comment">// &lt;init&gt;</span></span><br><span class="line">    test.Test::Test();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do something to wrap the object ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy constructor invocation</span></span><br><span class="line">    <span class="keyword">__t</span>emp.Test::Test(test);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在如果执行<code>Test t = genTest()</code>这条语句的话，它会被编译器转化为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Test t;</span><br><span class="line">genTest(t);</span><br></pre></td></tr></table></figure>
<h2 id="浅拷贝和深拷贝">浅拷贝和深拷贝</h2><p>老生常谈的东西了，对于指针变量（或数组），必须执行按地址拷贝，这是默认生成的拷贝构造函数不能提供的。因此如果成员变量里有指针型或数组型变量，那么必须自己实现拷贝构造函数，用memcpy或memcopy进行按地址拷贝。</p>
<h1 id="Move_Constructor（C++_11）">Move Constructor（C++ 11）</h1><p>待总结…</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/C-C/">C/C++</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Object-Model/">Object Model</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Summary/">Summary</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-amqp-rabbitmq" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Architecture/amqp-rabbitmq/" class="article-date">
      <time datetime="2015-11-19T16:12:36.000Z" itemprop="datePublished">2015-11-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Architecture/amqp-rabbitmq/">消息队列中间件-RabbitMQ总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Prolouge">Prolouge</h1><h2 id="AMQP">AMQP</h2><p>高级消息队列协议（Advanced Message Queuing Protocol, AMQP）是一个异步消息传递所使用的应用层协议规范。作为线路层协议，而不是API（例如JMS），AMQP客户端能够无视消息的来源任意发送和接受信息。现在，已经有相当一部分不同平台的服务器和客户端可以投入使用。</p>
<p>AMQP的原始用途只是为金融界提供一个可以彼此协作的消息协议，而现在的目标则是为通用消息队列架构提供通用构建工具。因此，面向消息的中间件（MOM）系统，例如发布/订阅消息队列，没有作为基本元素实现。反而通过发送简化的AMQ实体，用户被赋予了构建例如这些实体的能力。这些实体也是规范的一部分，形成了在线路层协议顶端的一个层级：AMQP模型。这个模型统一了消息模式，诸如之前提到的发布/订阅，队列，事务以及流数据，并且添加了额外的特性，例如更易于扩展，基于内容的路由。</p>
<h2 id="面向消息的中间件模型">面向消息的中间件模型</h2><h1 id="Chapter_I:_Producer-Consumer_Model">Chapter I: Producer-Consumer Model</h1><h2 id="Intro">Intro</h2><p>最简单的消息队列模型应该就是生产者-消费者模型了。简单的一对一模型如下图：</p>
<p><img src="http://www.rabbitmq.com/img/tutorials/python-one.png" alt=""></p>
<p>其中P代表生产者（Producer），C代表消费者（Consumer）,中间部分代表消息队列（Message Queue）。</p>
<p>下面我们用RabbitMQ来实现，首先是生产者一端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * RabbitMQ Single Producer</span><br><span class="line"> * <span class="doctag">@author</span> sczyh30</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_q1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//步骤一：建立连接</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        factory.setHost(<span class="string">"localhost"</span>); <span class="comment">//设置host,默认为127.0.0.1</span></span><br><span class="line">        <span class="comment">//factory.setPort(6666); //设置端口， 不指定则为默认端口</span></span><br><span class="line">        Connection connection = factory.newConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//步骤二：定义消息队列</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        String message = <span class="string">"[Message Producer] 66666"</span>;</span><br><span class="line">        <span class="comment">//步骤三：发布消息</span></span><br><span class="line">        channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line">        System.out.println(<span class="string">"[MessageQueue] Message sent =&gt; message="</span> + message);</span><br><span class="line">        <span class="comment">//关闭连接</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>消费者一端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_q1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//步骤一：建立连接</span></span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        factory.setHost(<span class="string">"localhost"</span>);</span><br><span class="line">        Connection connection = factory.newConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//步骤二：创建一个消费者对象，并利用handleDelivery回调函数接受消息</span></span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                String msg = <span class="keyword">new</span> String(body, <span class="string">"UTF-8"</span>);</span><br><span class="line">                System.out.println(<span class="string">"[Message Recv] =&gt; "</span> + msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//步骤三：将消费者端与消息队列绑定</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，无论是消费者端还是生产者端，首先要建立通信连接（ConnectionFactory -&gt; Connection -&gt; Channel）。<br>这只是最简单的一种情况，后边将介绍更普遍、更复杂的情况。</p>
<h2 id="几个重要API">几个重要API</h2><h2 id="定义消息队列">定义消息队列</h2><p>定义消息队列可以用Channel接口的queueDeclare方法，它有两个重载版本。<br>含参的queueDeclare方法定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Declare a queue</span><br><span class="line">     * <span class="doctag">@see</span> com.rabbitmq.client.AMQP.Queue.Declare</span><br><span class="line">     * <span class="doctag">@see</span> com.rabbitmq.client.AMQP.Queue.DeclareOk</span><br><span class="line">     * <span class="doctag">@param</span> queue the name of the queue</span><br><span class="line">     * <span class="doctag">@param</span> durable true if we are declaring a durable queue (the queue will survive a server restart)</span><br><span class="line">     * <span class="doctag">@param</span> exclusive true if we are declaring an exclusive queue (restricted to this connection)</span><br><span class="line">     * <span class="doctag">@param</span> autoDelete true if we are declaring an autodelete queue (server will delete it when no longer in use)</span><br><span class="line">     * <span class="doctag">@param</span> arguments other properties (construction arguments) for the queue</span><br><span class="line">     * <span class="doctag">@return</span> a declaration-confirm method to indicate the queue was successfully declared</span><br><span class="line">     * <span class="doctag">@throws</span> java.io.IOException if an error is encountered</span><br><span class="line">     */</span></span><br><span class="line">    Queue.<span class="function">DeclareOk <span class="title">queueDeclare</span><span class="params">(String queue, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> exclusive, <span class="keyword">boolean</span> autoDelete,</span><br><span class="line">                                 Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，它接受五个参数。第一个参数对应消息队列名称，第二个参数对应消息队列是否可以持久化，第三个参数对应消息队列是否仅限于当前连接，第四个参数对应消息队列是否在不用的情况下自动删除，第五个参数对应消息队列其他的一些设置。</p>
<p>另外还有一个无参的queueDeclare方法，实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> com.rabbitmq.client.AMQP.Queue.<span class="function">DeclareOk <span class="title">queueDeclare</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> queueDeclare(<span class="string">""</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">null</span>); <span class="comment">// 默认不可持久化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>注意：Producer端和Consumer端的消息队列定义需要保持一致。</strong></p>
<h2 id="Envelope对象">Envelope对象</h2><p>Envelope对象封装了AMQP通信需要的数据，如deliveryTag, redeliver flag, exchange, routingKey等。其构造函数注释中有这几个变量的解释：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    * Construct an &#123;<span class="doctag">@link</span> Envelope&#125; with the specified construction parameters</span><br><span class="line">    * <span class="doctag">@param</span> deliveryTag the delivery tag</span><br><span class="line">    * <span class="doctag">@param</span> redeliver true if this is a redelivery following a failed ack</span><br><span class="line">    * <span class="doctag">@param</span> exchange the exchange used for the current operation</span><br><span class="line">    * <span class="doctag">@param</span> routingKey the associated routing key</span><br><span class="line">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Envelope</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> redeliver, String exchange, String routingKey)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>._deliveryTag = deliveryTag;</span><br><span class="line">       <span class="keyword">this</span>._redeliver = redeliver;</span><br><span class="line">       <span class="keyword">this</span>._exchange = exchange;</span><br><span class="line">       <span class="keyword">this</span>._routingKey = routingKey;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="消息分发机制(Dispatch)">消息分发机制(Dispatch)</h2><p>RabbitMQ采用<strong>轮询</strong>分发机制（<strong>Round-robin dispatching</strong>），每个消费者将接收到数量相近的消息。</p>
<p>扩展：如果想控制每次给消费者端传递的消息数量（流量控制），可以通过Channel的basicQos方法，它有三个重载版本：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Request specific "quality of service" settings.</span><br><span class="line">     *</span><br><span class="line">     * These settings impose limits on the amount of data the server</span><br><span class="line">     * will deliver to consumers before requiring acknowledgements.</span><br><span class="line">     * Thus they provide a means of consumer-initiated flow control.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchSize, <span class="keyword">int</span> prefetchCount, <span class="keyword">boolean</span> global)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    exnWrappingRpc(<span class="keyword">new</span> Basic.Qos(prefetchSize, prefetchCount, global));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Public API - &#123;<span class="doctag">@inheritDoc</span>&#125; */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchCount, <span class="keyword">boolean</span> global)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        basicQos(<span class="number">0</span>, prefetchCount, global);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Public API - &#123;<span class="doctag">@inheritDoc</span>&#125; */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchCount)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    basicQos(<span class="number">0</span>, prefetchCount, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>其中:</p>
<ul>
<li>prefetchSize表示服务器给消费者端传递数据大小的上限，0为不限</li>
<li>prefetchCount表示服务器给消费者端传递数据数量的上限，0为不限</li>
<li>global标志位表示此设置是否应用于整个Channel而不是每个Consumer</li>
</ul>
<h2 id="消息确认机制(Acknowledge)">消息确认机制(Acknowledge)</h2><p>设想一下这种场景：消费者端处理一个耗时任务时被强制结束任务，此时任务还没有完成，但是消息却已从消息队列中发送了出去。如果没有一定的消息确认机制，那么我们将丢失掉此消息及后面一堆发送至此消费者但还未经处理的消息。</p>
<p>RabbitMQ支持消息确认机制。如果消费者已处理完任务，那么它将向Broker发送ACK消息，告知某条消息已被成功处理，可以从队列中移除。如果消费者端没有发送回ACK消息，那么Broker会认为消息处理失败，会将此消息及后续消息分发给其他消费者端进行处理(redeliver flag置为true)。<br>这种确认机制和TCP/IP协议确立连接类似。不同的是，TCP/IP确立连接需要经过三次握手，而RabbitMQ只需要一次ACK。</p>
<p><strong>注意：RabbitMQ当且仅当检测到ACK消息未发出且消费者端的连接终止时才会将消息重新分发给其他消费者端，因此不需要担心消息处理时间过长而被重新分发的情况。</strong></p>
<p>我们可以通过设置basicConsume方法的<code>autoAck</code>标志位来设置其消息确认机制。basicConsume方法的定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, Consumer callback)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure></p>
<p>当autoAck为true时，不启用显式消息确认机制，消息分发出去即为确认完毕。autoAck为false时，启用上述的消息确认机制。</p>
<p>消费者端发送ACK消息可以通过在回调函数中调用Channel的<code>basicAck</code>方法实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>其定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">     * Acknowledge one or several received</span><br><span class="line">     * messages. Supply the deliveryTag from the &#123;<span class="doctag">@link</span> com.rabbitmq.client.AMQP.Basic.GetOk&#125;</span><br><span class="line">     * or &#123;<span class="doctag">@link</span> com.rabbitmq.client.AMQP.Basic.Deliver&#125; method</span><br><span class="line">     * containing the received message being acknowledged.</span><br><span class="line">     * <span class="doctag">@see</span> com.rabbitmq.client.AMQP.Basic.Ack</span><br><span class="line">     * <span class="doctag">@param</span> deliveryTag the tag from the received &#123;<span class="doctag">@link</span> com.rabbitmq.client.AMQP.Basic.GetOk&#125; or &#123;<span class="doctag">@link</span> com.rabbitmq.client.AMQP.Basic.Deliver&#125;</span><br><span class="line">     * <span class="doctag">@param</span> multiple true to acknowledge all messages up to and</span><br><span class="line">     * including the supplied delivery tag; false to acknowledge just</span><br><span class="line">     * the supplied delivery tag.</span><br><span class="line">     * <span class="doctag">@throws</span> java.io.IOException if an error is encountered</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>WARNING：使用的时候千万不要忘了调用basicAck方法！必要的时候可以对Consumer类再做一层封装。</strong></p>
<h2 id="简单的消息持久化(Message_durability)">简单的消息持久化(Message durability)</h2><p>RabbitMQ的消息确认机制保证了即使消费者端挂了，我们的消息也可以被顺利处理。然而，如果碰上意外情况，Broker（RabbitMQ Server）挂了（比如意外重启），这种情况下不做任何设置的话，我们的信息仍然会丢失。好在，RabbitMQ同样提供了消息持久化的功能。</p>
<p>首先，我们需要保证我们的消息队列可以持久化，方法上面已经提到过，就是将queueDeclare方法的<code>durable</code>标志位设为true。</p>
<p>然后，我们需要在发布消息的时候通过设置basicPublish方法的props参数为PERSISTENT_TEXT_PLAIN来实现消息可持久化，比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(<span class="string">""</span>, TASK_QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN,</span><br><span class="line">                message.getBytes(<span class="string">"UTF-8"</span>));</span><br></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：尽管设置了消息可持久化，但这并不能完全保证消息就一定可以存储到磁盘里。RabbitMQ存在一段时间，接受了一个消息但还没来得及存储。并且，RabbitMQ不一定对所有消息都做fsync（即同步内存中的消息到硬盘），有些消息可能只是被缓存而不会被持久化。<br>因此，<strong>这种消息持久化机制是不可靠的</strong>，特别是对大型项目。如果需要可靠的消息持久化，可以使用<strong>publisher confirm</strong>。</p>
<h2 id="发布/订阅模型">发布/订阅模型</h2><p><img src="http://www.rabbitmq.com/img/tutorials/exchanges.png" alt=""></p>
<h2 id="路由">路由</h2><h2 id="模式匹配">模式匹配</h2><p>Pending…</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Architecture/">Architecture</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AMQP/">AMQP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/中间件/">中间件</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-haskell-category-basic" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Functional-Programming/haskell-category-basic/" class="article-date">
      <time datetime="2015-11-01T16:00:00.000Z" itemprop="datePublished">2015-11-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Functional-Programming/haskell-category-basic/">Haskell学习笔记 | 范畴论与Haskell</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><strong>（2016-4-25 注）：经过了半年的修炼，对Category Theory有了新的理解，因此过段时间会重写这篇文章。</strong></p>
<h1 id="Haskell与范畴论">Haskell与范畴论</h1><h2 id="范畴论基础">范畴论基础</h2><p>一个<strong>范畴</strong>(category)由以下三部分组成：</p>
<ul>
<li>1、一些<strong>对象</strong>(object)构成的类ob(C)</li>
<li>2、范畴C中对象之间的映射，称为 <strong>态射</strong>(morphism)。态射的集合用<code>hom(C)</code>表示</li>
<li>3、态射的复合运算(<code>.</code>)，用于将多个态射进行复合。比如<code>f: A → B</code>, <code>g: B → C</code>，则<code>g . f: A → C</code></li>
</ul>
<p>对范畴中的每一个object X，都存在对应的幺元 $id_{X}: X \to X$ ，并且满足关系：</p>
<p>$$ id(B) \circ f = f = f \circ id(A) $$</p>
<p>同时，复合运算是可结合的，比如 $ (h \circ g) \circ f = h \circ (g \circ f) $。</p>
<p>在Haskell中，对应的是：</p>
<ul>
<li>object对应着某个具体的函数（<em>类型？</em>）（这是我的理解，也有很多人认为对象对应着某一类值的集合，即类型。我的理解是<strong>type和type constructor都可以看作是function</strong>，这里存疑）</li>
<li>而态射对应着函数之间的映射，这种映射产生新的函数。比如<br>$$f :: (a \to b) \to a \to b$$</li>
<li>态射的复合运算代表着函数的复合（复合函数），比如<code>h = f . g</code></li>
</ul>
<h2 id="Functor（函子）">Functor（函子）</h2><p>在范畴论中，态射是对象与对象之间的映射。那么肯定还有范畴与范畴之间的映射，这称为函子（Functor）。</p>
<p>既然是范畴之间的映射，那么函子的作用就有两个：</p>
<ul>
<li>将范畴A的object映射到范畴B的object</li>
<li>将范畴A的morphism映射到范畴B的morphism</li>
</ul>
<p>当然需要满足两个条件（单位态射关系和分配率），这里就不阐述了。注意这种映射不一定是双射。</p>
<p>其中，将范畴映射到自身的函子称为自函子(endofunctor)，即把范畴A的对象和态射映射到自身。自函子反映了范畴内部的自相似性。</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/catagory-functor-wk1.png" alt="Functor"></p>
<p>在Haskell中，Functor是一个 <strong>typeclass</strong>，它是这样定义的:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">Functor</span> f <span class="keyword">where</span></span></span><br><span class="line">    fmap :: (a -&gt; b) -&gt; f a -&gt; f b</span><br></pre></td></tr></table></figure></p>
<p>其中f是一个<code>type constructor</code>，它接收一个concrete type（实际类型）以构造出一个concrete type，相当于：<code>* -&gt; *</code>。<br>当然type constructor也可以叠加，比如这种：<code>* -&gt; (* -&gt; *) -&gt; *</code>。（这玩意貌似叫<strong>kind polymorphism</strong>）</p>
<p>如果这里的对象对应Haskell里的类型的话，那么type constructor相当于态射，它就是自函子的一部分，即一个范畴的对象与另一个范畴的对象的映射。<br>类型与类型的映射一般都是简单类型与复杂类型之间的相互转化，比如<code>int -&gt; Maybe int</code>。<br>而另一部分，即态射与态射之间的映射，其实就是高阶函数（函数与函数之间的映射，因为态射本身就对应Haskell中的函数），在Haskell的Functor里面对应的就是fmap，它将态射<code>a -&gt; b</code>映射为另一个态射<code>f a -&gt; f b</code>:<br>$$( a \to b) \to f a \to f b$$</p>
<h2 id="自然变换(Natural_Transformation)">自然变换(Natural Transformation)</h2><p>再抽象一层，自然变换是Functor之间的映射关系。</p>
<hr>
<h1 id="参考资料">参考资料</h1><ul>
<li><a href="https://en.wikibooks.org/wiki/Haskell/Category_theory" target="_blank" rel="external">Haskell/Category theory - Wikibooks</a></li>
<li><a href="https://en.wikipedia.org/wiki/Category_(mathematics" target="_blank" rel="external">Category(Mathematics) - Wiki</a></li>
<li><a href="http://mvanier.livejournal.com/" target="_blank" rel="external">Yet Another Monad Tutorial - Mike’s World-O-Programming</a></li>
<li><a href="http://www.haskell.org/haskellwiki/Typeclassopedia" target="_blank" rel="external">Typeclassopedia - Haskell Wiki</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Functional-Programming/">Functional Programming</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Category-Theory/">Category Theory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functional-Programming/">Functional Programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Haskell/">Haskell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Type-Theory/">Type Theory</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-android-event-dispatcher" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Develop/android-event-dispatcher/" class="article-date">
      <time datetime="2015-10-25T03:37:00.000Z" itemprop="datePublished">2015-10-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Develop/android-event-dispatcher/">Android事件分发机制总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Android事件构成">Android事件构成</h1><p>在Android中，事件主要包括点按、长按、拖拽、滑动等，点按又包括单击和双击，另外还包括单指操作和多指操作。所有这些都构成了Android中的事件响应。总的来说，所有的事件都由如下三个部分作为基础：</p>
<ul>
<li>按下（ACTION_DOWN）</li>
<li>移动（ACTION_MOVE）</li>
<li>抬起（ACTION_UP）</li>
</ul>
<p>所有的操作事件首先必须执行的是按下操作（ACTION_DOWN）。</p>
<h1 id="Android事件分发机制">Android事件分发机制</h1><p> Android事件分发是先传递到ViewGroup，再由ViewGroup传递到View的。</p>
<h2 id="对于View：">对于View：</h2><p>大体流程：触摸动作发生 =&gt; 调用dispatchTouchEvent方法 =&gt; 首先调用onTouch方法<br>若同时满足：绑定了OnClickListener、控件可用（enabled）、onTouch方法返回true，则dispatchTouchEvent方法将直接返回true，不会调用onTouchEvent方法。<br>这是最新的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If the event should be handled by accessibility focus first.</span></span><br><span class="line">        <span class="keyword">if</span> (event.isTargetAccessibilityFocus()) &#123;</span><br><span class="line">            <span class="comment">// We don't have focus or no virtual descendant has it, do not handle the event.</span></span><br><span class="line">            <span class="keyword">if</span> (!isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// We have focus and got the event, then use normal event dispatch.</span></span><br><span class="line">            event.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInputEventConsistencyVerifier.onTouchEvent(event, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</span><br><span class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">            <span class="comment">// Defensive cleanup for new gesture</span></span><br><span class="line">            stopNestedScroll();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</span><br><span class="line">            <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">            ListenerInfo li = mListenerInfo;</span><br><span class="line">            <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</span><br><span class="line">                    &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</span><br><span class="line">                result = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!result &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInputEventConsistencyVerifier.onUnhandledEvent(event, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clean up after nested scrolls if this is the end of a gesture;</span></span><br><span class="line">        <span class="comment">// also cancel it if we tried an ACTION_DOWN but we didn't want the rest</span></span><br><span class="line">        <span class="comment">// of the gesture.</span></span><br><span class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_UP ||</span><br><span class="line">                actionMasked == MotionEvent.ACTION_CANCEL ||</span><br><span class="line">                (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</span><br><span class="line">            stopNestedScroll();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>否则，将会继续调用onTouchEvent方法。并且可以推断，onClick方法也是在onTouchEvent方法中调用的。</p>
<h2 id="对于ViewGroup">对于ViewGroup</h2><ol>
<li>Android事件分发是先传递到ViewGroup，再由ViewGroup传递到View的。</li>
<li>在ViewGroup中可以通过onInterceptTouchEvent方法对事件传递进行拦截，onInterceptTouchEvent方法返回true代表不允许事件继续向子View传递，返回false代表不对事件进行拦截，默认返回false。</li>
<li>子View中如果将传递的事件消费掉，ViewGroup中将无法接收到任何事件。</li>
</ol>
<h1 id="总结">总结</h1><ul>
<li>1、Android中事件传递按照<strong>从上到下进行层级传递</strong>，事件处理从Activity开始到ViewGroup再到View。</li>
<li>2、事件传递方法包括<strong>dispatchTouchEvent</strong>、<strong>onTouchEvent</strong>、<strong>onInterceptTouchEvent</strong>，其中前两个是View和ViewGroup都有的，最后一个是只有ViewGroup才有的方法。这三个方法的作用分别是负责事件分发、事件处理、事件拦截。</li>
<li>3、onTouch事件要先于onClick事件执行，onTouch在事件分发方法dispatchTouchEvent中调用，而onClick在事件处理方法onTouchEvent中被调用，onTouchEvent要后于dispatchTouchEvent方法的调用。</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Develop/">Develop</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/event/">event</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-android-view-draw-01" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Develop/android-view-draw-01/" class="article-date">
      <time datetime="2015-10-25T02:21:00.000Z" itemprop="datePublished">2015-10-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Develop/android-view-draw-01/">Android View视图绘制总结（1）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="LayoutInflater的作用">LayoutInflater的作用</h1><p>用于将xml文件（layout布局文件）解析成View<br>对最外层来说，<code>layout_height</code>和<code>layout_width</code>都是没有用的<br>setContentView时，系统会自动在外边加一个FrameLayout</p>
<h1 id="View的绘制">View的绘制</h1><p>三个主要阶段：<code>onMeasure()</code>、<code>onLayout()</code>和<code>onDraw()</code><br>onMeasure：测量视图大小<br>onLayout：给视图布局，即确定视图位置<br>onDraw：对图像进行绘制（在Canvas对象上进行）</p>
<hr>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/pic2012_394885959.JPG" alt=""></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Develop/">Develop</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/View/">View</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-android-refactor-mvp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Architecture/android-refactor-mvp/" class="article-date">
      <time datetime="2015-10-24T15:37:00.000Z" itemprop="datePublished">2015-10-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Architecture/android-refactor-mvp/">Android MVP架构重构实践</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>我们之前的架构就是普通的MVC架构。由于各种layout文件职责单一，因此Activity经常也作为Controller层，这样可能会堆出一个几千行的Activity，看起来就很爽。。因此，这次总结项目时便计划用更好的MVP架构和MVVM架构来重构项目。</p>
<p>为了简便起见，就拿LoginActivity来练手吧，这还属于逻辑比较简单的。。这是原登录逻辑的大概代码（省略了大量逻辑）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Bind</span>(R.id.et_username)</span><br><span class="line">    EditText etUserName;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Bind</span>(R.id.et_password)</span><br><span class="line">    EditText etPassword;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String mUserName = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">private</span> String mPassword = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getLayoutId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (item.getItemId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> android.R.id.home:</span><br><span class="line">                onBackPressed();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasBackButton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getActionBarTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.string.login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="annotation">@OnClick</span>(&#123;R.id.btn_login, R.id.iv_qq_login, R.id.iv_wx_login, R.id.iv_sina_login&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> id = v.getId();</span><br><span class="line">        <span class="keyword">switch</span> (id) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.btn_login:</span><br><span class="line">                handleLogin();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.iv_qq_login:</span><br><span class="line">                qqLogin();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.iv_wx_login:</span><br><span class="line">                wxLogin();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.iv_sina_login:</span><br><span class="line">                sinaLogin();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">okForLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!DeviceUtil.hasInternet()) &#123;</span><br><span class="line">            ToastUtil.toast(R.string.tip_no_internet);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BaseJsonHttpResponseHandler mHandler = <span class="keyword">new</span> BaseJsonHttpResponseHandler() &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(<span class="keyword">int</span> statusCode, Header[] headers, String rawJsonResponse, Object response)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                handleLoginResult((LoginResult)response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Header[] headers, Throwable throwable, String rawJsonData, Object errorResponse)</span> </span>&#123;</span><br><span class="line">            ToastUtil.toast(<span class="string">"网络出现错误，请重试。("</span> + statusCode + <span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Object <span class="title">parseResponse</span><span class="params">(String rawJsonData, <span class="keyword">boolean</span> isFailure)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> JsonUtil.resolveLoginResult(rawJsonData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onFinish();</span><br><span class="line">            hideWaitDialog();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!okForLogin())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        mUserName = etUserName.getText().toString();</span><br><span class="line">        mPassword = etPassword.getText().toString();</span><br><span class="line"></span><br><span class="line">        hideKeyboard();</span><br><span class="line">        showWaitDialog(R.string.progress_login).show();</span><br><span class="line">        SamsaraAPI.login(mUserName, mPassword, mHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLoginResult</span><span class="params">(LoginResult result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(result.getDataResult().isOK()) &#123;</span><br><span class="line">            ...</span><br><span class="line">            AppContext.getContext().saveUserInfo(result.getUser());</span><br><span class="line">            hideWaitDialog();</span><br><span class="line">            handleLoginSuccess();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            AppContext.getContext().cleanLoginInfo();</span><br><span class="line">            ToastUtil.showToast(<span class="string">"错误："</span> + result.getDataResult().getErrorMsg());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLoginSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ToastUtil.toast(<span class="string">"登录成功"</span>);</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">qqLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">wxLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sinaLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果登录逻辑很复杂（比如有很多种三方登录逻辑），那么Activity可能会比较臃肿。这时候就要减轻Activity的职责，把代码重构成MVP架构。这个时候Activity作为View层，而把主要业务逻辑放至Presenter层。Presenter层与View层的交互是通过接口实现的。<br><img src="http://img.blog.csdn.net/20151025002219889" alt="重构后的架构"><br>IBaseLoginService接口为普通登录接口，IThirdLoginService接口继承普通登录接口，也扩展作为三方扩展登录接口，登录逻辑的具体实现在LoginServiceImpl类里。<br>我们把登录接口设计成这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBaseLoginService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(String username, String password, LoginResultCallback callback)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IThirdLoginService</span> <span class="keyword">extends</span> <span class="title">IBaseLoginService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">wxLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">qqLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">weiboLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们同时设计了登录的回调接口，用于处理登录成功或失败的逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginResultCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">(LoginResult result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> error_code)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们在LoginServiceImpl类里实现登录逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title">IThirdLoginService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(<span class="keyword">final</span> String username, <span class="keyword">final</span> String password, <span class="keyword">final</span> LoginResultCallback callback)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BaseJsonHttpResponseHandler mHandler = <span class="keyword">new</span> BaseJsonHttpResponseHandler() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(<span class="keyword">int</span> statusCode, Header[] headers, String rawJsonResponse, Object response)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    callback.onLoginSuccess((LoginResult)response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Header[] headers, Throwable throwable, String rawJsonData, Object errorResponse)</span> </span>&#123;</span><br><span class="line">                callback.onFailure(statusCode);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> Object <span class="title">parseResponse</span><span class="params">(String rawJsonData, <span class="keyword">boolean</span> isFailure)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> JsonUtil.resolveLoginResult(rawJsonData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                SamsaraAPI.login(username, password, mHandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//<span class="doctag"><span class="keyword">TODO</span></span>:此处省略第三方登录逻辑</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wxLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span> </span>&#123;</span><br><span class="line">        LogUtil.toast(<span class="string">"微信API 接口未开放"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qqLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span> </span>&#123;</span><br><span class="line">        LogUtil.toast(<span class="string">"QQ API 接口未开放"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">weiboLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span> </span>&#123;</span><br><span class="line">        LogUtil.toast(<span class="string">"微博API 接口未开放"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中，这里对网络的处理用了AsyncHttpClient库，以后也可以替换成Volley；SamsaraAPI是为此App设计的API类。到这里，如果后边三个三方实现比较臃肿的话，整个登录业务逻辑类就显得比较臃肿了，我思考了一下，再把三方逻辑的实现单列一个类，需要的时候继承？不过用继承也不是很好的方法，可以考虑用组合或者装饰模式来实现（此处留待想到更好的设计模式）。</p>
<p><strong>Addition</strong>：如果在登录之前需要对登录数据及环境进行处理，且处理逻辑比较多的话，我们可以借助AOP的思想，利用代理模式，将这些通用逻辑（横切面）与特定业务逻辑（纵面）分开，更好地解除耦合。如日志、数据校验之类的逻辑都属于通用逻辑；当然另一种方法就是封装成各种Util类，我这里采用了后一种方法。</p>
<p><img src="http://pic001.cnblogs.com/images/2012/1/2012040113391482.jpg" alt="MVC与MVP架构（图片来源于网络）"></p>
<p>接下来就是View层接口了。前边提到过，<strong>Presenter与View是通过接口进行交互的</strong>，因此这个View接口如何设计也至关重要。我这里考虑的是，对于我们的一个业务逻辑：</p>
<ul>
<li>此逻辑需要获取什么数据？</li>
<li>此逻辑进行时需要有什么表现？（比如进度条对话框）</li>
<li>逻辑执行的结果以及对UI的反馈？</li>
</ul>
<p>比如，对于登录逻辑，我们需要从UI中获取用户名和密码；登录请求发出后需要等待服务器响应，这段时间应该会显示等待对话框；登录响应后，返回登录成功或失败的信息，对应更新UI和数据，因此我设计成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBasicLoginView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleLoginSuccess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showWaiting</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hideWaiting</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">okForLogin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后就是Presenter的设计了，Presenter与LoginService和LoginView使用组合模式：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginPresenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IThirdLoginService loginService;</span><br><span class="line">    <span class="keyword">private</span> IBasicLoginView loginView;</span><br><span class="line">    <span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginPresenter</span><span class="params">(IBasicLoginView loginView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginView = loginView;</span><br><span class="line">        <span class="keyword">this</span>.loginService = <span class="keyword">new</span> LoginServiceImpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!loginView.okForLogin())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        loginView.showWaiting();</span><br><span class="line">        loginService.login(loginView.getUsername(), loginView.getPassword(),</span><br><span class="line">                <span class="keyword">new</span> LoginResultCallback() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">(<span class="keyword">final</span> LoginResult result)</span> </span>&#123;</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        handleLoginResult(result);</span><br><span class="line">                        loginView.hideWaiting();</span><br><span class="line">                        loginView.handleLoginSuccess();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> error_code)</span> </span>&#123;</span><br><span class="line">                ToastUtil.toast(<span class="string">"网络出现错误，请重试。("</span> + error_code + <span class="string">")"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLoginResult</span><span class="params">(LoginResult result)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qqLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loginService.qqLogin(<span class="string">""</span>, <span class="string">""</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wxLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loginService.wxLogin(<span class="string">""</span>, <span class="string">""</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sinaLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loginService.weiboLogin(<span class="string">""</span>, <span class="string">""</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后实现Activity：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">IBasicLoginView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Bind</span>(R.id.et_username)</span><br><span class="line">    EditText etUserName;</span><br><span class="line">    <span class="annotation">@Bind</span>(R.id.et_password)</span><br><span class="line">    EditText etPassword;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginPresenter presenter = <span class="keyword">new</span> LoginPresenter(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getLayoutId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.activity_login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (item.getItemId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> android.R.id.home:</span><br><span class="line">                onBackPressed();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasBackButton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getActionBarTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.string.login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="annotation">@OnClick</span>(&#123;R.id.btn_login, R.id.iv_qq_login, R.id.iv_wx_login, R.id.iv_sina_login&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> id = v.getId();</span><br><span class="line">        <span class="keyword">switch</span> (id) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.btn_login:</span><br><span class="line">                presenter.login();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.iv_qq_login:</span><br><span class="line">                presenter.qqLogin();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.iv_wx_login:</span><br><span class="line">                presenter.wxLogin();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.iv_sina_login:</span><br><span class="line">                presenter.sinaLogin();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">okForLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!DeviceUtil.hasInternet()) &#123;</span><br><span class="line">            ToastUtil.toast(R.string.tip_no_internet);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> etUserName.getText().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> etPassword.getText().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showWaiting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        hideKeyboard();</span><br><span class="line">        showWaitDialog(R.string.progress_login).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideWaiting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        hideWaitDialog();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoginSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        ToastUtil.toast(<span class="string">"登录成功"</span>);</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于这只是练手，原Activity逻辑也不算也别复杂（五百行左右），因此对架构进行重构后并没有看出开发上有什么便捷之处，但以后可能会有更为复杂的逻辑，若不进行适当的重构，Activity可能会超过1000行，特别臃肿，不利于扩展和调BUG。因此，使用MVP/MVVM架构，在一个大项目中是必不可少的。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Architecture/">Architecture</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-cpp-stl-hashmap" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/C-C/cpp-stl-hashmap/" class="article-date">
      <time datetime="2015-10-23T16:00:00.000Z" itemprop="datePublished">2015-10-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/C-C/cpp-stl-hashmap/">C++ STL之哈希表 | unordered_map</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>C++ STL中，哈希表对应的容器是<code>unordered_map</code>（since C++ 11）。<br>根据C++ 11标准的推荐，用<code>unordered_map</code>代替<code>hash_map</code>。</p>
<h1 id="Prolouge">Prolouge</h1><p>先来回顾一下数据结构中哈希表相关的知识。<br>哈希表是根据关键码值(Key value)而直接进行访问的数据结构。也就是说，它通过把关键码值映射到表中一个位置来访问记录，以加快查找的速度，这个映射函数叫做散列函数。<br>哈希表的一个重要问题就是如何解决映射冲突的问题。常用的有两种：<strong>开放地址法</strong> 和 <strong>链地址法</strong>。</p>
<h1 id="与map的区别">与map的区别</h1><p>STL中，map对应的数据结构是<strong>红黑树</strong>。红黑树是一种近似于平衡的二叉查找树，里面的数据是有序的。在红黑树上做查找操作的时间复杂度为 <strong>O(logN)</strong>。而unordered_map对应 <strong>哈希表</strong>，哈希表的特点就是查找效率高，时间复杂度为常数级别 <strong>O(1)</strong>， 而额外空间复杂度则要高出许多。所以对于需要高效率查询的情况，使用unordered_map容器。而如果对内存大小比较敏感或者数据存储要求有序的话，则可以用map容器。</p>
<h1 id="基本使用">基本使用</h1><p>unordered_map的用法和map大同小异，一个简单示例：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;iostream&gt;</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;unordered_map&gt;</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;string&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; <span class="built_in">map</span>;</span><br><span class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">1</span>, <span class="string">"Scala"</span>));</span><br><span class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">2</span>, <span class="string">"Haskell"</span>));</span><br><span class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">3</span>, <span class="string">"C++"</span>));</span><br><span class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">6</span>, <span class="string">"Java"</span>));</span><br><span class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">14</span>, <span class="string">"Erlang"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt;::iterator it;</span><br><span class="line">    <span class="keyword">if</span> ((it = <span class="built_in">map</span>.find(<span class="number">6</span>)) != <span class="built_in">map</span>.end()) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; it-&gt;second &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="使用自定义类">使用自定义类</h1><p>要使用哈希表，必须要有对应的计算散列值的算法以及判断两个值（或对象）是否相等的方法。<br>在Java中，Object类里有两个重要方法：<code>hashCode</code>和<code>equals</code>方法。其中<code>hashCode</code>方法便是为散列存储结构服务的，用来计算散列值；而<code>equals</code>方法则是用来判断两对象是否等价。由于所有的类都继承自<code>java.lang.Object</code>类，因此所有类相当于都拥有了这两个方法。</p>
<p>而在C++中没有自动声明这类函数，STL只为C++常用类提供了散列函数，因此如果想在<code>unordered_map</code>中使用自定义的类，则必须为此类提供一个哈希函数和一个判断对象是否相等的函数（e.g. 重载==运算符）。下面是一个简单示例（扒自数据结构上机作业的部分代码）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cin</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::endl;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">unordered_map</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line"><span class="comment">//private:</span></span><br><span class="line"><span class="comment">//    string phone;</span></span><br><span class="line"><span class="comment">//    string name;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">string</span> phone;</span><br><span class="line">    <span class="built_in">string</span> name;</span><br><span class="line">    <span class="built_in">string</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Person</span><span class="params">(<span class="built_in">string</span> name, <span class="built_in">string</span> phone, <span class="built_in">string</span> address)</span>: <span class="title">name</span><span class="params">(name)</span>, <span class="title">phone</span><span class="params">(phone)</span>, <span class="title">address</span><span class="params">(address)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// overload operator==</span></span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> Person&amp; p) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;phone == p.phone &amp;&amp; <span class="keyword">this</span>-&gt;name == p.name</span><br><span class="line">            &amp;&amp; <span class="keyword">this</span>-&gt;address == p.address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">friend</span> <span class="built_in">std</span>::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream&amp; os, Person&amp; p) &#123;</span><br><span class="line">        os &lt;&lt; <span class="string">"[Person] -&gt; ("</span> &lt;&lt; p.name &lt;&lt; <span class="string">", "</span> &lt;&lt; p.phone &lt;&lt; <span class="string">", "</span></span><br><span class="line">           &lt;&lt; p.address &lt;&lt; <span class="string">")"</span>;</span><br><span class="line">        <span class="keyword">return</span> os;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// declare hash&lt;Person&gt;</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="built_in">std</span> &#123;</span><br><span class="line"> <span class="keyword">template</span> &lt;&gt;</span><br><span class="line"> <span class="keyword">struct</span> hash&lt;Person&gt; &#123;</span><br><span class="line">     <span class="built_in">std</span>::<span class="keyword">size_t</span> <span class="keyword">operator</span>()(<span class="keyword">const</span> Person&amp; p) <span class="keyword">const</span> &#123;</span><br><span class="line">      <span class="keyword">using</span> <span class="built_in">std</span>::<span class="keyword">size_t</span>;</span><br><span class="line">      <span class="keyword">using</span> <span class="built_in">std</span>::hash;</span><br><span class="line">      <span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line">      <span class="comment">// Compute individual hash values for first,</span></span><br><span class="line">      <span class="comment">// second and third and combine them using XOR</span></span><br><span class="line">      <span class="comment">// and bit shifting:</span></span><br><span class="line">      <span class="keyword">return</span> ((hash&lt;<span class="built_in">string</span>&gt;()(p.phone)</span><br><span class="line">        ^ (hash&lt;<span class="built_in">string</span>&gt;()(p.name) &lt;&lt; <span class="number">1</span>)) &gt;&gt; <span class="number">1</span>)</span><br><span class="line">        ^ (hash&lt;<span class="built_in">string</span>&gt;()(p.address) &lt;&lt; <span class="number">1</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">unordered_map</span>&lt;<span class="built_in">string</span>, Person&gt; phoneMap;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">selectByPhone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> phone;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Input the phone number: "</span>; <span class="built_in">cin</span> &gt;&gt; phone;</span><br><span class="line">    <span class="built_in">unordered_map</span>&lt;<span class="built_in">string</span>, Person&gt;::iterator it;</span><br><span class="line">    <span class="keyword">int</span> size = phoneMap.size();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> pc = <span class="number">0</span>; pc &lt; size; pc++) &#123;</span><br><span class="line">        <span class="keyword">if</span>((it = phoneMap.find(phone)) != phoneMap.end()) &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"\033[32mQuery result: "</span> &lt;&lt; it-&gt;second &lt;&lt; <span class="string">"\033[0m"</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"\033[33mQuery result : target_not_found\033[0m"</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于哈希值如何计算，前面我写过一篇文章专门介绍这个：<a href="http://www.sczyh30.com/posts/Java/java-hashcode-equal">hashCode方法及equals方法的规范</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/C-C/">C/C++</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HashMap/">HashMap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STL/">STL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Summary/">Summary</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-android-performance-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Develop/android-performance-1/" class="article-date">
      <time datetime="2015-10-23T10:36:00.000Z" itemprop="datePublished">2015-10-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Develop/android-performance-1/">对Android应用性能优化的一些总结（1）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在移动端内存非常宝贵，我们要尽可能地去优化内存以达到最佳性能，并努力地去避免OOM问题。这篇文章总结一些最常见的Android性能优化的一些事项~</p>
<hr>
<h2 id="图片加载">图片加载</h2><p>在移动端，图片的加载往往是最消耗内存的，OOM也经常会发生在加载图片时。以下是加载图片的几个注意事项：</p>
<ul>
<li>按需要的大小加载。缩略图加载成原图的精细度并不会提升视觉上的效果，但会额外占用不少内存。</li>
<li>图片的缓存使用<strong>LruCache</strong>，并且合理地设置缓存大小（有关LRU Cache的原理见<a href="http://www.sczyh30.com/posts/Algorithm/algorithm-cache/">这里</a>)</li>
<li>可以用一些高效的图片加载库，比如Facebook的Fresco</li>
</ul>
<h2 id="注意一些额外的内存消耗">注意一些额外的内存消耗</h2><ul>
<li>应特别注意HashMap这个数据结构，必要的时候可以用<strong>SparseArray</strong>等等的数据结构代替以节省内存</li>
<li>需要频繁修改字符串的地方考虑用<strong>StringBuilder</strong>代替String</li>
<li>避免创建无用的实例</li>
</ul>
<h2 id="有限度地使用Service">有限度地使用Service</h2><p>当我们启动一个Service时，系统会倾向于将这个Service所依赖的进程进行保留，这样就会导致这个进程变得非常消耗内存。并且，系统可以在LRU cache当中缓存的进程数量也会减少，导致切换应用程序的时候耗费更多性能。严重的话，甚至有可能会导致崩溃，因为系统在内存非常吃紧的时候可能已无法维护所有正在运行的Service所依赖的进程了。</p>
<p>因此，控制好Service的生命周期是很重要的。切忌一个无用的Service跑在后台，这会非常影响性能。如果一个逻辑只需要进行一次，那么可以用<strong>IntentService</strong>代替。</p>
<h2 id="有限度地使用依赖注入框架">有限度地使用依赖注入框架</h2><p>根据需要使用依赖注入框架，它在简化开发的同时，也会带来额外的性能损耗。</p>
<p>在Web开发中，为了良好的架构以及各模块更松层次的耦合，我们一般都会使用IoC框架（如Spring），它根据XML配置文件或注解，通过反射来动态地创建对象或调用目标方法，这种基于反射的机制会额外消耗一部分内存，但在服务器端看来这些消耗还是可以接受的。</p>
<p>但是，在App开发中，内存是非常宝贵的。假设我们用了一些UI注入框架（如ButterKnife），那么运行期间框架就要去搜索注解配置，并加载大量的对象到内存，其中很多可能都是用不到，并且短时间之内不能被回收的。这样在内存紧张的时候，也可能导致OOM或卡顿等现象。因此，根据需要使用依赖注入框架。（我就比较喜欢用。。。因为很方便。。。）</p>
<p><img src="http://img.blog.csdn.net/20151023172047218" alt="ButterKnife 基于注解的UI配置"></p>
<h2 id="Handler必须为静态内部类">Handler必须为静态内部类</h2><p>首先复习一下Java几种内部类的语言规范，Java中的<strong>inner class</strong>（内部类）定义在一个类的内部，它有一个<strong>指向外部类的引用</strong>。这就有可能导致一个问题，其外部类的生命周期已经结束，而由于inner class持有外部类的引用，并且inner class与其它对象还有引用关联，因此GC进行可达性分析时发现内部类与外部类仍有引用关系，因此不会cause GC，从而导致内存泄露。<br>而<strong>static nested class</strong>（静态内部类）虽定义在类的内部，但是它<strong>不持有外部类的引用</strong>，只能访问外部类的静态实例和方法。</p>
<p>在安卓开发中，一个典型的例子是Handler的使用，它会有这样的问题：</p>
<blockquote>
<p>In Android, Handler classes should be static or leaks might occur. Messages enqueued on the application thread’s MessageQueue also retain their target Handler. If the Handler is an inner class, its outer class will be retained as well. To avoid leaking the outer class, declare the Handler as a static nested class with a WeakReference to its outer class.</p>
</blockquote>
<p>这句话的主旨就是，Handler类必须声明为静态（内部）类（static nested class），否则可能会发生内存泄露。因为，进入MessageQueue的Message会持有它们目标Handler的引用；这就可能出现一种情况，一个消息还在排队，而此时目标Handler类所对应的外部类的生命周期已到onDestroy，即将被GC，但由于目标Handler类仍持有其外部类的引用，使得外部类不能被回收，从而导致内存泄露。这一点说明了<strong>Handler类型的对象，生命周期是未知的</strong>。</p>
<p>然而如果声明为static，又会有许多不方便的地方，比如很多逻辑需要访问外部类的非静态变量和非静态方法。此时，我们应该使用外部类的<strong>弱引用</strong>（WeakReference），举例表示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;DeviceUserFragment&gt; mFragment;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHandler</span><span class="params">(DeviceUserFragment fragment)</span> </span>&#123;</span><br><span class="line">            mFragment = <span class="keyword">new</span> WeakReference&lt;&gt;(fragment);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.handleMessage(msg);</span><br><span class="line">            Object object = msg.obj;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> HWServiceConfig.GET_DEVICE_USER_INFO:</span><br><span class="line">                    mFragment.get().mInfo = (DataUserInfo)object;</span><br><span class="line">                    mFragment.get().isInfoOK = <span class="keyword">true</span>;</span><br><span class="line">                    mFragment.get().updateUI();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里顺便复习一下JVM中的四种引用的知识吧（直接扒的以前自己的文章）：</p>
<ul>
<li><strong>StrongReference</strong>（强引用）是最普通的引用类型，只要强引用存在，GC就不会进行垃圾回收。</li>
<li><strong>SoftReference</strong>（软引用）用来描述一些有用但是非必需的对象。如果一个对象只具有软引用，则内存空间足够，垃圾回收器就不会回收它；<strong>如果内存空间不足了，就会回收这些对象的内存</strong>。只要垃圾回收器没有回收它，该对象就可以被程序使用。软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，JVM就会把这个软引用加入到与之关联的引用队列中。软引用可用来实现内存敏感的高速缓存。</li>
<li><strong>WeakReference</strong>（弱引用）是一种生命周期比软引用更短的引用。当GC扫描启动时，只要扫描到只具有弱引用的对象，<strong>无论内存是否够用都会执行GC</strong>；但由于GC线程优先级很低，因此并不一定能迅速发现这些弱引用对象。弱引用也可以和一个引用队列联合使用。</li>
<li><strong>PhantomReference</strong>（虚引用）不同于其余三种引用，虚引用不会影响对象的生命周期，也无法通过虚引用获得对象的一个实例；如果一个对象仅持有虚引用，那么它就和没有任何引用一样，在任何时候都可能被垃圾回收器回收。虚引用主要用来跟踪对象被垃圾回收器回收的活动，它必须和引用队列联合使用。</li>
</ul>
<p>明白了弱引用的生命周期，此处想必就很好理解了。构造一个外部类的弱引用，然后通过<code>get</code>方法获得其实例进行操作即可，既避免了内存泄露，又可以自由地调用外部类的方法。<br><strong>WeakReference</strong>和<strong>SoftReference</strong>在其他很多地方也都有运用，以后再补充~</p>
<hr>
<h1 id="参考文章">参考文章</h1><ul>
<li><a href="http://blog.csdn.net/guolin_blog/article/details/42238627" target="_blank" rel="external">Android最佳性能实践 - 郭霖的专栏</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Develop/">Develop</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/性能优化/">性能优化</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2015 - 2016 sczyh30's blog
            </div>
            <div class="footer-right">
                <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1255963745'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1255963745%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));
                </script>
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank">Yelee</a> by MOxFIVE. Enhanced by sczyh30.
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>