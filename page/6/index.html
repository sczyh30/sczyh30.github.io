<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="sczyh30" />


    
    


<meta name="description" content="sczyh30&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="「浮生若梦」 - sczyh30's blog">
<meta property="og:url" content="http://www.sczyh30.com/page/6/index.html">
<meta property="og:site_name" content="「浮生若梦」 - sczyh30's blog">
<meta property="og:description" content="sczyh30&apos;s blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="「浮生若梦」 - sczyh30's blog">
<meta name="twitter:description" content="sczyh30&apos;s blog">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="「浮生若梦」 - sczyh30&#39;s blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>「浮生若梦」 - sczyh30&#39;s blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="http://7xkkgd.com1.z0.glb.clouddn.com/blog-default-lambda-avatar.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">sczyh30</a></h1>
        </hgroup>

        
        <p class="header-subtitle">踏歌长行，梦想永在。</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about">About Me</a></li>
                        
                            <li><a href="/en/">Blog(EN)</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="/about" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/sczyh30" title="GitHub"></a>
                            
                                <a class="fa 新浪微博" href="http://weibo.com/sczyh30" title="新浪微博"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Google" href="https://plus.google.com/u/0/117807083506391735472" title="Google"></a>
                            
                                <a class="fa Twitter" href="https://twitter.com/sczyh30" title="Twitter"></a>
                            
                                <a class="fa Medium" href="https://medium.com/@sczyh30" title="Medium"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AMQP/">AMQP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/APT/">APT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Akka/">Akka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/">Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-14/">C++ 14</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CAP/">CAP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CE3/">CE3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CPS/">CPS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/">Cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Category-Theory/">Category Theory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chemistry/">Chemistry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Continuation/">Continuation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DI/">DI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Engine/">Engine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Euterpea/">Euterpea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Event-Loop/">Event Loop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Functional-Programming/">Functional Programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GC/">GC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GDB/">GDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Game/">Game</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/">Gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/">HashMap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haskell/">Haskell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HotSpot/">HotSpot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/">IO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JUC/">JUC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Klass-oop/">Klass-oop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lambda-Calculus/">Lambda Calculus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LinkedList/">LinkedList</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MIDI/">MIDI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mathematical-Logic/">Mathematical Logic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Metaspace/">Metaspace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netflix-Hystrix/">Netflix Hystrix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Object-Model/">Object Model</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PLT/">PLT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Paper/">Paper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Play-Framework/">Play Framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Quorum/">Quorum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Reflection/">Reflection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/">SQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/STL/">STL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/">Scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scheme/">Scheme</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Slick/">Slick</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sort/">Sort</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Summary/">Summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-Class/">Type Class</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-Lambda/">Type Lambda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-System/">Type System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Type-Theory/">Type Theory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UE4/">UE4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vert-x/">Vert.x</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/View/">View</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web开发/">Web开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中间件/">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/云服务/">云服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存区域/">内存区域</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式/">分布式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式系统/">分布式系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式计算/">分布式计算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基础/">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/容器/">容器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开发/">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异步编程/">异步编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微服务/">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能优化/">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息系统/">消息系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/源码分析/">源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生活/">生活</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线程安全/">线程安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/虚拟化/">虚拟化</a></li></ul>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">Distributed System/Deep Learning/PLT</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">sczyh30</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="http://7xkkgd.com1.z0.glb.clouddn.com/blog-default-lambda-avatar.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">sczyh30</a></h1>
            </hgroup>
            
            <p class="header-subtitle">踏歌长行，梦想永在。</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about">About Me</a></li>
                
                    <li><a href="/en/">Blog(EN)</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/about" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/sczyh30" title="GitHub"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="http://weibo.com/sczyh30" title="新浪微博"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Google" target="_blank" href="https://plus.google.com/u/0/117807083506391735472" title="Google"></a>
                            
                                <a class="fa Twitter" target="_blank" href="https://twitter.com/sczyh30" title="Twitter"></a>
                            
                                <a class="fa Medium" target="_blank" href="https://medium.com/@sczyh30" title="Medium"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-rabbitmq-summary" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Architecture/rabbitmq-summary/" class="article-date">
      <time datetime="2015-11-19T16:12:36.000Z" itemprop="datePublished">2015-11-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Architecture/rabbitmq-summary/">消息队列中间件 | RabbitMQ 总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>最近学习架构设计的时候经常看见基于消息的架构。这里就来总结一下一个常见的高性能消息队列中间件——RabbitMQ，它支持各种各样的消息队列协议(如JMS和AMQP)，并且消息传递比较可靠，并发效率也比较高（RabbitMQ的实现语言是大名鼎鼎的Erlang，天生支持高并发）。这里就来总结一下RabbitMQ的基本使用，以及消息队列和消息架构的一些注意事项。</p>
<h1 id="生产者-消费者模型">生产者-消费者模型</h1><h2 id="Intro">Intro</h2><p>最简单的消息队列模型应该就是 <strong>生产者-消费者模型</strong> 了。简单的一对一模型如下图：</p>
<p><img src="http://www.rabbitmq.com/img/tutorials/python-one.png" alt=""></p>
<p>其中P代表生产者（Producer），C代表消费者（Consumer）,中间部分代表消息队列（Message Queue）。</p>
<p>下面我们用RabbitMQ来实现，首先是生产者一端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_q1"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">//步骤一：建立连接</span></div><div class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</div><div class="line">        factory.setHost(<span class="string">"localhost"</span>);</div><div class="line">        <span class="comment">//factory.setPort(6666);</span></div><div class="line">        Connection connection = factory.newConnection();</div><div class="line">        Channel channel = connection.createChannel();</div><div class="line">        <span class="comment">//步骤二：定义消息队列</span></div><div class="line">        channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        String message = <span class="string">"[Message Producer] 66666"</span>;</div><div class="line">        <span class="comment">//步骤三：发布消息</span></div><div class="line">        channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"UTF-8"</span>));</div><div class="line">        System.out.println(<span class="string">"[MessageQueue] Message sent =&gt; message="</span> + message);</div><div class="line">        <span class="comment">//关闭连接</span></div><div class="line">        channel.close();</div><div class="line">        connection.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>消费者一端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"test_q1"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">//步骤一：建立连接</span></div><div class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</div><div class="line">        factory.setHost(<span class="string">"localhost"</span>);</div><div class="line">        Connection connection = factory.newConnection();</div><div class="line">        Channel channel = connection.createChannel();</div><div class="line">        <span class="comment">//步骤二：创建一个消费者对象，并利用handleDelivery回调函数接受消息</span></div><div class="line">        Consumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                String msg = <span class="keyword">new</span> String(body, <span class="string">"UTF-8"</span>);</div><div class="line">                System.out.println(<span class="string">"[Message Recv] =&gt; "</span> + msg);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="comment">//步骤三：将消费者端与消息队列绑定</span></div><div class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，无论是消费者端还是生产者端，首先要建立通信连接（<code>ConnectionFactory -&gt; Connection -&gt; Channel</code>）。</p>
<p>这只是最简单的一种情况，后边将介绍更普遍、更复杂的情况。</p>
<h2 id="定义消息队列">定义消息队列</h2><p>定义消息队列可以用<code>Channel</code>接口的<code>queueDeclare</code>方法，它有两个重载版本。含参的<code>queueDeclare</code>方法定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Declare a queue</div><div class="line">     * <span class="doctag">@see</span> com.rabbitmq.client.AMQP.Queue.Declare</div><div class="line">     * <span class="doctag">@see</span> com.rabbitmq.client.AMQP.Queue.DeclareOk</div><div class="line">     * <span class="doctag">@param</span> queue the name of the queue</div><div class="line">     * <span class="doctag">@param</span> durable true if we are declaring a durable queue (the queue will survive a server restart)</div><div class="line">     * <span class="doctag">@param</span> exclusive true if we are declaring an exclusive queue (restricted to this connection)</div><div class="line">     * <span class="doctag">@param</span> autoDelete true if we are declaring an autodelete queue (server will delete it when no longer in use)</div><div class="line">     * <span class="doctag">@param</span> arguments other properties (construction arguments) for the queue</div><div class="line">     * <span class="doctag">@return</span> a declaration-confirm method to indicate the queue was successfully declared</div><div class="line">     * <span class="doctag">@throws</span> java.io.IOException if an error is encountered</div><div class="line">     */</div><div class="line">    Queue.<span class="function">DeclareOk <span class="title">queueDeclare</span><span class="params">(String queue, <span class="keyword">boolean</span> durable, <span class="keyword">boolean</span> exclusive, <span class="keyword">boolean</span> autoDelete,</span></span></div><div class="line">                                 Map&lt;String, Object&gt; arguments) <span class="keyword">throws</span> IOException;</div></pre></td></tr></table></figure>
<p>可以看到，它接受五个参数。第一个参数对应消息队列名称，第二个参数对应消息队列是否可以持久化，第三个参数对应消息队列是否仅限于当前连接，第四个参数对应消息队列是否在不用的情况下自动删除，第五个参数对应消息队列其他的一些设置。</p>
<p>另外还有一个无参的<code>queueDeclare</code>方法，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> com.rabbitmq.client.AMQP.Queue.<span class="function">DeclareOk <span class="title">queueDeclare</span><span class="params">()</span></span></div><div class="line">        <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="keyword">return</span> queueDeclare(<span class="string">""</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">null</span>); <span class="comment">// 默认不可持久化</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：Producer端和Consumer端的消息队列定义需要保持一致。</p>
</blockquote>
<h2 id="Envelope对象">Envelope对象</h2><p>Envelope对象封装了AMQP通信需要的数据，如deliveryTag, redeliver flag, exchange, routingKey等。其构造函数注释中有这几个变量的解释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Construct an &#123;<span class="doctag">@link</span> Envelope&#125; with the specified construction parameters</div><div class="line">    * <span class="doctag">@param</span> deliveryTag the delivery tag</div><div class="line">    * <span class="doctag">@param</span> redeliver true if this is a redelivery following a failed ack</div><div class="line">    * <span class="doctag">@param</span> exchange the exchange used for the current operation</div><div class="line">    * <span class="doctag">@param</span> routingKey the associated routing key</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Envelope</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> redeliver, String exchange, String routingKey)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>._deliveryTag = deliveryTag;</div><div class="line">       <span class="keyword">this</span>._redeliver = redeliver;</div><div class="line">       <span class="keyword">this</span>._exchange = exchange;</div><div class="line">       <span class="keyword">this</span>._routingKey = routingKey;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="消息分发机制(Dispatch)">消息分发机制(Dispatch)</h2><p>RabbitMQ采用 <strong>轮询分发机制</strong>（Round-robin dispatching），每个消费者将接收到数量相近的消息。</p>
<p>扩展：如果想控制每次给消费者端传递的消息数量（流量控制），可以通过<code>Channel</code>的<code>basicQos</code>方法，它有三个重载版本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Request specific "quality of service" settings.</div><div class="line">     *</div><div class="line">     * These settings impose limits on the amount of data the server</div><div class="line">     * will deliver to consumers before requiring acknowledgements.</div><div class="line">     * Thus they provide a means of consumer-initiated flow control.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchSize, <span class="keyword">int</span> prefetchCount, <span class="keyword">boolean</span> global)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">    exnWrappingRpc(<span class="keyword">new</span> Basic.Qos(prefetchSize, prefetchCount, global));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Public API - &#123;<span class="doctag">@inheritDoc</span>&#125; */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchCount, <span class="keyword">boolean</span> global)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException &#123;</div><div class="line">        basicQos(<span class="number">0</span>, prefetchCount, global);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Public API - &#123;<span class="doctag">@inheritDoc</span>&#125; */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchCount)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">    basicQos(<span class="number">0</span>, prefetchCount, <span class="keyword">false</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其中:</p>
<ul>
<li><code>prefetchSize</code>表示服务器给消费者端传递数据大小的上限，0为不限</li>
<li><code>prefetchCount</code>表示服务器给消费者端传递数据数量的上限，0为不限</li>
<li><code>global</code>标志位表示此设置是否应用于整个<code>Channel</code>而不是每个<code>Consumer</code></li>
</ul>
<h2 id="消息确认机制(Acknowledge)">消息确认机制(Acknowledge)</h2><p>设想一下这种场景：消费者端处理一个耗时任务时被强制结束任务，此时任务还没有完成，但是消息却已从消息队列中发送了出去。如果没有一定的消息确认机制，那么我们将丢失掉此消息及后面一堆发送至此消费者但还未经处理的消息。</p>
<p>RabbitMQ支持消息确认机制。如果消费者已处理完任务，那么它将向Broker发送ACK消息，告知某条消息已被成功处理，可以从队列中移除。如果消费者端没有发送回ACK消息，那么Broker会认为消息处理失败，会将此消息及后续消息分发给其他消费者端进行处理(redeliver flag置为true)。</p>
<p>这种确认机制和TCP/IP协议确立连接类似。不同的是，TCP/IP确立连接需要经过三次握手，而RabbitMQ只需要一次ACK。</p>
<blockquote>
<p><strong>注意：RabbitMQ当且仅当检测到ACK消息未发出且消费者端的连接终止时才会将消息重新分发给其他消费者端，因此不需要担心消息处理时间过长而被重新分发的情况。</strong></p>
</blockquote>
<p>我们可以通过设置<code>basicConsume</code>方法的<code>autoAck</code>标志位来设置其消息确认机制。<code>basicConsume</code>方法的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck, Consumer callback)</span> <span class="keyword">throws</span> IOException</span>;</div></pre></td></tr></table></figure>
<p>当<code>autoAck</code>为true时，不启用显式消息确认机制，消息分发出去即为确认完毕。<code>autoAck</code>为false时，启用上述的消息确认机制。</p>
<p>消费者端发送ACK消息可以通过在回调函数中调用Channel的<code>basicAck</code>方法实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<p>其定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Acknowledge one or several received</div><div class="line">     * messages. Supply the deliveryTag from the &#123;<span class="doctag">@link</span> com.rabbitmq.client.AMQP.Basic.GetOk&#125;</div><div class="line">     * or &#123;<span class="doctag">@link</span> com.rabbitmq.client.AMQP.Basic.Deliver&#125; method</div><div class="line">     * containing the received message being acknowledged.</div><div class="line">     * <span class="doctag">@see</span> com.rabbitmq.client.AMQP.Basic.Ack</div><div class="line">     * <span class="doctag">@param</span> deliveryTag the tag from the received &#123;<span class="doctag">@link</span> com.rabbitmq.client.AMQP.Basic.GetOk&#125; or &#123;<span class="doctag">@link</span> com.rabbitmq.client.AMQP.Basic.Deliver&#125;</div><div class="line">     * <span class="doctag">@param</span> multiple true to acknowledge all messages up to and</div><div class="line">     * including the supplied delivery tag; false to acknowledge just</div><div class="line">     * the supplied delivery tag.</div><div class="line">     * <span class="doctag">@throws</span> java.io.IOException if an error is encountered</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException</span>;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>WARNING</strong>：使用的时候千万不要忘了调用<code>basicAck</code>方法！必要的时候可以对Consumer类再做一层封装。</p>
</blockquote>
<h2 id="简单的消息持久化(Message_durability)">简单的消息持久化(Message durability)</h2><p>RabbitMQ的消息确认机制保证了即使消费者端挂了，我们的消息也可以被顺利处理。然而，如果碰上意外情况，Broker（RabbitMQ Server）挂了（比如意外重启），这种情况下不做任何设置的话，我们的信息仍然会丢失。好在，RabbitMQ同样提供了消息持久化的功能。</p>
<p>首先，我们需要保证我们的消息队列可以持久化，方法上面已经提到过，就是将<code>queueDeclare</code>方法的<code>durable</code>标志位设为true。</p>
<p>然后，我们需要在发布消息的时候通过设置<code>basicPublish</code>方法的<code>props</code>参数为<code>PERSISTENT_TEXT_PLAIN</code>来实现消息可持久化，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">channel.basicPublish(<span class="string">""</span>, TASK_QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN,</div><div class="line">                message.getBytes(<span class="string">"UTF-8"</span>));</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：尽管设置了消息可持久化，但这并不能完全保证消息就一定可以存储到磁盘里。RabbitMQ存在一段时间，接受了一个消息但还没来得及存储。并且，RabbitMQ不一定对所有消息都做fsync（即同步内存中的消息到硬盘），有些消息可能只是被缓存而不会被持久化。因此，<strong>这种消息持久化机制是不可靠的</strong>，特别是对大型项目。如果需要可靠的消息持久化，可以使用 <strong>publisher confirm</strong>。</p>
</blockquote>
<h1 id="Exchange">Exchange</h1><p>在RabbitMQ中，producer并不是直接将消息发送到message queue中，而是将它传递给一种叫exchage的结构。顾名思义，exchange用于交换消息，它接受publisher发送的消息，并按照一定的策略传递给下层的消息队列，最后传递到对应的subscriber中。Exchange有好几种：<code>direct</code>, <code>topic</code>, <code>headers</code>, <code>fanout</code>等，分别对应不同的消息分发策略。</p>
<p>在消费者一端，我们需要通过<code>queueBind</code>函数将消息队列绑定到对应的exchange上；如果没有绑定，则RabbitMQ会给其指定一个匿名exchage（即上面生产者-消费者模型中的exchange）。</p>
<h1 id="发布/订阅模型">发布/订阅模型</h1><p>发布-订阅模型也是一种典型的消息模型，它相当于一个“一对多”模型，也就是说publisher可以向多个subscriber发送消息。我们可以用下面的图来表示这种模型：</p>
<p><img src="http://www.rabbitmq.com/img/tutorials/exchanges.png" alt=""></p>
<p>在RabbitMQ中，我们可以通过exchange来实现发布-订阅模型。我们需要在订阅者一端将期望接收消息的队列绑定到我们定义的exchange上（最简单的<code>fanout</code>广播类型即可），然后在发布者端将消息发布至定义的exchange上即可。</p>
<h1 id="路由与模式匹配">路由与模式匹配</h1><p>RabbitMQ还支持路由模式，即像路由那样根据path来分派消息，只要在<code>queueBind</code>函数中指定感兴趣的<code>routingKey</code>即可。路由模式下我们一般使用<code>direct</code>类型的exchange，它会将与队列binding key匹配的消息分发到指定的队列中。</p>
<p><img src="https://www.rabbitmq.com/img/tutorials/direct-exchange.png" alt=""></p>
<p>当然如果我们需要根据path的模式来匹配的话，我们可以使用<code>topic</code>类型的exchange，它可以用于匹配多种pattern下的path并且分发消息。</p>
<p><img src="https://www.rabbitmq.com/img/tutorials/python-five.png" alt=""></p>
<h1 id="RPC">RPC</h1><p>消息队列可以用来实现RPC。我们可以利用消息队列的API封装一个RPC代理类，调用端在通过RPC Proxy调用方法时，调用端会将调用方法的元数据（名称，参数等）包装成一条消息，然后通过相应的消息队列发送至集群的另一节点中，被调用者接收到此消息，将其解码后在本地进行方法调用(LPC)。如果需要返回结果，那么被调用端在方法调用完毕后将结果包装成消息，通过消息队列再发送回调用端即可。这就是用消息队列实现RPC的一般思路。</p>
<p>在RabbitMQ中，实现RPC的思路比较简单：使用两个队列，分别处理调用请求及调用回复即可：</p>
<p><img src="https://www.rabbitmq.com/img/tutorials/python-six.png" alt=""></p>
<p>注意RPC的调用时间可能会比较长（受到网络、本地调用执行时间等因素影响），因此可能会阻塞执行线程，这也是RPC为人诟病的一点。我们可以对其稍加改造，改成异步模式，这样会使整个系统更加灵活。</p>
<h1 id="与其他消息队列的对比">与其他消息队列的对比</h1><blockquote>
<p>TODO: 待分析；后面有时间研究研究ZeroMQ和Kafka的设计及实现。</p>
</blockquote>
<hr>
<h1 id="参考资料">参考资料</h1><ul>
<li><a href="https://www.rabbitmq.com/documentation.html" target="_blank" rel="external">Documentation - RabbitMQ</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Architecture/">Architecture</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AMQP/">AMQP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RabbitMQ/">RabbitMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/中间件/">中间件</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-y-combinator" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Functional-Programming/y-combinator/" class="article-date">
      <time datetime="2015-11-16T16:00:00.000Z" itemprop="datePublished">2015-11-17</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Functional-Programming/y-combinator/">不动点组合子 | Y Combinator</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在现代编程语言中，函数都是具名的，而在传统的Lambda Calculus中，函数都是没有名字的。这样就出现了一个问题 —— 如何在Lambda Calculus中实现递归函数，即匿名递归函数。Haskell B. Curry发现了一种不动点组合子 —— Y Combinator，用于解决匿名递归函数实现的问题。</p>
<h1 id="Fixed-point_combinator">Fixed-point combinator</h1><p>我们先来看看不动点组合子的定义。不动点组合子(fixed-point combinator)是一个满足以下等式的高阶函数$y$：</p>
<p>$$\forall f, \ y \ f = f \ (y \ f)$$</p>
<p>如果令 $x = f \ x$，那么这其实就是一个求解函数不动点的问题：</p>
<p>$$x = f \ x$$</p>
<h1 id="Y_Combinator">Y Combinator</h1><p>那么不动点组合子有什么用呢？假设我们想要求阶乘，我们通常会用递归来实现：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">factorial</span> :: <span class="type">Int</span> -&gt; <span class="type">Int</span></div><div class="line"><span class="title">factorial</span> <span class="number">0</span> = <span class="number">0</span></div><div class="line"><span class="title">factorial</span> n = n * factorial (n - <span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>在上面的例子中，<code>factorial</code>函数体里面引用了自身。用pseudo lambda calculus可以表示为：</p>
<p>$$f = \lambda n. \ if \ (n == 0) \ 0 \ else \ n * f(n - 1)$$</p>
<p>但是Lambda演算中函数是没有名字的，所以这个地方是没法在函数体内调用f的。那怎么处理呢？我们可以通过某种“黑魔法”实现间接递归 —— 把自己算出来。我们不妨假设一个函数<code>self</code>代表一个“Lambda Calculus中真正的”递归函数，则上式可以改写为：</p>
<p>$$f = \lambda n. \ if \ (n == 0) \ 0 \ else \ n * self(n - 1)$$</p>
<p>我们现在把<code>self</code>函数参数化，设此函数为<code>G</code>：</p>
<p>$$G = \lambda n \ \lambda g. \ if \ (n == 0) \ 0 \ else \ n * g(n - 1)$$</p>
<p>应用 $\beta-reduction$，我们会发现：</p>
<p>$$G \ f = \lambda n. \ if \ (n == 0) \ 0 \ else \ n * f(n - 1)$$</p>
<p>即 $G \ f = f$。</p>
<p>然而这还不够，这里就需要引入不动点组合子了。假设不动点组合子 $Y = \lambda \ f. f (Y \ f)$，且 $f = Y \ G$，那么 $Y G = G (Y \ G) = G \ f = f$，这就表示出<code>f</code>来了！</p>
<p>所以我们需要找到一个与 $Y$ 等效的闭合Lambda表达式，其中最著名的就是Curry发现的 <strong>Y Combinator</strong>:</p>
<p>$$Y = \lambda f. (\lambda x . f \ (x \ x)) (\lambda x. f \ (x \ x))$$</p>
<p>通过 $\beta-reduction$ 验证：</p>
<p>$$Y \ g = \lambda f. (\lambda x . f \ (x \ x)) (\lambda x. f \ (x \ x)) \ g$$</p>
<p>$$= (\lambda x. g \ (x \ x)) (\lambda x. g \ (x \ x)$$</p>
<p>$$= g \ ((\lambda x. g \ (x \ x) \ (\lambda x. g \ (x \ x))$$</p>
<p>$$= g \ (Y \ g)$$</p>
<p>一颗赛艇！至于Y Combinator是如何推出来的，可以参考 <a href="http://mindhacks.cn/2006/10/15/cantor-godel-turing-an-eternal-golden-diagonal/" target="_blank" rel="external">康托尔、哥德尔、图灵——永恒的金色对角线</a> 这篇文章，写的非常完美。</p>
<h1 id="Haskell实现">Haskell实现</h1><p>我们先尝试直接用函数表示：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">fix</span> f = (\x -&gt; f (x x)) (\x -&gt; f (x x))</div></pre></td></tr></table></figure>
<p>GHC会提示错误：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;interactive&gt;:<span class="number">6</span>:<span class="number">25</span>:</div><div class="line">    <span class="type">Occurs</span> check: cannot construct the infinite <span class="class"><span class="keyword">type</span>: r0 ~ r0 -&gt; t</span></div><div class="line">    <span class="type">Expected</span> <span class="class"><span class="keyword">type</span>: r0 -&gt; t</span></div><div class="line">      <span class="type">Actual</span> <span class="class"><span class="keyword">type</span>: (<span class="title">r0</span> -&gt; <span class="title">t</span>) -&gt; t</span></div><div class="line">    <span class="type">Relevant</span> bindings include</div><div class="line">      x :: (r0 -&gt; t) -&gt; t (bound at &lt;interactive&gt;:<span class="number">6</span>:<span class="number">15</span>)</div><div class="line">      f :: t -&gt; t (bound at &lt;interactive&gt;:<span class="number">6</span>:<span class="number">9</span>)</div><div class="line">      fix :: (t -&gt; t) -&gt; t (bound at &lt;interactive&gt;:<span class="number">6</span>:<span class="number">5</span>)</div><div class="line">    <span class="type">In</span> the first argument <span class="keyword">of</span> ‘x’, namely ‘x’</div><div class="line">    <span class="type">In</span> the first argument <span class="keyword">of</span> ‘f’, namely ‘(x x)’</div></pre></td></tr></table></figure>
<p>这里的问题在于<code>x</code>的类型是infinite type，无法在Haskell表示出来(Hindley–Milner类型系统的限制)。参考Reddit上的解决方案，我们需要绕个弯，定义一个<code>Mu</code>算子来绕过类型检查：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">Mu</span> a = <span class="type">Mu</span> (<span class="type">Mu</span> <span class="title">a</span> -&gt; <span class="title">a</span>)</span></div><div class="line"></div><div class="line"><span class="title">y</span> f -&gt; (\h -&gt; h $ <span class="type">Mu</span> h) (\x -&gt; f . (\(<span class="type">Mu</span> g) -&gt; g) x $ x)</div></pre></td></tr></table></figure>
<p>当然还有个更加贴近Y Combinator原本意思的实现：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">Mu</span> f = <span class="type">Mu</span> &#123;<span class="title">unMu</span> :: <span class="title">f</span> (<span class="type">Mu</span> <span class="title">f</span>)&#125;</span></div><div class="line"><span class="title">unfold</span> = unMu</div><div class="line"><span class="title">fold</span>   = <span class="type">Mu</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">X'</span> b a = &#123;<span class="title">unX</span> :: <span class="title">a</span> -&gt; <span class="title">b</span>&#125;</span></div><div class="line"><span class="class"><span class="keyword">type</span> <span class="type">X</span> a = <span class="type">Mu</span> (<span class="type">X</span>' <span class="title">a</span>)</span></div><div class="line"></div><div class="line"><span class="title">unfold'</span> = unX  . unfold</div><div class="line"><span class="title">fold'</span>   = fold . <span class="type">X'</span></div><div class="line"><span class="title">y</span> f = (\x -&gt; f (unfold' x x)) $ fold' (\x -&gt; f (unfold' x x))</div></pre></td></tr></table></figure>
<hr>
<h1 id="References">References</h1><ul>
<li><a href="http://mindhacks.cn/2006/10/15/cantor-godel-turing-an-eternal-golden-diagonal/" target="_blank" rel="external">康托尔、哥德尔、图灵——永恒的金色对角线</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fixed-point_combinator" target="_blank" rel="external">Fixed-point combinator in Wikipedia</a></li>
<li><a href="https://www.reddit.com/r/haskell/comments/3a78zh/implementing_a_ycombinator_in_haskell/" target="_blank" rel="external">Implementing a YCombinator in Haskell</a></li>
<li><a href="http://jozefg.bitbucket.org/posts/2013-11-09-iso-recursive-types.html" target="_blank" rel="external">Fixpoints and Iso-recursive Types</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Functional-Programming/">Functional Programming</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functional-Programming/">Functional Programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Haskell/">Haskell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda-Calculus/">Lambda Calculus</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-haskell-category-basic" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Functional-Programming/haskell-category-basic/" class="article-date">
      <time datetime="2015-11-01T16:00:00.000Z" itemprop="datePublished">2015-11-02</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Functional-Programming/haskell-category-basic/">Haskell学习笔记 | 范畴论与Haskell（基础篇）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>最近入了Haskell的坑了。俗话说得好，一入FP深似海，从此Monad皆是自函子范畴上的幺半群。。。本篇文章主要总结范畴论基础。。。</p>
<h1 id="Category">Category</h1><p>一个<strong>范畴</strong> $C$ 由以下三部分组成：</p>
<ul>
<li>一些<strong>对象</strong>(object)构成的类 $ob(C)$</li>
<li>范畴 $C$ 中对象之间的映射，称为 <strong>态射</strong>(morphism)。对于范畴 $C$ 中任意两个object $A$、$B$，所有的 $A \to B$ 态射的集合用 $hom(A, B)$ 表示，其中 $A$ 称为domain，$B$称为codomain</li>
<li>态射的复合运算($\circ$)，用于将多个态射进行复合。比如 $f: \ A \to B$, $g: \ B \to C$，则$g \circ f: \ A \to C$</li>
</ul>
<p>对范畴中的每一个object $X$，都存在对应的幺元 $id_{X}: X \to X$ ，并且满足关系：</p>
<p>$$ id(B) \circ f = f = f \circ id(A) $$</p>
<p>同时，复合运算是可结合的，比如 $ (h \circ g) \circ f = h \circ (g \circ f) $。</p>
<p>在Haskell中，对应的是：</p>
<ul>
<li>object对应着某个具体的函数（<em>类型？</em>）（这是我的理解，也有很多人认为对象对应着某一类值的集合，即类型。我的理解是<strong>type和type constructor都可以看作是function</strong>）</li>
<li>态射对应着函数之间的映射，这种映射产生新的函数。比如 $f :: (a \to b) \to a \to b$</li>
<li>态射的复合运算代表着函数的复合（复合函数），比如 <code>h = f . g</code></li>
</ul>
<h1 id="Functor">Functor</h1><p>在范畴论中，morphism是object与object之间的映射。那么肯定还有category与category之间的映射，这称为函子（Functor）。</p>
<p>既然是范畴之间的映射，那么函子F的作用就有两个：</p>
<ul>
<li>将范畴C的object($X$)映射到范畴D的object ($F(X)$)</li>
<li>将范畴C的morphism($f: \ X \to Y$)映射到范畴D的morphism($F(f) : \ F(x) \to F(Y)$)</li>
</ul>
<p>并且需要满足两个条件：</p>
<ul>
<li>单位态射关系：$\forall X \in C, F(id_{X}) = id_{F(X)}$</li>
<li>分配率：$\forall f:X \to Y, g: Y \to Z \in C, F(g \circ f) = F(g) \circ F(f)$</li>
</ul>
<p>一般的函子都是协变函子(covariant functor)。将函子中的某个范畴 $C$ 替换为其对偶范畴 $C^{OP}$ 即可得到逆变函子(contravariant functor): $F \ : \ C^{OP} \to D$。</p>
<p>将范畴映射到自身的函子称为自函子(endofunctor)，即把范畴C的对象和态射映射到自身。自函子反映了范畴内部的自相似性。</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/catagory-functor-wk1.png" alt="Functor"></p>
<p>在Haskell中，Functor是一个 <strong>typeclass</strong>，它是这样定义的:<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="type">Functor</span> f <span class="keyword">where</span></span></div><div class="line">    fmap :: (a -&gt; b) -&gt; f a -&gt; f b</div></pre></td></tr></table></figure></p>
<p>其中f是一个 <strong>type constructor</strong>，它接收一个concrete type（实际类型）以构造出一个concrete type，其kind为<code>* -&gt; *</code>。</p>
<p>如果这里的object对应Haskell里的类型的话，那么type constructor相当于morphism，它就是自函子的一部分，即一个范畴的object与另一个范畴的object的映射。</p>
<p>类型与类型的映射一般都是简单类型与复杂类型之间的相互转化，比如<code>int -&gt; Maybe int</code>。而另一部分，即态射与态射之间的映射，其实就是高阶函数（函数与函数之间的映射，因为态射本身就对应Haskell中的函数），在Haskell的Functor里面对应的就是fmap，它将态射<code>a -&gt; b</code>映射为另一个态射<code>f a -&gt; f b</code>:</p>
<p>$$(a \to b) \to f \ a \to f \ b$$</p>
<h1 id="Bifunctor">Bifunctor</h1><p>Bifunctor(二元函子)与普通的Functor区别之处在于Bifunctor的domain为两个范畴的积，比如 $F: \ C_{1} \times C_{2} \to D$。</p>
<h1 id="Hom-functor">Hom-functor</h1><p>对于一个范畴 $C$，其 <strong>hom-functor</strong> 的定义为：$Hom(-,-) : \ C^{OP} \times C \to Set$，它是一个bifunctor。</p>
<p>从hom-functor中衍生出的两个函子：</p>
<ul>
<li>covariant hom-functor: $Hom(A, -): \ C \to Set$，通常称为 <strong>copresheaf</strong></li>
<li>contravariant hom-functor: $Hom(-, A): \ C^{OP} \to Set$，通常称为 <strong>presheaf</strong></li>
</ul>
<h1 id="Representable_functor">Representable functor</h1><p>若函子 $F: \ C \to Set$ <a href="https://ncatlab.org/nlab/show/natural+isomorphism" target="_blank" rel="external">自然同构</a>于 $Hom(A, -)$，其中 $A \in C$，则 $F$ 就是一个Representable functor。</p>
<p>相似地，若函子 $F: \ C^{OP} \to Set$ 自然同构于 $Hom(-, A)$，其中 $A \in C$，则 $F$ 就是一个Corepresentable functor。</p>
<blockquote>
<p>注：Forgetful functors to $Set$ are very often representable.</p>
</blockquote>
<h1 id="Adjoint_functor">Adjoint functor</h1><p>若有两个函子 $F: \ D \to C$ 以及 $G : \ C \to D$ 满足以下自然同构关系：</p>
<p>$$Hom_{C}(F(-), -) \cong Hom_{D}(-, G(-))$$</p>
<p>即对于 $\forall X \in C, Y \in D$，满足：</p>
<p>$$Hom_{C}(F(Y), X) \cong Hom_{D}(Y, G(X))$$</p>
<p>那么这两个函子就是一对伴随函子(<a href="https://ncatlab.org/nlab/show/adjoint+functor" target="_blank" rel="external">adjoint functor</a>)，并称F是G的左伴随函子，记为 $F \dashv G$。</p>
<ul>
<li>常见的一对伴随函子：Forgetful Functor/Free Functor。$Forget : \ C \to Set$，$Free : \ Set \to C$，$Free \dashv Forget$。</li>
</ul>
<h1 id="Natural_Transformation">Natural Transformation</h1><p>再抽象一层，自然变换(Natural Transformation)是Functor之间的映射关系。</p>
<p>假设 $F$ 和 $G$ 是范畴 $C$ 到范畴 $D$ 的函子 $C \to D$，则 $F$ 到 $G$的自然变换 $\tau : F \to G$ 是一个作用于 $C$ 中任意对象 $X$ 的 D-morphism ：$\tau_{X} : F X \to G X$，且满足以下naturality condition(用交换图表示)：</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/natural-transformation-condition.png" alt="Natural Transformation"></p>
<h1 id="Monad">Monad</h1><p>这里先总结一下Monad的范畴论定义。Monad由三元组 $&lt;T, \eta, \mu&gt;$ 构成。其中:</p>
<ul>
<li>$T$ 为范畴 $X$ 上的自函子： $T: X \to X$</li>
<li>$\eta$ 为单位自函子 $id_{X}$ 到函子 $T$ 的自然变换：$\eta: id_{X} \to T$</li>
<li>$\mu$ 为函子 $T$ 的张量积 $T \circ T$ 到函子 $T$ 的自然变换：$\mu: T \circ T \to T$</li>
</ul>
<p>同时它需要满足以下coherence condition：</p>
<ul>
<li>$\mu \circ T \mu = \mu \circ \mu T$ (即自然变换 $T^{3} \to T$)</li>
<li>$\mu \circ T \eta = \mu \circ \eta T = 1_{T}$ (即自然变换 $T \to T$)</li>
</ul>
<p>用交换图表示如下：</p>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/Monad_multiplication_explicit_wiki.png" alt="Monad coherence condition"></p>
<blockquote>
<p>注1：此处函子的张量积 $\otimes$ 可以看作为<strong>组合</strong>(composition)。</p>
<p>注2：注意结合 <strong>Monoidal Category</strong> 理解；注意里面的Monoid与抽象代数中幺半群的区别。</p>
</blockquote>
<h1 id="TODO">TODO</h1><ul>
<li>Monoidal Category/Monoidal Functor</li>
<li>Monad的来源、推导</li>
<li>Kleisli范畴下Monad的定义</li>
<li>Free Monad</li>
<li>Yoneda Lemma</li>
<li>Yoneda Embedding/Profunctor</li>
<li>Day Convolution</li>
<li>Kan Extensions</li>
<li>Universal Construction</li>
</ul>
<hr>
<h1 id="参考资料">参考资料</h1><ul>
<li>Jiri Adamek, Horst Herrlich, George Strecker. <em>Abstract and Concrete Categories: The Joy of Cats.</em></li>
<li>Saunders Mac Lane. <em>Categories for the Working Mathematician.</em></li>
<li><a href="https://en.wikibooks.org/wiki/Haskell/Category_theory" target="_blank" rel="external">Haskell/Category theory - Wikibooks</a></li>
<li><a href="http://stackoverflow.com/questions/3870088/a-monad-is-just-a-monoid-in-the-category-of-endofunctors-whats-the-issue" target="_blank" rel="external">A monad is just a monoid in the category of endofunctors, what’s the issue? - StackOverflow</a></li>
<li><a href="https://ncatlab.org/nlab/show/hom-functor" target="_blank" rel="external">hom-functor - nLab</a></li>
<li><a href="http://www.haskell.org/haskellwiki/Typeclassopedia" target="_blank" rel="external">Typeclassopedia - Haskell Wiki</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Functional-Programming/">Functional Programming</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Category-Theory/">Category Theory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Functional-Programming/">Functional Programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Haskell/">Haskell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Type-Theory/">Type Theory</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-android-event-dispatcher" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Android/android-event-dispatcher/" class="article-date">
      <time datetime="2015-10-25T03:37:00.000Z" itemprop="datePublished">2015-10-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Android/android-event-dispatcher/">Android 事件分发机制总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="事件构成">事件构成</h1><p>在Android中，事件主要包括点按、长按、拖拽、滑动等，点按又包括单击和双击，另外还包括单指操作和多指操作。所有这些都构成了Android中的事件响应。总的来说，所有的事件都由如下三个部分作为基础：</p>
<ul>
<li>按下（ACTION_DOWN）</li>
<li>移动（ACTION_MOVE）</li>
<li>抬起（ACTION_UP）</li>
</ul>
<p>所有的操作事件首先必须执行的是按下操作（ACTION_DOWN）。</p>
<h1 id="Android事件分发机制">Android事件分发机制</h1><p>Android事件分发是先传递到<code>ViewGroup</code>，再由<code>ViewGroup</code>传递到<code>View</code>的。</p>
<h2 id="对于View：">对于View：</h2><p>大体流程：触摸动作发生 =&gt; 调用<code>dispatchTouchEvent</code>方法 =&gt; 首先调用<code>onTouch</code>方法</p>
<p>若同时满足：绑定了<code>OnClickListener</code>、控件可用(<code>enabled</code>)、<code>onTouch</code>方法返回<code>true</code>，则<code>dispatchTouchEvent</code>方法将直接返回<code>true</code>，不会调用<code>onTouchEvent</code>方法。</p>
<p>这是最新的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        <span class="comment">// If the event should be handled by accessibility focus first.</span></div><div class="line">        <span class="keyword">if</span> (event.isTargetAccessibilityFocus()) &#123;</div><div class="line">            <span class="comment">// We don't have focus or no virtual descendant has it, do not handle the event.</span></div><div class="line">            <span class="keyword">if</span> (!isAccessibilityFocusedViewOrHost()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// We have focus and got the event, then use normal event dispatch.</span></div><div class="line">            event.setTargetAccessibilityFocus(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">            mInputEventConsistencyVerifier.onTouchEvent(event, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = event.getActionMasked();</div><div class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">            <span class="comment">// Defensive cleanup for new gesture</span></div><div class="line">            stopNestedScroll();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">            <span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">            ListenerInfo li = mListenerInfo;</div><div class="line">            <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></div><div class="line">                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">                    &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</div><div class="line">                result = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">                result = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!result &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</div><div class="line">            mInputEventConsistencyVerifier.onUnhandledEvent(event, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Clean up after nested scrolls if this is the end of a gesture;</span></div><div class="line">        <span class="comment">// also cancel it if we tried an ACTION_DOWN but we didn't want the rest</span></div><div class="line">        <span class="comment">// of the gesture.</span></div><div class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_UP ||</div><div class="line">                actionMasked == MotionEvent.ACTION_CANCEL ||</div><div class="line">                (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</div><div class="line">            stopNestedScroll();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>否则，将会继续调用<code>onTouchEvent</code>方法。并且可以推断，<code>onClick</code>方法也是在<code>onTouchEvent</code>方法中调用的。</p>
<h2 id="对于ViewGroup">对于ViewGroup</h2><ol>
<li>Android事件分发是先传递到ViewGroup，再由ViewGroup传递到View的。</li>
<li>在ViewGroup中可以通过<code>onInterceptTouchEvent</code>方法对事件传递进行拦截，<code>onInterceptTouchEvent</code>方法返回true代表不允许事件继续向子View传递，返回false代表不对事件进行拦截，默认返回false。</li>
<li>子View中如果将传递的事件消费掉，ViewGroup中将无法接收到任何事件。</li>
</ol>
<h1 id="总结">总结</h1><ol>
<li>Android中事件<strong>按照从上到下的顺序进行层级传递</strong>，事件处理从Activity开始到ViewGroup再到View</li>
<li>事件传递方法包括<code>dispatchTouchEvent</code>、<code>onTouchEvent</code>、<code>onInterceptTouchEvent</code>，其中前两个是<code>View</code>和<code>ViewGroup</code>都有的，最后一个是只有ViewGroup才有的方法。这三个方法的作用分别是负责事件分发、事件处理、事件拦截</li>
<li><code>onTouch</code>事件要先于<code>onClick</code>事件执行，<code>onTouch</code>在事件分发方法<code>dispatchTouchEvent</code>中调用，而<code>onClick</code>在事件处理方法<code>onTouchEvent</code>中被调用，<code>onTouchEvent</code>要后于<code>dispatchTouchEvent</code>方法的调用</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-android-view-draw-notes" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Develop/android-view-draw-notes/" class="article-date">
      <time datetime="2015-10-25T02:21:00.000Z" itemprop="datePublished">2015-10-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Develop/android-view-draw-notes/">Android View 视图绘制总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="LayoutInflater的作用">LayoutInflater的作用</h1><p><code>LayoutInflater</code>用于将xml文件（layout布局文件）解析成View。对最外层的layout来说，<code>layout_height</code>和<code>layout_width</code>都是没有用的。在进行<code>setContentView</code>时，系统会自动在外边加一个<code>FrameLayout</code>。</p>
<h1 id="View的绘制">View的绘制</h1><p>三个主要阶段：<code>onMeasure()</code>、<code>onLayout()</code>和<code>onDraw()</code>。</p>
<ul>
<li><code>onMeasure</code>：测量视图大小</li>
<li><code>onLayout</code>：给视图布局，即确定视图位置</li>
<li><code>onDraw</code>：对图像进行绘制（在Canvas对象上进行）</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Develop/">Develop</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/View/">View</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-android-refactor-mvp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Android/android-refactor-mvp/" class="article-date">
      <time datetime="2015-10-24T15:37:00.000Z" itemprop="datePublished">2015-10-24</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Android/android-refactor-mvp/">Android MVP架构重构实践</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>我们之前的架构就是普通的MVC架构。由于各种layout文件职责单一，因此Activity经常也作为Controller层，这样可能会堆出一个几千行的Activity，看起来就很爽。。因此，这次总结项目时便计划用更好的MVP架构和MVVM架构来重构项目。</p>
<p>为了简便起见，就拿<code>LoginActivity</code>来练手吧，这还属于逻辑比较简单的。。这是原登录逻辑的大概代码（省略了大量逻辑）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bind</span>(R.id.et_username)</div><div class="line">    EditText etUserName;</div><div class="line"></div><div class="line">    <span class="meta">@Bind</span>(R.id.et_password)</div><div class="line">    EditText etPassword;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String mUserName = <span class="string">""</span>;</div><div class="line">    <span class="keyword">private</span> String mPassword = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getLayoutId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> R.layout.activity_login;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (item.getItemId()) &#123;</div><div class="line">            <span class="keyword">case</span> android.R.id.home:</div><div class="line">                onBackPressed();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasBackButton</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getActionBarTitle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> R.string.login;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@OnClick</span>(&#123;R.id.btn_login, R.id.iv_qq_login, R.id.iv_wx_login, R.id.iv_sina_login&#125;)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> id = v.getId();</div><div class="line">        <span class="keyword">switch</span> (id) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.btn_login:</div><div class="line">                handleLogin();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.iv_qq_login:</div><div class="line">                qqLogin();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.iv_wx_login:</div><div class="line">                wxLogin();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.iv_sina_login:</div><div class="line">                sinaLogin();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">okForLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!DeviceUtil.hasInternet()) &#123;</div><div class="line">            ToastUtil.toast(R.string.tip_no_internet);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        ....</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BaseJsonHttpResponseHandler mHandler = <span class="keyword">new</span> BaseJsonHttpResponseHandler() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(<span class="keyword">int</span> statusCode, Header[] headers, String rawJsonResponse, Object response)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span>(response != <span class="keyword">null</span>) &#123;</div><div class="line">                handleLoginResult((LoginResult)response);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Header[] headers, Throwable throwable, String rawJsonData, Object errorResponse)</span> </span>&#123;</div><div class="line">            ToastUtil.toast(<span class="string">"网络出现错误，请重试。("</span> + statusCode + <span class="string">")"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> Object <span class="title">parseResponse</span><span class="params">(String rawJsonData, <span class="keyword">boolean</span> isFailure)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            <span class="keyword">return</span> JsonUtil.resolveLoginResult(rawJsonData);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinish</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.onFinish();</div><div class="line">            hideWaitDialog();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(!okForLogin())</div><div class="line">            <span class="keyword">return</span>;</div><div class="line"></div><div class="line">        mUserName = etUserName.getText().toString();</div><div class="line">        mPassword = etPassword.getText().toString();</div><div class="line"></div><div class="line">        hideKeyboard();</div><div class="line">        showWaitDialog(R.string.progress_login).show();</div><div class="line">        SamsaraAPI.login(mUserName, mPassword, mHandler);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLoginResult</span><span class="params">(LoginResult result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(result.getDataResult().isOK()) &#123;</div><div class="line">            ...</div><div class="line">            AppContext.getContext().saveUserInfo(result.getUser());</div><div class="line">            hideWaitDialog();</div><div class="line">            handleLoginSuccess();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            AppContext.getContext().cleanLoginInfo();</div><div class="line">            ToastUtil.showToast(<span class="string">"错误："</span> + result.getDataResult().getErrorMsg());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLoginSuccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        ToastUtil.toast(<span class="string">"登录成功"</span>);</div><div class="line">        finish();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">qqLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">wxLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sinaLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果登录逻辑很复杂（比如有很多种三方登录逻辑），那么Activity可能会比较臃肿。这时候就要减轻Activity的职责，把代码重构成MVP架构。这个时候Activity作为View层，而把主要业务逻辑放至Presenter层。Presenter层与View层的交互是通过接口实现的。<br><img src="http://img.blog.csdn.net/20151025002219889" alt="重构后的架构"><br>IBaseLoginService接口为普通登录接口，IThirdLoginService接口继承普通登录接口，也扩展作为三方扩展登录接口，登录逻辑的具体实现在LoginServiceImpl类里。<br>我们把登录接口设计成这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBaseLoginService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(String username, String password, LoginResultCallback callback)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IThirdLoginService</span> <span class="keyword">extends</span> <span class="title">IBaseLoginService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">wxLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">qqLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">weiboLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们同时设计了登录的回调接口，用于处理登录成功或失败的逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginResultCallback</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">(LoginResult result)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> error_code)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们在LoginServiceImpl类里实现登录逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title">IThirdLoginService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(<span class="keyword">final</span> String username, <span class="keyword">final</span> String password, <span class="keyword">final</span> LoginResultCallback callback)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> BaseJsonHttpResponseHandler mHandler = <span class="keyword">new</span> BaseJsonHttpResponseHandler() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(<span class="keyword">int</span> statusCode, Header[] headers, String rawJsonResponse, Object response)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span>(response != <span class="keyword">null</span>) &#123;</div><div class="line">                    callback.onLoginSuccess((LoginResult)response);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> statusCode, Header[] headers, Throwable throwable, String rawJsonData, Object errorResponse)</span> </span>&#123;</div><div class="line">                callback.onFailure(statusCode);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> Object <span class="title">parseResponse</span><span class="params">(String rawJsonData, <span class="keyword">boolean</span> isFailure)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="keyword">return</span> JsonUtil.resolveLoginResult(rawJsonData);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                SamsaraAPI.login(username, password, mHandler);</div><div class="line">            &#125;</div><div class="line">        &#125;.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//<span class="doctag">TODO:</span>此处省略第三方登录逻辑</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wxLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span> </span>&#123;</div><div class="line">        LogUtil.toast(<span class="string">"微信API 接口未开放"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qqLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span> </span>&#123;</div><div class="line">        LogUtil.toast(<span class="string">"QQ API 接口未开放"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">weiboLogin</span><span class="params">(String username, String password, LoginResultCallback callback)</span> </span>&#123;</div><div class="line">        LogUtil.toast(<span class="string">"微博API 接口未开放"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，这里对网络的处理用了AsyncHttpClient库，以后也可以替换成Volley；SamsaraAPI是为此App设计的API类。到这里，如果后边三个三方实现比较臃肿的话，整个登录业务逻辑类就显得比较臃肿了，我思考了一下，再把三方逻辑的实现单列一个类，需要的时候继承？不过用继承也不是很好的方法，可以考虑用组合或者装饰模式来实现（此处留待想到更好的设计模式）。</p>
<p><strong>Addition</strong>：如果在登录之前需要对登录数据及环境进行处理，且处理逻辑比较多的话，我们可以借助AOP的思想，利用代理模式，将这些通用逻辑（横切面）与特定业务逻辑（纵面）分开，更好地解除耦合。如日志、数据校验之类的逻辑都属于通用逻辑；当然另一种方法就是封装成各种Util类，我这里采用了后一种方法。</p>
<p><img src="http://pic001.cnblogs.com/images/2012/1/2012040113391482.jpg" alt="MVC与MVP架构（图片来源于网络）"></p>
<p>接下来就是View层接口了。前边提到过，<strong>Presenter与View是通过接口进行交互的</strong>，因此这个View接口如何设计也至关重要。我这里考虑的是，对于我们的一个业务逻辑：</p>
<ul>
<li>此逻辑需要获取什么数据？</li>
<li>此逻辑进行时需要有什么表现？（比如进度条对话框）</li>
<li>逻辑执行的结果以及对UI的反馈？</li>
</ul>
<p>比如，对于登录逻辑，我们需要从UI中获取用户名和密码；登录请求发出后需要等待服务器响应，这段时间应该会显示等待对话框；登录响应后，返回登录成功或失败的信息，对应更新UI和数据，因此我设计成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBasicLoginView</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleLoginSuccess</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showWaiting</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hideWaiting</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">okForLogin</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后就是Presenter的设计了，Presenter与LoginService和LoginView使用组合模式：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginPresenter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> IThirdLoginService loginService;</div><div class="line">    <span class="keyword">private</span> IBasicLoginView loginView;</div><div class="line">    <span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginPresenter</span><span class="params">(IBasicLoginView loginView)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.loginView = loginView;</div><div class="line">        <span class="keyword">this</span>.loginService = <span class="keyword">new</span> LoginServiceImpl();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(!loginView.okForLogin())</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        loginView.showWaiting();</div><div class="line">        loginService.login(loginView.getUsername(), loginView.getPassword(),</div><div class="line">                <span class="keyword">new</span> LoginResultCallback() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoginSuccess</span><span class="params">(<span class="keyword">final</span> LoginResult result)</span> </span>&#123;</div><div class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        handleLoginResult(result);</div><div class="line">                        loginView.hideWaiting();</div><div class="line">                        loginView.handleLoginSuccess();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(<span class="keyword">int</span> error_code)</span> </span>&#123;</div><div class="line">                ToastUtil.toast(<span class="string">"网络出现错误，请重试。("</span> + error_code + <span class="string">")"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLoginResult</span><span class="params">(LoginResult result)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">qqLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        loginService.qqLogin(<span class="string">""</span>, <span class="string">""</span>, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wxLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        loginService.wxLogin(<span class="string">""</span>, <span class="string">""</span>, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sinaLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        loginService.weiboLogin(<span class="string">""</span>, <span class="string">""</span>, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后实现Activity：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> <span class="keyword">implements</span> <span class="title">IBasicLoginView</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bind</span>(R.id.et_username)</div><div class="line">    EditText etUserName;</div><div class="line">    <span class="meta">@Bind</span>(R.id.et_password)</div><div class="line">    EditText etPassword;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> LoginPresenter presenter = <span class="keyword">new</span> LoginPresenter(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getLayoutId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> R.layout.activity_login;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (item.getItemId()) &#123;</div><div class="line">            <span class="keyword">case</span> android.R.id.home:</div><div class="line">                onBackPressed();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onOptionsItemSelected(item);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasBackButton</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getActionBarTitle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> R.string.login;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@OnClick</span>(&#123;R.id.btn_login, R.id.iv_qq_login, R.id.iv_wx_login, R.id.iv_sina_login&#125;)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> id = v.getId();</div><div class="line">        <span class="keyword">switch</span> (id) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.btn_login:</div><div class="line">                presenter.login();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.iv_qq_login:</div><div class="line">                presenter.qqLogin();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.iv_wx_login:</div><div class="line">                presenter.wxLogin();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.iv_sina_login:</div><div class="line">                presenter.sinaLogin();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">okForLogin</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!DeviceUtil.hasInternet()) &#123;</div><div class="line">            ToastUtil.toast(R.string.tip_no_internet);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> etUserName.getText().toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> etPassword.getText().toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showWaiting</span><span class="params">()</span> </span>&#123;</div><div class="line">        hideKeyboard();</div><div class="line">        showWaitDialog(R.string.progress_login).show();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideWaiting</span><span class="params">()</span> </span>&#123;</div><div class="line">        hideWaitDialog();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoginSuccess</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        ToastUtil.toast(<span class="string">"登录成功"</span>);</div><div class="line">        finish();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于这只是练手，原Activity逻辑也不算也别复杂（五百行左右），因此对架构进行重构后并没有看出开发上有什么便捷之处，但以后可能会有更为复杂的逻辑，若不进行适当的重构，Activity可能会超过1000行，特别臃肿，不利于扩展和调BUG。因此，使用MVP/MVVM架构，在一个大项目中是必不可少的。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-cpp-stl-hashmap" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/C-C/cpp-stl-hashmap/" class="article-date">
      <time datetime="2015-10-23T16:00:00.000Z" itemprop="datePublished">2015-10-24</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/C-C/cpp-stl-hashmap/">C++ STL之哈希表 | unordered_map</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>C++ STL中，哈希表对应的容器是<code>unordered_map</code>（since C++ 11）。<br>根据C++ 11标准的推荐，用<code>unordered_map</code>代替<code>hash_map</code>。</p>
<h1 id="Prolouge">Prolouge</h1><p>先来回顾一下数据结构中哈希表相关的知识。<br>哈希表是根据关键码值(Key value)而直接进行访问的数据结构。也就是说，它通过把关键码值映射到表中一个位置来访问记录，以加快查找的速度，这个映射函数叫做散列函数。<br>哈希表的一个重要问题就是如何解决映射冲突的问题。常用的有两种：<strong>开放地址法</strong> 和 <strong>链地址法</strong>。</p>
<h1 id="与map的区别">与map的区别</h1><p>STL中，map对应的数据结构是<strong>红黑树</strong>。红黑树是一种近似于平衡的二叉查找树，里面的数据是有序的。在红黑树上做查找操作的时间复杂度为 <strong>O(logN)</strong>。而unordered_map对应 <strong>哈希表</strong>，哈希表的特点就是查找效率高，时间复杂度为常数级别 <strong>O(1)</strong>， 而额外空间复杂度则要高出许多。所以对于需要高效率查询的情况，使用unordered_map容器。而如果对内存大小比较敏感或者数据存储要求有序的话，则可以用map容器。</p>
<h1 id="基本使用">基本使用</h1><p>unordered_map的用法和map大同小异，一个简单示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; <span class="built_in">map</span>;</div><div class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">1</span>, <span class="string">"Scala"</span>));</div><div class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">2</span>, <span class="string">"Haskell"</span>));</div><div class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">3</span>, <span class="string">"C++"</span>));</div><div class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">6</span>, <span class="string">"Java"</span>));</div><div class="line">    <span class="built_in">map</span>.insert(<span class="built_in">std</span>::make_pair(<span class="number">14</span>, <span class="string">"Erlang"</span>));</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt;::iterator it;</div><div class="line">    <span class="keyword">if</span> ((it = <span class="built_in">map</span>.find(<span class="number">6</span>)) != <span class="built_in">map</span>.end()) &#123;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; it-&gt;second &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="使用自定义类">使用自定义类</h1><p>要使用哈希表，必须要有对应的计算散列值的算法以及判断两个值（或对象）是否相等的方法。<br>在Java中，Object类里有两个重要方法：<code>hashCode</code>和<code>equals</code>方法。其中<code>hashCode</code>方法便是为散列存储结构服务的，用来计算散列值；而<code>equals</code>方法则是用来判断两对象是否等价。由于所有的类都继承自<code>java.lang.Object</code>类，因此所有类相当于都拥有了这两个方法。</p>
<p>而在C++中没有自动声明这类函数，STL只为C++常用类提供了散列函数，因此如果想在<code>unordered_map</code>中使用自定义的类，则必须为此类提供一个哈希函数和一个判断对象是否相等的函数（e.g. 重载==运算符）。下面是一个简单示例（扒自数据结构上机作业的部分代码）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">using std::string;</div><div class="line">using std::cin;</div><div class="line">using std::cout;</div><div class="line">using std::endl;</div><div class="line">using std::unordered_map;</div><div class="line"></div><div class="line">class Person &#123;</div><div class="line">//private:</div><div class="line">//    string phone;</div><div class="line">//    string name;</div><div class="line">public:</div><div class="line">    string phone;</div><div class="line">    string name;</div><div class="line">    string address;</div><div class="line"></div><div class="line">    explicit Person() &#123;&#125;</div><div class="line">    explicit Person(string name, string phone, string address): name(name), phone(phone), address(address) &#123;&#125;</div><div class="line"></div><div class="line">    // overload operator==</div><div class="line">    bool operator==(const Person&amp; p) &#123;</div><div class="line">        return this-&gt;phone == p.phone &amp;&amp; this-&gt;name == p.name</div><div class="line">            &amp;&amp; this-&gt;address == p.address;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    inline friend std::ostream&amp; operator&lt;&lt;(std::ostream&amp; os, Person&amp; p) &#123;</div><div class="line">        os &lt;&lt; "[Person] -&gt; (" &lt;&lt; p.name &lt;&lt; ", " &lt;&lt; p.phone &lt;&lt; ", "</div><div class="line">           &lt;&lt; p.address &lt;&lt; ")";</div><div class="line">        return os;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">// declare hash&lt;Person&gt;</div><div class="line">namespace std &#123;</div><div class="line"> template &lt;&gt;</div><div class="line"> struct hash&lt;Person&gt; &#123;</div><div class="line">     std::size_t operator()(const Person&amp; p) const &#123;</div><div class="line">      using std::size_t;</div><div class="line">      using std::hash;</div><div class="line">      using std::string;</div><div class="line">      // Compute individual hash values for first,</div><div class="line">      // second and third and combine them using XOR</div><div class="line">      // and bit shifting:</div><div class="line">      return ((hash&lt;string&gt;()(p.phone)</div><div class="line">        ^ (hash&lt;string&gt;()(p.name) &lt;&lt; 1)) &gt;&gt; 1)</div><div class="line">        ^ (hash&lt;string&gt;()(p.address) &lt;&lt; 1);</div><div class="line">     &#125;</div><div class="line"> &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">unordered_map&lt;string, Person&gt; phoneMap;</div><div class="line"></div><div class="line">void selectByPhone() &#123;</div><div class="line">    string phone;</div><div class="line">    cout &lt;&lt; "Input the phone number: "; cin &gt;&gt; phone;</div><div class="line">    unordered_map&lt;string, Person&gt;::iterator it;</div><div class="line">    int size = phoneMap.size();</div><div class="line">    for(int pc = 0; pc &lt; size; pc++) &#123;</div><div class="line">        if((it = phoneMap.find(phone)) != phoneMap.end()) &#123;</div><div class="line">            cout &lt;&lt; "\033[32mQuery result: " &lt;&lt; it-&gt;second &lt;&lt; "\033[0m" &lt;&lt; endl;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    cout &lt;&lt; "\033[33mQuery result : target_not_found\033[0m" &lt;&lt; endl;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于哈希值如何计算，前面我写过一篇文章专门介绍这个：<a href="http://www.sczyh30.com/posts/Java/java-hashcode-equal">hashCode方法及equals方法的规范</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/C-C/">C/C++</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HashMap/">HashMap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/STL/">STL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Summary/">Summary</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-android-performance-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Android/android-performance-1/" class="article-date">
      <time datetime="2015-10-23T10:36:00.000Z" itemprop="datePublished">2015-10-23</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Android/android-performance-1/">Android应用性能优化总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>在移动端内存非常宝贵，我们要尽可能地去优化内存以达到最佳性能，并努力地去避免OOM问题。这篇文章总结一些最常见的Android性能优化的一些事项~</p>
<hr>
<h1 id="图片加载">图片加载</h1><p>在移动端，图片的加载往往是最消耗内存的，OOM也经常会发生在加载图片时。以下是加载图片的几个注意事项：</p>
<ul>
<li>按需要的大小加载。缩略图加载成原图的精细度并不会提升视觉上的效果，但会额外占用不少内存。</li>
<li>图片的缓存使用<code>LruCache</code>，并且合理地设置缓存大小</li>
<li>可以用一些高效的图片加载库，比如Facebook的Fresco</li>
</ul>
<h1 id="注意一些额外的内存消耗">注意一些额外的内存消耗</h1><ul>
<li>应特别注意HashMap这个数据结构，必要的时候可以用<code>SparseArray</code>等等的数据结构代替以节省内存</li>
<li>需要频繁修改字符串的地方考虑用<code>StringBuilder</code>代替<code>String</code></li>
<li>避免创建无用的实例</li>
</ul>
<h1 id="有限度地使用Service">有限度地使用Service</h1><p>当我们启动一个<code>Service</code>时，系统会倾向于将这个Service所依赖的进程进行保留，这样就会导致这个进程变得非常消耗内存。并且，系统可以在LRU cache当中缓存的进程数量也会减少，导致切换应用程序的时候耗费更多性能。严重的话，甚至有可能会导致崩溃，因为系统在内存非常吃紧的时候可能已无法维护所有正在运行的Service所依赖的进程了。</p>
<p>因此，控制好Service的生命周期是很重要的。切忌一个无用的Service跑在后台，这会非常影响性能。如果一个逻辑只需要进行一次，那么可以用<code>IntentService</code>代替。</p>
<h1 id="Handler必须为静态内部类">Handler必须为静态内部类</h1><p>首先复习一下Java几种内部类的语言规范，Java中的<strong>inner class</strong>（内部类）定义在一个类的内部，它有一个<strong>指向外部类的引用</strong>。这就有可能导致一个问题，其外部类的生命周期已经结束，而由于inner class持有外部类的引用，并且inner class与其它对象还有引用关联，因此GC进行可达性分析时发现内部类与外部类仍有引用关系，因此不会cause GC，从而导致内存泄露。<br>而<strong>static nested class</strong>（静态内部类）虽定义在类的内部，但是它<strong>不持有外部类的引用</strong>，只能访问外部类的静态实例和方法。</p>
<p>在安卓开发中，一个典型的例子是<code>Handler</code>的使用，它会有这样的问题：</p>
<blockquote>
<p>In Android, Handler classes should be static or leaks might occur. Messages enqueued on the application thread’s MessageQueue also retain their target Handler. If the Handler is an inner class, its outer class will be retained as well. To avoid leaking the outer class, declare the Handler as a static nested class with a WeakReference to its outer class.</p>
</blockquote>
<p>这句话的主旨就是，<code>Handler</code>类必须声明为静态（内部）类（static nested class），否则可能会发生内存泄露。因为，进入<code>MessageQueue</code>的<code>Message</code>会持有它们目标<code>Handler</code>的引用；这就可能出现一种情况，一个消息还在排队，而此时目标<code>Handler</code>类所对应的外部类的生命周期已到<code>onDestroy</code>，即将被GC，但由于目标<code>Handler</code>类仍持有其外部类的引用，使得外部类不能被回收，从而导致内存泄露。这一点说明了<strong>Handler类型的对象，生命周期是未知的</strong>。</p>
<p>然而如果声明为static，又会有许多不方便的地方，比如很多逻辑需要访问外部类的非静态变量和非静态方法。此时，我们应该使用外部类的<strong>弱引用</strong>（WeakReference），举例表示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;DeviceUserFragment&gt; mFragment;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHandler</span><span class="params">(DeviceUserFragment fragment)</span> </span>&#123;</div><div class="line">            mFragment = <span class="keyword">new</span> WeakReference&lt;&gt;(fragment);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">            Object object = msg.obj;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> HWServiceConfig.GET_DEVICE_USER_INFO:</div><div class="line">                    mFragment.get().mInfo = (DataUserInfo)object;</div><div class="line">                    mFragment.get().isInfoOK = <span class="keyword">true</span>;</div><div class="line">                    mFragment.get().updateUI();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里顺便复习一下JVM中的四种引用的知识吧（直接扒的以前自己的文章）：</p>
<ul>
<li><strong>StrongReference</strong>（强引用）是最普通的引用类型，只要强引用存在，GC就不会进行垃圾回收。</li>
<li><strong>SoftReference</strong>（软引用）用来描述一些有用但是非必需的对象。如果一个对象只具有软引用，则内存空间足够，垃圾回收器就不会回收它；<strong>如果内存空间不足了，就会回收这些对象的内存</strong>。只要垃圾回收器没有回收它，该对象就可以被程序使用。软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，JVM就会把这个软引用加入到与之关联的引用队列中。软引用可用来实现内存敏感的高速缓存。</li>
<li><strong>WeakReference</strong>（弱引用）是一种生命周期比软引用更短的引用。当GC扫描启动时，只要扫描到只具有弱引用的对象，<strong>无论内存是否够用都会执行GC</strong>；但由于GC线程优先级很低，因此并不一定能迅速发现这些弱引用对象。弱引用也可以和一个引用队列联合使用。</li>
<li><strong>PhantomReference</strong>（虚引用）不同于其余三种引用，虚引用不会影响对象的生命周期，也无法通过虚引用获得对象的一个实例；如果一个对象仅持有虚引用，那么它就和没有任何引用一样，在任何时候都可能被垃圾回收器回收。虚引用主要用来跟踪对象被垃圾回收器回收的活动，它必须和引用队列联合使用。</li>
</ul>
<p>明白了弱引用的生命周期，此处想必就很好理解了。构造一个外部类的弱引用，然后通过<code>get</code>方法获得其实例进行操作即可，既避免了内存泄露，又可以自由地调用外部类的方法。</p>
<p><strong>WeakReference</strong> 和 <strong>SoftReference</strong> 在其他很多地方也都有运用，以后再补充~</p>
<hr>
<h1 id="参考资料">参考资料</h1><ul>
<li><a href="http://blog.csdn.net/guolin_blog/article/details/42238627" target="_blank" rel="external">Android最佳性能实践 - 郭霖的专栏</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/性能优化/">性能优化</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-android-aysnc-message" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Android/android-aysnc-message/" class="article-date">
      <time datetime="2015-10-22T07:35:00.000Z" itemprop="datePublished">2015-10-22</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Android/android-aysnc-message/">Android异步消息处理机制总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>本次项目完成，对安卓的异步消息处理机制有了更深的了解，在这里总结一下。</p>
<h1 id="Prolouge">Prolouge</h1><p>先来回顾一下基础，Android中的异步消息处理主要由<code>Message</code>, <code>Handler</code>, <code>MessageQueue</code>和<code>Looper</code>四部分组成。</p>
<h2 id="Message">Message</h2><p><code>Message</code>主要作为线程之间传递的信息，它可以携带一些数据。它的<code>what</code>字段（一般用来表示消息类型）、<code>arg0</code>、<code>arg1</code>字段可以携带一些整型数据，<code>obj</code>字段可以携带一个对象，并且可以用<code>setData</code>方法传输一个<code>Bundle</code>对象。</p>
<p><code>Message</code>的创建方法有两种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Message msg0 = <span class="keyword">new</span> Message(); <span class="comment">//调用Message的构造方法</span></div><div class="line">Message msg1 = Message.obtain(); <span class="comment">//从消息池中获取</span></div><div class="line">Message message = mHandler.obtainMessage(); <span class="comment">//或者这样从消息池中获取</span></div></pre></td></tr></table></figure>
<p>其中，<code>Handler</code>的<code>obtainMessage</code>方法也是调用了<code>obtain</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Returns a new &#123;<span class="doctag">@link</span> android.os.Message Message&#125; from the global message pool. More efficient than</div><div class="line">     * creating and allocating new instances. The retrieved message has its handler set to this instance (Message.target == this).</div><div class="line">     *  If you don't want that facility, just call Message.obtain() instead.</div><div class="line">     */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Message <span class="title">obtainMessage</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Message.obtain(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这两种方法的本质区别是，<code>obtain</code>方法直接从消息池中获取<code>Message</code>对象，这样很多时候可以避免创建新对象，减少内存开销，从<code>obtain</code>方法的源码中就能看出这一点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Return a new Message instance from the global pool. Allows us to</div><div class="line">     * avoid allocating new objects in many cases.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">obtain</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">            <span class="keyword">if</span> (sPool != <span class="keyword">null</span>) &#123;</div><div class="line">                Message m = sPool;</div><div class="line">                sPool = m.next;</div><div class="line">                m.next = <span class="keyword">null</span>;</div><div class="line">                m.flags = <span class="number">0</span>; <span class="comment">// clear in-use flag</span></div><div class="line">                sPoolSize--;</div><div class="line">                <span class="keyword">return</span> m;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Message();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>因此，获取<code>Message</code>时尽量使用<code>obtain</code>方法。</p>
<h2 id="Handler">Handler</h2><p><code>Handler</code>用于发送和处理信息，相当于生产者和消费者。<code>Handler</code>通过<code>sendMessage</code>方法将Message传入<code>MessageQueue</code>消息队列，经<code>Looper</code>轮询后将<code>Message</code>传递至<code>handleMessage</code>方法中。</p>
<p>最常见的一个应用就是需要在子线程中处理UI，这时候就需要借助<code>Handler</code>实现。</p>
<h2 id="MessageQueue">MessageQueue</h2><p><code>MessageQueue</code>，顾名思义就是消息队列，它用来存放<code>Handler</code>发送的消息，直到消息被处理。每个线程中只能有一个消息队列。</p>
<h2 id="Looper">Looper</h2><p><code>Looper</code>相当于<code>MessageQueue</code>的监视器。首先调用<code>Looper.loop()</code>方法进入无限循环状态，每当一个新的<code>Message</code>进入<code>MessageQueue</code>，<code>Looper</code>就会轮询，将此<code>Message</code>传递给<code>handleMessage</code>方法。每个线程中只能有一个<code>Looper</code>对象。</p>
<h1 id="底层实现">底层实现</h1><p>一个标准的异步处理流程应该是这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">      <span class="keyword">public</span> Handler mHandler;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">          Looper.prepare();</div><div class="line"></div><div class="line">          mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">                  <span class="comment">// process incoming messages here</span></div><div class="line">              &#125;</div><div class="line">          &#125;;</div><div class="line"></div><div class="line">          Looper.loop();</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>我们从<code>Handler</code>的构造函数开始分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) &#123;</div><div class="line">        <span class="keyword">final</span> Class&lt;? extends Handler&gt; klass = getClass();</div><div class="line">        <span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</div><div class="line">                (klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) &#123;</div><div class="line">            Log.w(TAG, <span class="string">"The following Handler class should be static or leaks might occur: "</span> +</div><div class="line">                klass.getCanonicalName());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mLooper = Looper.myLooper();</div><div class="line">    <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="string">"Can't create handler inside thread that has not called Looper.prepare()"</span>);</div><div class="line">    &#125;</div><div class="line">    mQueue = mLooper.mQueue;</div><div class="line">    mCallback = callback;</div><div class="line">    mAsynchronous = async;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们直接在子线程中创建<code>Handler</code>，会抛出异常，提示 “Can’t create handler inside thread that has not called Looper.prepare()”，也就是要调用<code>Looper.prepare()</code>方法。根据源码，这是因为子线程的Looper为空所致，而观察<code>prepare</code>方法的源码可知，此方法的作用就是创建一个<code>Looper</code>对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">    prepare(<span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">    &#125;</div><div class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而主线程也没有调用<code>Looper.prepare()</code>，为什么没有崩溃呢？显然是系统自动地帮我们调用了这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SamplingProfilerIntegration.start();</div><div class="line"></div><div class="line">        <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></div><div class="line">        <span class="comment">// disable it here, but selectively enable it later (via</span></div><div class="line">        <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></div><div class="line">        CloseGuard.setEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        Environment.initForCurrentUser();</div><div class="line"></div><div class="line">        <span class="comment">// Set the reporter for event logging in libcore</span></div><div class="line">        EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</div><div class="line"></div><div class="line">        Security.addProvider(<span class="keyword">new</span> AndroidKeyStoreProvider());</div><div class="line"></div><div class="line">        <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></div><div class="line">        <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</div><div class="line">        TrustedCertificateStore.setDefaultUserDirectory(configDir);</div><div class="line"></div><div class="line">        Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</div><div class="line"></div><div class="line">        Looper.prepareMainLooper();</div><div class="line"></div><div class="line">        ActivityThread thread = <span class="keyword">new</span> ActivityThread();</div><div class="line">        thread.attach(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</div><div class="line">            sMainThreadHandler = thread.getHandler();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">            Looper.myLooper().setMessageLogging(<span class="keyword">new</span></div><div class="line">                    LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Looper.loop();</div><div class="line"></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其中的<code>Looper.prepareMainLooper()</code>方法最后调用了<code>Looper.prepare()</code>方法，创建了主线程的Looper。而子线程则不会主动创建Looper，必须自己调用方法创建。</p>
<p>创建完了Handler，下一步就是创建Message然后<code>sendMessage</code>了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sendMessageDelayed(msg, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessageDelayed</span><span class="params">(Message msg, <span class="keyword">long</span> delayMillis)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (delayMillis &lt; <span class="number">0</span>) &#123;</div><div class="line">            delayMillis = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">        MessageQueue queue = mQueue;</div><div class="line">        <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">            RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">            Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>sendMessage</code>的结果是将此Message入队。注意到MessageQueue中只保存了当前待处理的一个对象，而不是一个集合；出队则是由<code>Looper.loop()</code>进行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">        <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line"></div><div class="line">        <span class="comment">// Make sure the identity of this thread is that of the local process,</span></div><div class="line">        <span class="comment">// and keep track of what that identity token actually is.</span></div><div class="line">        Binder.clearCallingIdentity();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">            <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// No message indicates that the message queue is quitting.</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></div><div class="line">            Printer logging = me.mLogging;</div><div class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">                logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</div><div class="line">                        msg.callback + <span class="string">": "</span> + msg.what);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            msg.target.dispatchMessage(msg);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">                logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Make sure that during the course of dispatching the</span></div><div class="line">            <span class="comment">// identity of the thread wasn't corrupted.</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</div><div class="line">            <span class="keyword">if</span> (ident != newIdent) &#123;</div><div class="line">                Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></div><div class="line">                        + Long.toHexString(ident) + <span class="string">" to 0x"</span></div><div class="line">                        + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></div><div class="line">                        + msg.target.getClass().getName() + <span class="string">" "</span></div><div class="line">                        + msg.callback + <span class="string">" what="</span> + msg.what);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            msg.recycleUnchecked();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>出队的逻辑为<code>queue.next()</code>，其逻辑为：如果MessageQueue的待处理消息对象不为空，那么就出队并让下一个消息入队，否则阻塞。消息出队后经由<code>dispatchMessage</code>方法回调，以便在<code>handleMessage</code>中接收到Message并进行处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</div><div class="line">            handleCallback(msg);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            handleMessage(msg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这就是一个完整的异步消息处理机制，用网上的一幅图总结：</p>
<p><img src="http://img.blog.csdn.net/20151023143204457" alt="消息处理机制（图片来自网络）"></p>
<h1 id="AsyncTask">AsyncTask</h1><p>当然从Android 1.5开始，谷歌就引入了一个更方便使用的<code>AsyncTask</code>类用于处理异步任务，非常轻量级，通过实现其回调函数来实现相应逻辑。比如我写了一个异步读取缓存的Task：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">String</span>, <span class="title">Void</span>, <span class="title">User</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;Context&gt; mContext;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">CacheTask</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">            mContext = <span class="keyword">new</span> WeakReference&lt;&gt;(context);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> User <span class="title">doInBackground</span><span class="params">(String... params)</span> </span>&#123;</div><div class="line">            Serializable object = XmlCacheManager.readObject(mContext.get(), <span class="string">"user"</span>);</div><div class="line">            <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> (User) object;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(User info)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.onPostExecute(info);</div><div class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                mContext.get().mInfo = info;</div><div class="line">                mContext.get().mErrorLayout.setType(AppConstant.HIDE_ERROR_LAYOUT);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mContext.get().mErrorLayout.setType(AppConstant.NETWORK_ERROR_LAYOUT);</div><div class="line">            &#125;</div><div class="line">            mContext.get().updateUI();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在此逻辑中，<code>doInBackground</code>方法用于执行具体的缓存读取，而<code>onPostExecute</code>方法用于通知UI更新任务的结果（即更新UI）。其实AsyncTask底层也是利用上边的异步消息机制实现的，只不过它封装地非常好，免去了开发者自己写Message和Handler的环节，减少编码量。</p>
<p>粗略看了一下AsyncTask的源码，发现其的底层实现用了各种JUC的东西，以后有时间再研究研究它的源码。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发/">开发</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-struct_sizeof" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/posts/Summary/struct_sizeof/" class="article-date">
      <time datetime="2015-09-25T16:00:00.000Z" itemprop="datePublished">2015-09-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/posts/Summary/struct_sizeof/">C/C++结构体字节对齐</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>最近在群里看到不少人在讨论结构体字节对齐的问题，就顺便看了看，总结一下。</p>
<p>在C中，计算一个结构体的大小不是简单地将其各成员所占空间的大小相加，而是有特定的规则 - <strong>字节对齐</strong>。使用字节对齐的原因有两个，第一是某些平台只能在特定地址访问特定的数据，二是提高数据存取的速度（尽量减少存取次数）。C99标准并没有明确规定内存字节对齐的细节，具体细则应由编译器决定。</p>
<p>这里首先引入<strong>对齐参数</strong>这一概念，这是结构体字节对齐的一个参考量，对于每种变量的对齐参数，不同编译器实现不同，这里参考网上列出GCC和MSVC两种编译器对应的对齐参数（均为32位）：</p>
<table>
<thead>
<tr>
<th>编译器</th>
<th>对应量</th>
<th>char</th>
<th>bool(cpp)</th>
<th>short</th>
<th>int</th>
<th>float</th>
<th>double</th>
<th>指针</th>
</tr>
</thead>
<tbody>
<tr>
<td>VC++2015</td>
<td>所占空间</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>4</td>
</tr>
<tr>
<td>VC++2015</td>
<td>对齐参数</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>4</td>
</tr>
<tr>
<td>gcc 4.8.2(linux)</td>
<td>所占空间</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>4</td>
</tr>
<tr>
<td>gcc 4.8.2(linux)</td>
<td>对齐参数</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>4</td>
<td>4</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>编译器还可以设置默认对齐参数，用预编译语句<code>#pragma pack(n)</code>表示，在Windows（32位）下n可取1,2,4,8，默认为8；在Linux（32位）下可取1,2,4，默认为4。</p>
<p>最后，每个变量实际的对齐参数为每个成员变量的对齐参数和编译器的默认对齐参数中较小的一个，比如一个float型变量的对齐参数为4，编译器设定的<code>#pragma pack(8)</code>，则此变量实际的对齐参数就为4；对于结构体变量，它的自身对齐参数就为它里面各个变量最终对齐参数的最大值。</p>
<p>结构体字节对齐的原则主要有两点：</p>
<ol>
<li><strong>结构体的每一个成员相对结构体首地址的偏移量应该是对其参数的整数倍，如果不满足则补足前面的字节使其满足</strong></li>
<li><strong>结构体的最终大小应该是其对应参数的整数倍</strong></li>
</ol>
<p>下面用例子来说明(C++)：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node1 &#123;</div><div class="line">&#125; S1;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node2 &#123;  </div><div class="line">    <span class="keyword">int</span> a;</div><div class="line">    <span class="keyword">char</span> b;</div><div class="line">    <span class="keyword">short</span> c;</div><div class="line">&#125; S2;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node3 &#123;</div><div class="line">    <span class="keyword">char</span> a;</div><div class="line">    <span class="keyword">int</span> b;</div><div class="line">    <span class="keyword">short</span> c;</div><div class="line">&#125; S3;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node4 &#123;</div><div class="line">    <span class="keyword">int</span> a;</div><div class="line">    <span class="keyword">short</span> b;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> c; <span class="comment">//静态变量单独存放在静态数据区</span></div><div class="line">&#125; S4;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node5 &#123;</div><div class="line">    <span class="keyword">bool</span> a;</div><div class="line">    S1 b;</div><div class="line">    <span class="keyword">short</span> c;</div><div class="line">&#125; S5;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node6 &#123;</div><div class="line">    <span class="keyword">bool</span> a;</div><div class="line">    S2 b;</div><div class="line">    <span class="keyword">int</span> c;</div><div class="line">&#125; S6;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node7 &#123;</div><div class="line">    <span class="keyword">bool</span> a;</div><div class="line">    S2 b;</div><div class="line">    <span class="keyword">double</span> d;</div><div class="line">    <span class="keyword">int</span> c;</div><div class="line">&#125; S7;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node8 &#123;</div><div class="line">    <span class="keyword">bool</span> a;</div><div class="line">    S2 b;</div><div class="line">    <span class="keyword">char</span>* c;</div><div class="line">&#125; S8;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>node1</code>为一个空结构体，在C中空结构体的大小为0字节，在C++中空结构体的大小为1字节。</li>
<li><code>node2</code>的内存结构：（4 — 1 — 1（补） — 2），总大小为8字节。</li>
<li><code>node3</code>的内存结构：（1 — 3（补） — 4 — 4），总大小为12字节。</li>
<li><code>node4</code>的内存结构：（4 — 2 — 2（补）），总大小为8字节，注意静态变量被分配到静态数据区，不在sizeof计算的范围内。</li>
<li><code>node5</code>的内存结构：（1 — 1 — 2），总大小为4字节。</li>
<li><code>node6</code>的内存结构：（1 — 3（补） — 8 — 4），总大小为16字节，注意结构体变量的对齐参数的计算。</li>
<li><code>node7</code>的内存结构：（1 — 3（补）— 8  — 4（补） — 8 — 4 — 4（补）），总大小为32字节。</li>
<li><code>node8</code>的内存结构：（1 — 3（补） — 8 — 4），总大小为16字节。</li>
</ul>
<p>详细分析一下<code>node7</code>，其余的也类似：</p>
<ul>
<li><code>#pragma pack(n)</code>为8</li>
<li>对于<code>a</code>变量，其对齐参数为1，此时offset=0，可以被1整除，因此为其分配1字节空间；</li>
<li>对于<code>b</code>变量，其对齐参数为4（s2结构体的成员变量最大对齐参数为int =&gt; 4），此时offset=1，不能被4整除，因此填充3字节后为其分配8字节空间；</li>
<li>对于<code>d</code>变量，其对齐参数为8，此时offset=12，不能被8整除，因此填充4字节后为其分配8字节空间。</li>
<li>对于<code>c</code>变量，其对齐参数为4，此时offset=24，可以被4整除，因此为其分配4字节空间。</li>
<li>此时所有变量都分配完，但此时offset=28，不能被最大对齐参数8整除，因此填充4字节使其可以被8整除。所以最后node7的大小为32字节。</li>
</ul>
<p><img src="http://7xkkgd.com1.z0.glb.clouddn.com/struct-sizeof-bq.png" alt="node7 内存分配"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Summary/">Summary</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C++</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2015 - 2017 sczyh30's blog
            </div>
            <div class="footer-right">
                <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1255963745'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1255963745%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));
                </script>
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank">Yelee</a> by MOxFIVE. Enhanced by sczyh30 <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 7;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>